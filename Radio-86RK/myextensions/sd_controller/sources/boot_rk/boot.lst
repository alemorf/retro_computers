0001   0000             ; SD BIOS for Computer "Radio 86RK" / "Apogee BK01"
0002   0000             ; (c) 09-10-2014 vinxru (aleksey.f.morozov@gmail.com)
0003   0000             
0004   0000                  .org 0h
0005   0000             
0006   0000             MONITOR         = 0F86Ch    ; Адрес собрата в Монитор
0007   0000             USER_PORT       = 0A000H    ; Адрес КР580ВВ55
0008   0000             SEND_MODE       = 10000000b ; Режим передачи (1 0 0 A СH 0 B CL)
0009   0000             RECV_MODE       = 10010000b ; Режим приема (1 0 0 A СH 0 B CL)
0010   0000             
0011   0000             ; Коды передаваемые микроконтроллером
0012   0000             
0013   0000             ERR_START       = 040h ; МК переключен в режим приема команд
0014   0000             ERR_WAIT        = 041h ; МК выполняет команду
0015   0000             ERR_OK_DISK     = 042h ; Накопитель исправен, микроконтроллер готов к приему команды
0016   0000             ERR_OK          = 043h ; Команда выполнена
0017   0000             ERR_OK_READ     = 044h ; МК готов передать следующий блок данных
0018   0000             ERR_OK_ADDR     = 047h ; МК готов передать адрес загрузки
0019   0000             ERR_OK_BLOCK    = 04Fh 
0020   0000             
0021   0000             ;----------------------------------------------------------------------------
0022   0000             ; Точка входа
0023   0000             
0024   0000             Entry:
0025   0000                  ; Первым этапом происходит синхронизация с контроллером
0026   0000                  ; 256 попыток. Для этого в регистр C заносится 0
0027   0000 0E 00            MVI    C, 0
0028   0002             
0029   0002             Boot:
0030   0002                  ; Режим передачи (освобождаем шину) и инициализируем HL
0031   0002 CD 69 00         CALL  RecvMode
0032   0005             
0033   0005 C3 17 00         JMP   Boot2
0034   0008             
0035   0008             ;----------------------------------------------------------------------------
0036   0008             ; Отправка и прием байта (в HL должен находится USER_PORT)
0037   0008             
0038   0008             Rst1:
0039   0008                  ; Шина адреса используется как тактовый сигнал
0040   0008 23               INX   H
0041   0009 36 20            MVI   M, 20h
0042   000B 36 00            MVI   M, 0
0043   000D 2B               DCX   H
0044   000E                  ; Прием байта
0045   000E 7E               MOV   A, M
0046   000F C9               RET
0047   0010             
0048   0010             ;----------------------------------------------------------------------------
0049   0010             ; Ожидание готовности МК
0050   0010             
0051   0010             Rst2:
0052   0010             WaitForReady:
0053   0010 CF               Rst   1
0054   0011 FE 41            CPI   ERR_WAIT
0055   0013 CA 10 00         JZ    WaitForReady
0056   0016 C9               RET
0057   0017             
0058   0017             ;----------------------------------------------------------------------------
0059   0017             
0060   0017                  ; Начало любой команды (это шина адреса)
0061   0017             Boot2:
0062   0017 2C               INR   L
0063   0018 36 00            MVI   M, 0
0064   001A 36 44            MVI   M, 44h
0065   001C 36 40            MVI   M, 40h
0066   001E 36 00            MVI   M, 0h
0067   0020 2D               DCR   L
0068   0021             
0069   0021                  ; Если есть синхронизация, то контроллер ответит ERR_START по шине данных
0070   0021 CF               Rst   1
0071   0022 FE 40            CPI   ERR_START
0072   0024 C2 5F 00         JNZ   RetrySync
0073   0027             
0074   0027                  ; Инициализация флешки
0075   0027 D7               Rst   2
0076   0028 FE 42            CPI   ERR_OK_DISK
0077   002A C2 5F 00         JNZ   RetrySync
0078   002D             
0079   002D                  ; Режим передачи     
0080   002D CF               Rst   1     
0081   002E 3E 80            MVI   A, SEND_MODE
0082   0030 CD 6B 00         CALL  SetMode
0083   0033             
0084   0033                  ; Код команды BOOT
0085   0033 36 00            MVI   M, 0
0086   0035 CF               Rst   1
0087   0036             
0088   0036                  ; Режим приема
0089   0036 CD 69 00         CALL  RecvMode
0090   0039             
0091   0039                  ; Это ответ команды BOOT
0092   0039 D7               Rst   2
0093   003A FE 47            CPI   ERR_OK_ADDR
0094   003C C2 5F 00         JNZ   RetrySync
0095   003F                  
0096   003F                  ; Адрес загрузки в BC
0097   003F CF               Rst   1
0098   0040 4F               MOV   C, A
0099   0041 CF               Rst   1
0100   0042 47               MOV   B, A
0101   0043             
0102   0043                  ; Сохраняем в стек адрес запуска
0103   0043 C5               PUSH   B
0104   0044             
0105   0044                  ; Файл может быть разбит на несколько частей
0106   0044             RecvLoop:
0107   0044                  ; Все части загружены, можно запускать файл.
0108   0044 D7               Rst   2
0109   0045 FE 44            CPI   ERR_OK_READ
0110   0047 CA 08 00         JZ    Rst1
0111   004A             
0112   004A                  ; Если МК прочитал блок без ошибок, будет передан ERR_OK_BLOCK
0113   004A FE 4F            CPI   ERR_OK_BLOCK
0114   004C C2 63 00         JNZ   PrintError
0115   004F             
0116   004F                  ; Размер блока данных
0117   004F CF               Rst   1
0118   0050 5F               MOV   E, A
0119   0051 CF               Rst   1
0120   0052 57               MOV   D, A
0121   0053             
0122   0053                  ; Принимаем блок данных
0123   0053             RecvBlock:
0124   0053 7B               MOV   A, E
0125   0054 B2               ORA   D
0126   0055 CA 44 00         JZ    RecvLoop
0127   0058 CF               Rst   1
0128   0059 02               STAX  B
0129   005A 03               INX   B
0130   005B 1B               DCX   D
0131   005C C3 53 00         JMP   RecvBlock
0132   005F             
0133   005F             ;----------------------------------------------------------------------------
0134   005F             ; Повторные попыки
0135   005F             
0136   005F             RetrySync:
0137   005F                  ; Попытки
0138   005F 0D               DCR   C
0139   0060 C2 02 00         JNZ   Boot
0140   0063             
0141   0063             ;----------------------------------------------------------------------------
0142   0063             ; Вывод кода ошибки
0143   0063             
0144   0063             PrintError:
0145   0063 CD 15 F8         CALL  0F815h
0146   0066 C3 6C F8         JMP   MONITOR
0147   0069             
0148   0069             ;----------------------------------------------------------------------------
0149   0069             ; Установка режима приема или передачи
0150   0069             
0151   0069             RecvMode:
0152   0069 3E 90            MVI   A, RECV_MODE
0153   006B             
0154   006B             SetMode:
0155   006B 21 03 A0         LXI   H, USER_PORT+3
0156   006E 77               MOV   M, A
0157   006F 2E 00            MVI   L, 0
0158   0071 C9               RET
0159   0072             
0160   0072             .End
0161   0072             
tasm: Number of errors = 0
