0001   0000             ;+---------------------------------------------------------------------------
0002   0000             ; MXOS
0003   0000             ;
0004   0000             ; 2013-12-12 „Ё§ ббҐ¬Ў«Ёа®ў ­® vinxru
0005   0000             ;----------------------------------------------------------------------------
0006   0000             
0007   0000             ; Љ ав  Ї ¬пвЁ:
0008   0000             ;   8FDF-8FFF - ЏҐаҐ¬Ґ­­лҐ
0009   0000             ;   9000-BFFF - ќЄа ­
0010   0000             ;   C000-CFFF - DOS.SYS (ў Є®­жҐ згвм згвм бў®Ў®¤­®Ј® ¬Ґбв  Ї®¤ ¤®а Ў®вЄЁ)
0011   0000             ;   D000-E1FF - NC.COM (ў Є®­жҐ ¬Ґв® Ї®¤ бЇЁб®Є д ©«®ў Ё згвм згвм бў®Ў®¤­®Ј® ¬Ґбв  Ї®¤ ¤®а Ў®вЄЁ)
0012   0000             ;   E200-E7FF - (бў®Ў®¤­® 1536 Ў ©в)
0013   0000             ;   E900-F0FF - аЁдв (¬®¦­® ®вЄ«озЁвм § ЇгбЄ®¬ ROMFNT.COM Ё«Ё ®ЇжЁҐ© LOAD_FONT=0)
0014   0000             ;   F100-F837 - Њ®­Ёв®а 2
0015   0000             ;   FA00-FAFF - „а ©ўҐа ў­Ґи­ҐЈ® Џ‡“
0016   0000             ;   FB00-FDFF - „ЁбЄ®ўл© ЎгдҐа
0017   0000             ;   FF00-FF81 - Љ®¬¬ ­¤­ п бва®Є . ‡ Ї®«­пҐвбп дг­ЄжЁҐ© fileExec
0018   0000             ;   FF82-FFC0 - ‘вҐЄ
0019   0000             ;   FFC0-FFEF - Љгб®зҐЄ ¤а ©ўҐа 
0020   0000             ;   FFD0-FFFF - ЋЎ®аг¤®ў ­ЁҐ
0021   0000             
0022   0000             fat		= 0FB00h
0023   0000             diskDirectory	= 0FC00h
0024   0000             diskDirectoryL	= 0FE00h
0025   0000             v_cmdLine	= 0FF00h
0026   0000             STACK_ADDR	= 0FFC0h
0027   0000             
0028   0000             INIT_COLOR	= 070h
0029   0000             
0030   0000             IO_KEYB_A	= 0FFE0h
0031   0000             IO_KEYB_B	= 0FFE1h
0032   0000             IO_KEYB_C	= 0FFE2h
0033   0000             IO_KEYB_MODE	= 0FFE3h
0034   0000             IO_PROG		= 0FFE4h
0035   0000             IO_TIMER	= 0FFECh
0036   0000             IO_COLOR	= 0FFF8h
0037   0000             IO_RAM		= 0FFFCh
0038   0000             IO_ARAM		= 0FFFDh
0039   0000             IO_ROM		= 0FFFEh
0040   0000             IO_PAGE_STD	= 0FFFFh
0041   0000             
0042   0000             BIG_MEM		= 1		; ‚Є«озЁвм Ї®¤¤Ґа¦Єг „Ћ‡“ Ў®«миҐЈ® зҐ¬ 64 ЉЎ
0043   0000             ROM_64K		= 1		; ‚Є«озЁвм Ї®¤¤Ґа¦Єг Џ‡“ 64 ЉЎ ‘ЇҐжЁ «Ёбв  Њ•2
0044   0000             DISABLE_COLOR_BUG = 1		; ‚Є«озЁвм Ї®¤¤Ґа¦Єг жўҐв 
0045   0000             LOAD_FONT	= 1		; ‡ Јаг¦ вм иаЁдв ў Ћ‡“
0046   0000             START_FROM_RAM	= 1             ; ‡ ЇгбЄ б ў­Ґи­ҐЈ® ­®бЁвҐ«п. ‚­Ґи­Ё© § Јаг§зЁЄ § Ї®«­пҐв
0047   0000             				; ЇҐаўлҐ 32 ЉЎ Ї ¬пвЁ ®Ўа §®¬ ¤ЁбЄ . ‘ЁбвҐ¬  § ЇгбЄ Ґвбп Ё§ Ћ‡“, 
0048   0000             				; в Є ¦Ґ Є Є Ё§ Џ‡“. ‚ Є зҐбвўҐ ­ Є®ЇЁвҐ«п A: Ўг¤Ґв ўлбвгЇ вм 
0049   0000             				; бв ­¤ ав­ п ®ЇҐа вЁў­®© Ї ¬пвм. ЏаЁ § ЇгбЄҐ
0050   0000             				; Ўг¤Ґв ўл§лў вмбп CONFIG.BAT, Є®в®ал© Ўг¤Ґв гбв ­ «Ёў вм
0051   0000             				; ¤а ©ўҐа ў­Ґи­ҐЈ® ­®бЁвҐ«п ў Є зҐбвўҐ ­ Є®ЇЁвҐ«п A:
0052   0000             FONT_ADDR	= 0E900h	; Ђ¤аҐб иадЁв 
0053   0000             
0054   8FDF             .org 08FDFh
0055   8FDF             
0056   8FDF             vars:		.block 2
0057   8FE1             v_tapeError:	.block 2	; Ђ¤аҐб Єг¤  Їа®Ёбе®¤Ёв ЇҐаҐе®¤ ЇаЁ ®иЁЎЄҐ звҐ­Ёп б «Ґ­вл
0058   8FE3             v_tapeAddr:	.block 2	; Ђ¤аҐб Їа®Ја ¬¬л § Јаг¦Ґ­­®© б «Ґ­вл
0059   8FE5             		.block 2
0060   8FE7             v_charGen:	.block 2	; Ђ¤аҐб  «мвҐа­ вЁў­®Ј® §­ Є®ЈҐ­Ґа в®а  /8
0061   8FE9             v_cursorCfg:	.block 1	; ‚­Ґи­Ё© ўЁ¤ Єгаб®а  (7 - ЎЁв ўЁ¤Ё¬®бвм, 654 - Ї®«®¦Ґ­ЁҐ, 3210 - ўлб®в )
0062   8FEA             v_koi8:		.block 1	; 0FFh=ўЄ«озҐ­ KOI-8, 0=ўЄ«озҐ­ KOI-7
0063   8FEB             v_escMode:	.block 1	; ЋЎа Ў®вЄ  ESC-Ї®б«Ґ¤®ў вҐ«м­®бвЁ
0064   8FEC             v_keyLocks:	.block 1
0065   8FED             		.block 2
0066   8FEF             unk_8FEF:	.block 1
0067   8FF0             v_lastKey:	.block 1
0068   8FF1             v_beep:		.block 2	; „«ЁвҐ«м­®бвм Ё з бв®в  §ўгЄ®ў®Ј® бЁЈ­ « 
0069   8FF3             v_tapeInverse:	.block 1
0070   8FF4             v_cursorDelay:	.block 1
0071   8FF5             byte_8FF5:	.block 1
0072   8FF6             v_oldSP:	.block 2	; €бЇ®«м§гҐвбп ¤«п б®еа ­Ґ­Ёп SP ­ҐЄ®в®ал¬Ё дг­ЄжЁп¬Ё
0073   8FF8             		.block 2
0074   8FFA             v_inverse:	.block 2	; 0=­®а¬ «м­л© вҐЄбв, 0FFFFh=Ё­ўҐаб­л© вҐЄбв
0075   8FFC             v_cursorY:	.block 1	; Џ®«®¦Ґ­ЁҐ Єгаб®а  Ї® ўҐавЁЄ «Ё ў ЇЁЄбҐ«пе
0076   8FFD             v_cursorX:	.block 1	; Џ®«®¦Ґ­ЁҐ Єгаб®а  Ї® Ј®аЁ§®­в «Ё ў ЇЁЄбҐ«пе / 2
0077   8FFE             v_writeDelay:	.block 1	; ‘Є®а®бвм ЇаЁ § ЇЁбЁ ­  «Ґ­вг
0078   8FFF             v_readDelay:	.block 1	; ‘Є®а®бвм ЇаЁ звҐ­ЁЁ б «Ґ­вл
0079   9000             
0080   C000             .org 0C000h
0081   C000             
0082   C000             .include "jmps_c000.inc"
0001+  C000 C3 09 C0    		jmp	reboot		; Теплая перезагрузка
0002+  C003 C3 C7 C1    j_keyScan:	jmp	keyScan2	; Получить код нажатой клавиши
0003+  C006 C3 4E C3    		jmp	drawCursor3	; Нарисовать/стереть курсор
0083   C009             .include "reboot0.inc"
0001+  C009             ;+---------------------------------------------------------------------------
0002+  C009             ; MXOS
0003+  C009             ; Перезагрузка
0004+  C009             ;
0005+  C009             ; 2013-12-12 Дизассемблировано vinxru
0006+  C009             ;----------------------------------------------------------------------------
0007+  C009             
0008+  C009 31 C0 FF    reboot:		lxi	sp, STACK_ADDR
0009+  C00C C3 5B C4    		jmp	reboot10084   C00F 00          .db 0
0085   C010             .include "clearScreen.inc"
0001+  C010             ;+---------------------------------------------------------------------------
0002+  C010             ; MXOS
0003+  C010             ; Очистить экран
0004+  C010             ;
0005+  C010             ; На выходе
0006+  C010             ;  bc, de, hl - сохраняются
0007+  C010             ;
0008+  C010             ; 2013-12-12 Дизассемблировано vinxru
0009+  C010             ;----------------------------------------------------------------------------
0010+  C010             
0011+  C010             clearScreen:	; bc, hl - сохраняем. de - не используется
0012+  C010 E5          		push	h
0013+  C011 C5          		push	b
0014+  C012             
0015+  C012             		; Сохранение SP
0016+  C012 21 00 00    		lxi	h, 0
0017+  C015 39          		dad	sp
0018+  C016 22 F6 8F    		shld	v_oldSP
0019+  C019             
0020+  C019             		; Устанавливаем SP в конец видеопамяти
0021+  C019 31 00 C0    		lxi	sp, 0C000h
0022+  C01C             
0023+  C01C             		; Байт (слово) для заполнения памяти
0024+  C01C 2A FA 8F    		lhld	v_inverse
0025+  C01F             
0026+  C01F             		; Помещаем в стек 3000h байт
0027+  C01F 01 00 03    		lxi	b, 3000h / 16
0028+  C022 E5          clearScreen_0:	  push	h
0029+  C023 E5          		  push	h
0030+  C024 E5          		  push	h
0031+  C025 E5          		  push	h
0032+  C026 E5          		  push	h
0033+  C027 E5          		  push	h
0034+  C028 E5          		  push	h
0035+  C029 E5          		  push	h
0036+  C02A 0B          		  dcx	b
0037+  C02B 78          		  mov	a, b
0038+  C02C B1          		  ora	c
0039+  C02D C2 22 C0    		jnz	clearScreen_0
0040+  C030             
0041+  C030             		; Восстанавливаем SP
0042+  C030 2A F6 8F    		lhld	v_oldSP
0043+  C033 F9          		sphl
0044+  C034             
0045+  C034             		; bc, hl были сохранены. de - не используется
0046+  C034 C1          		pop	b
0047+  C035 E1          		pop	h
0048+  C036 C9          		ret		0086   C037             .include "printChar.inc"
0001+  C037             ;+---------------------------------------------------------------------------
0002+  C037             ; MXOS
0003+  C037             ; Вывод символа на экран (или принтер)
0004+  C037             ;
0005+  C037             ; На входе
0006+  C037             ;  с - символ
0007+  C037             ;
0008+  C037             ; На выходе
0009+  C037             ;  Все регистры сохраняются
0010+  C037             ;
0011+  C037             ; 2013-12-12 Дизассемблировано vinxru
0012+  C037             ;----------------------------------------------------------------------------
0013+  C037             
0014+  C037 F5          printChar:	push	psw
0015+  C038 D5          		push	d
0016+  C039 C5          		push	b
0017+  C03A E5          		push	h
0018+  C03B CD B8 C5    		call	printChar2
0019+  C03E E1          		pop	h
0020+  C03F C1          		pop	b
0021+  C040 D1          		pop	d
0022+  C041 F1          		pop	psw
0023+  C042 C9          		ret
0087   C043 2A FC       .db 2Ah, 0FCh
0088   C045             .include "printChar5.inc" ; Џа®¤®«¦ Ґвбп ў drawChar
0001+  C045             ;+---------------------------------------------------------------------------
0002+  C045             ; MXOS
0003+  C045             ; Обработка служебных кодов при выводе символа (продолжение)
0004+  C045             ; Расчет адреса символа в знакогенераторе и адреса вывода на экран
0005+  C045             ;
0006+  C045             ; 2013-12-12 Дизассемблировано vinxru
0007+  C045             ;----------------------------------------------------------------------------
0008+  C045             
0009+  C045             ; ---------------------------------------------------------------------------
0010+  C045             ; Обработка ESC+(. Выключение KOI-7
0011+  C045             
0012+  C045 3E FF       printChar_e28:	mvi	a, 0FFh
0013+  C047 32 EA 8F    		sta	v_koi8
0014+  C04A C9          		ret
0015+  C04B             
0016+  C04B             ; ---------------------------------------------------------------------------
0017+  C04B             ; Обработка ESC+). Включение KOI-7
0018+  C04B             
0019+  C04B AF          printChar_e29:	xra	a
0020+  C04C 32 EA 8F    		sta	v_koi8
0021+  C04F C9          		ret
0022+  C050             
0023+  C050             ; ---------------------------------------------------------------------------
0024+  C050             ; Обработка кода 9. Табуляция
0025+  C050             
0026+  C050 3A FD 8F    printChar_c9:	lda	v_cursorX	
0027+  C053 C6 18       		adi	24
0028+  C055 32 FD 8F    		sta	v_cursorX
0029+  C058 C9          		ret
0030+  C059             
0031+  C059             ; ---------------------------------------------------------------------------
0032+  C059             ; Вывод символа С из знакогенартора по адресу HL*8 на экран в положение 
0033+  C059             ; курсора. Курсор при этом перемещается 
0034+  C059             
0035+  C059             printChar_alt:	; de = (hl+c)*8
0036+  C059 06 00       		mvi	b, 0
0037+  C05B 09          		dad	b
0038+  C05C 29          		dad	h
0039+  C05D 29          		dad	h
0040+  C05E 29          		dad	h
0041+  C05F EB          		xchg
0042+  C060             
0043+  C060             		; Продолжение в printChar_de
0044+  C060             
0045+  C060             ; ---------------------------------------------------------------------------
0046+  C060             ; Вывод символа DE на экран в положение курсора. Курсор при этом перемещается 
0047+  C060             ; вправо.
0048+  C060             
0049+  C060             printChar_de:	; Рассчитываем адрес вывода (hl=v_cursorPos, a*256+l=адрес)
0050+  C060 CD 29 C3    		call	calcCursorAddr
0051+  C063             
0052+  C063             		; Перемещаем курсор вправо
0053+  C063 24          		inr	h
0054+  C064 24          		inr	h
0055+  C065 24          		inr	h		
0056+  C066 22 FC 8F    		shld	v_cursorY
0057+  C069             
0058+  C069             		; Корректируем адрес вывода (bc = al - 7)
0059+  C069 47          		mov	b, a
0060+  C06A 7D          		mov	a, l
0061+  C06B D6 07       		sui	7
0062+  C06D 4F          		mov	c, a
0063+  C06E             
0064+  C06E             		; Продолжение в drawChar0089   C06E             .include "drawChar.inc"
0001+  C06E             ;+---------------------------------------------------------------------------
0002+  C06E             ; MXOS
0003+  C06E             ; Рисование символа на экране
0004+  C06E             ;
0005+  C06E             ; На входе 
0006+  C06E             ;  bc - адрес символа
0007+  C06E             ;  de - адрес в видеопамяти
0008+  C06E             ;  h  - координата X в пикселях / 2
0009+  C06E             ;
0010+  C06E             ; 2013-12-12 Дизассемблировано vinxru
0011+  C06E             ;----------------------------------------------------------------------------
0012+  C06E             
0013+  C06E             		; Высота символа
0014+  C06E 2E 08       		mvi	l, 8
0015+  C070             
0016+  C070             		; Переходим в одной из функций вывода
0017+  C070 7C          		mov	a, h
0018+  C071 E6 03       		ani	3
0019+  C073 CA B5 C0    		jz	drawChar0	; a==0
0020+  C076 3D          		dcr	a
0021+  C077 CA C5 C0    		jz	drawChar1	; a==1
0022+  C07A 3D          		dcr	a
0023+  C07B CA 82 C0    		jz	drawChar2	; a==2
0024+  C07E 3D          		dcr	a
0025+  C07F CA A3 C0    		jz	drawChar3	; a==3
0026+  C082             		; Продолжение на drawChar2
0027+  C082             
0028+  C082             ; ---------------------------------------------------------------------------
0029+  C082             
0030+  C082 0A          drawChar2:	ldax	b		
0031+  C083 E6 FC       		ani	0FCh
0032+  C085 67          		mov	h, a
0033+  C086 1A          		ldax	d		
0034+  C087 0F          		rrc
0035+  C088 0F          		rrc
0036+  C089 0F          		rrc
0037+  C08A 0F          		rrc
0038+  C08B 2F          drawChar2_cma:	cma
0039+  C08C F5          		push	psw
0040+  C08D E6 03       		ani	3
0041+  C08F AC          		xra	h
0042+  C090 02          		stax	b
0043+  C091 04          		inr	b
0044+  C092 0A          		ldax	b
0045+  C093 E6 0F       		ani	0Fh
0046+  C095 67          		mov	h, a
0047+  C096 F1          		pop	psw
0048+  C097 E6 F0       		ani	0F0h
0049+  C099 AC          		xra	h
0050+  C09A 02          		stax	b
0051+  C09B 05          		dcr	b
0052+  C09C             
0053+  C09C             		; Цикл
0054+  C09C 03          		inx	b
0055+  C09D 13          		inx	d
0056+  C09E 2D          		dcr	l
0057+  C09F C2 82 C0    		jnz	drawChar2
0058+  C0A2 C9          		ret
0059+  C0A3             
0060+  C0A3             ; ---------------------------------------------------------------------------
0061+  C0A3             
0062+  C0A3 0A          drawChar3:	ldax	b
0063+  C0A4 E6 03       		ani	3
0064+  C0A6 67          		mov	h, a
0065+  C0A7 1A          		ldax	d
0066+  C0A8 07          		rlc
0067+  C0A9 07          		rlc
0068+  C0AA EE FC       drawChar3_xri:	xri	0FCh
0069+  C0AC AC          		xra	h
0070+  C0AD 02          		stax	b
0071+  C0AE             
0072+  C0AE             		; Цикл
0073+  C0AE 13          		inx	d
0074+  C0AF 03          		inx	b
0075+  C0B0 2D          		dcr	l
0076+  C0B1 C2 A3 C0    		jnz	drawChar3
0077+  C0B4 C9          		ret
0078+  C0B5             
0079+  C0B5             ; ---------------------------------------------------------------------------
0080+  C0B5             
0081+  C0B5 0A          drawChar0:	ldax	b
0082+  C0B6 E6 C0       		ani	0C0h
0083+  C0B8 67          		mov	h, a
0084+  C0B9 1A          		ldax	d
0085+  C0BA EE 3F       drawChar0_xri:	xri	3Fh
0086+  C0BC AC          		xra	h
0087+  C0BD 02          		stax	b
0088+  C0BE             
0089+  C0BE             		; Цикл
0090+  C0BE 13          		inx	d
0091+  C0BF 03          		inx	b
0092+  C0C0 2D          		dcr	l
0093+  C0C1 C2 B5 C0    		jnz	drawChar0
0094+  C0C4 C9          		ret
0095+  C0C5             
0096+  C0C5             ; ---------------------------------------------------------------------------
0097+  C0C5             
0098+  C0C5 0A          drawChar1:	ldax	b
0099+  C0C6 E6 F0       		ani	0F0h
0100+  C0C8 67          		mov	h, a
0101+  C0C9 1A          		ldax	d
0102+  C0CA 0F          		rrc
0103+  C0CB 0F          		rrc
0104+  C0CC 2F          drawChar1_cma:	cma
0105+  C0CD E6 0F       		ani	0Fh
0106+  C0CF AC          		xra	h
0107+  C0D0 02          		stax	b
0108+  C0D1 04          		inr	b
0109+  C0D2 0A          		ldax	b
0110+  C0D3 E6 3F       		ani	3Fh
0111+  C0D5 67          		mov	h, a
0112+  C0D6 1A          		ldax	d
0113+  C0D7 0F          		rrc
0114+  C0D8 0F          		rrc
0115+  C0D9 2F          drawChar1_cma2:	cma
0116+  C0DA E6 C0       		ani	0C0h
0117+  C0DC AC          		xra	h
0118+  C0DD 02          		stax	b
0119+  C0DE 05          		dcr	b
0120+  C0DF             
0121+  C0DF             		; Цикл
0122+  C0DF 03          		inx	b
0123+  C0E0 13          		inx	d
0124+  C0E1 2D          		dcr	l
0125+  C0E2 C2 C5 C0    		jnz	drawChar1
0126+  C0E5 C9          		ret
0127+  C0E6             
0128+  C0E6             ; ---------------------------------------------------------------------------
0129+  C0E6             ; Вызывается из printChar_real2
0130+  C0E6             
0131+  C0E6             normalVideo:	; Меняем CZ normalVideo на CNZ inverseVideo
0132+  C0E6 21 02 C1    		lxi	h, inverseVideo
0133+  C0E9 22 F5 C5    		shld	printChar_poly+1
0134+  C0EC 3E C4       		mvi	a, 0C4h
0135+  C0EE 32 F4 C5    		sta	printChar_poly
0136+  C0F1             
0137+  C0F1             		; Аргумент XRI
0138+  C0F1 AF          		xra	a
0139+  C0F2 32 BB C0    		sta	drawChar0_xri+1
0140+  C0F5 32 AB C0    		sta	drawChar3_xri+1
0141+  C0F8             normalVideo_1:	; Меняем CMA на NOP
0142+  C0F8 32 8B C0    		sta	drawChar2_cma		
0143+  C0FB 32 CC C0    		sta	drawChar1_cma
0144+  C0FE 32 D9 C0    		sta	drawChar1_cma2
0145+  C101 C9          		ret
0146+  C102             
0147+  C102             ; ---------------------------------------------------------------------------
0148+  C102             ; Вызывается из printChar_real2
0149+  C102             
0150+  C102             inverseVideo:	; Меняем CNZ inverseVideo на CZ normalVideo
0151+  C102 21 E6 C0    		lxi	h, normalVideo
0152+  C105 22 F5 C5    		shld	printChar_poly+1
0153+  C108 3E CC       		mvi	a, 0CCh		
0154+  C10A 32 F4 C5    		sta	printChar_poly
0155+  C10D             
0156+  C10D             		; Меняем аргумент XRI
0157+  C10D 3E FC       		mvi	a, 0FCh
0158+  C10F 32 AB C0    		sta	drawChar3_xri+1
0159+  C112 3E 3F       		mvi	a, 3Fh
0160+  C114 32 BB C0    		sta	drawChar0_xri+1
0161+  C117             
0162+  C117             		; Меняем NOP на CMA
0163+  C117 3E 2F       		mvi	a, 2Fh
0164+  C119 C3 F8 C0    		jmp	normalVideo_10090   C11C             .include "printChar3.inc"
0001+  C11C             ;+---------------------------------------------------------------------------
0002+  C11C             ; MXOS
0003+  C11C             ; Обработка служебных кодов при выводе символа
0004+  C11C             ;
0005+  C11C             ; На входе
0006+  C11C             ;  a - символ
0007+  C11C             ;
0008+  C11C             ; 2013-12-12 Дизассемблировано vinxru
0009+  C11C             ;----------------------------------------------------------------------------
0010+  C11C             
0011+  C11C             printChar3:	; Код 7
0012+  C11C D6 07       		sui	7
0013+  C11E CA 70 C1    		jz	beep
0014+  C121             		; Код 8
0015+  C121 3D          		dcr	a
0016+  C122 CA 4E C1    		jz	printChar_c08
0017+  C125             		; Код 10
0018+  C125 D6 02       		sui	2
0019+  C127 CA 96 C1    		jz	printChar_c0A
0020+  C12A             		; Код 12
0021+  C12A D6 02       		sui	2
0022+  C12C CA 46 C1    		jz	printChar_c0C
0023+  C12F             		; Код 13
0024+  C12F 3D          		dcr	a
0025+  C130 CA 48 C1    		jz	printChar_c0D
0026+  C133             		; Код 24
0027+  C133 D6 0B       		sui	11
0028+  C135 CA 64 C1    		jz	printChar_c18
0029+  C138             		; Код 25
0030+  C138 3D          		dcr	a
0031+  C139 CA 59 C1    		jz	printChar_c19
0032+  C13C             		; Код 26
0033+  C13C 3D          		dcr	a
0034+  C13D CA 98 C1    		jz	printChar_c1A
0035+  C140             		; Продолжение, если код 31
0036+  C140 D6 05       		sui	5
0037+  C142 C0          		rnz
0038+  C143             		; Код 31 очищает экран
0039+  C143 CD 10 C0    		call	clearScreen
0040+  C146             
0041+  C146             		; Продолжение в printChar_c0C
0042+  C146             
0043+  C146             ; ---------------------------------------------------------------------------
0044+  C146             ; Обработка кода 0Ch. Курсор в левый верхний угол экрана
0045+  C146             
0046+  C146             printChar_c0C:	; v_cursorY = 8
0047+  C146 2E 08       		mvi	l, 8
0048+  C148             
0049+  C148             		; Продолжение в printChar_c0D
0050+  C148             
0051+  C148             ; ---------------------------------------------------------------------------
0052+  C148             ; Обработка кода 0Dh. Курсор в начало строки
0053+  C148             
0054+  C148             printChar_c0D:	; v_cursorX = 0
0055+  C148 AF          		xra	a
0056+  C149 67          saveVCursorHA:	mov	h, a
0057+  C14A 22 FC 8F    saveVCursor:	shld	v_cursorY
0058+  C14D C9          		ret
0059+  C14E             
0060+  C14E             ; ---------------------------------------------------------------------------
0061+  C14E             ; Обработка кода 8h. Влево
0062+  C14E             
0063+  C14E             printChar_c08:	; cursorX -= 3
0064+  C14E 7C          		mov	a, h
0065+  C14F D6 03       		sui	3
0066+  C151             
0067+  C151             		; Если нет переноса, сохранить положение курсора и выйти
0068+  C151 D2 49 C1    		jnc	saveVCursorHA
0069+  C154             
0070+  C154             		; cursorX = 189
0071+  C154 26 BD       		mvi	h, 189
0072+  C156 22 FC 8F    		shld	v_cursorY
0073+  C159             
0074+  C159             		; Продолжение в printChar_c19
0075+  C159             
0076+  C159             ; ---------------------------------------------------------------------------
0077+  C159             ; Обработка кода 19h. Вверх
0078+  C159             
0079+  C159             printChar_c19:	; Если cursorY<18, то выйти. Иначе cursorY -= 10
0080+  C159 7D          		mov	a, l
0081+  C15A D6 0A       		sui	0Ah
0082+  C15C D8          		rc
0083+  C15D FE 08       		cpi	8
0084+  C15F D8          		rc
0085+  C160             
0086+  C160             saveVCursorLA:	; Сохранить положение курсора и выйти
0087+  C160 6F          		mov	l, a
0088+  C161 C3 4A C1    		jmp	saveVCursor
0089+  C164             
0090+  C164             ; ---------------------------------------------------------------------------
0091+  C164             ; Обработка кода 18h. Вправо
0092+  C164             
0093+  C164             printChar_c18:	; Если cursorX+3 >= 192, то перейти на printChar_c0A
0094+  C164             		; Иначе cursorX += 3
0095+  C164 7C          		mov	a, h
0096+  C165 C6 03       		adi	3
0097+  C167 FE C0       		cpi	0C0h
0098+  C169 DA 49 C1    		jc	saveVCursorHA
0099+  C16C C3 96 C1    		jmp	printChar_c0A0091   C16F FF          .db 0FFh
0092   C170             .include "beep.inc"
0001+  C170             ;+---------------------------------------------------------------------------
0002+  C170             ; MXOS
0003+  C170             ; Звуковой сигнал (вызывается при выводе кода 7)
0004+  C170             ;
0005+  C170             ; Все регистры сохраняются
0006+  C170             ;
0007+  C170             ; 2013-12-12 Дизассемблировано vinxru
0008+  C170             ;----------------------------------------------------------------------------
0009+  C170             
0010+  C170             beep:		; Сохраняем все регистры. DE не используется ниже
0011+  C170 F5          		push	psw
0012+  C171 C5          		push	b
0013+  C172 E5          		push	h
0014+  C173             
0015+  C173             		; Частота и длительность сигнала
0016+  C173 2A F1 8F    		lhld	v_beep
0017+  C176             
0018+  C176             beep_0:		; Единицу на динамик
0019+  C176 3E 0B       		mvi	a, 0Bh
0020+  C178 32 E3 FF    		sta	IO_KEYB_MODE
0021+  C17B             
0022+  C17B             		; Задержка L тактов
0023+  C17B CD 8F C1    		call	delay_l
0024+  C17E             
0025+  C17E             		; Ноль на динамик
0026+  C17E 3E 0A       		mvi	a, 0Ah
0027+  C180 32 E3 FF    		sta	IO_KEYB_MODE
0028+  C183             
0029+  C183             		; Задержка L тактов
0030+  C183 CD 8F C1    		call	delay_l
0031+  C186             
0032+  C186             		; Повторяем H раз
0033+  C186 25          		dcr	h
0034+  C187 C2 76 C1    		jnz	beep_0
0035+  C18A             
0036+  C18A             		; Ничего не делаем
0037+  C18A 00          		nop
0038+  C18B             
0039+  C18B             		; Восстаналиваем все регистры и выходим. DE не используется
0040+  C18B E1          		pop	h
0041+  C18C C1          		pop	b
0042+  C18D F1          		pop	psw
0043+  C18E C9          		ret0093   C18F             .include "delay_l.inc"
0001+  C18F             ;+---------------------------------------------------------------------------
0002+  C18F             ; MXOS
0003+  C18F             ; Задержка
0004+  C18F             ;
0005+  C18F             ; На входе
0006+  C18F             ;  l - задержка
0007+  C18F             ;
0008+  C18F             ; На выходе
0009+  C18F             ;  b - 0
0010+  C18F             ;
0011+  C18F             ; 2013-12-12 Дизассемблировано vinxru
0012+  C18F             ;----------------------------------------------------------------------------
0013+  C18F             
0014+  C18F 45          delay_l:	mov	b, l
0015+  C190 05          delay_l_0:	dcr	b
0016+  C191 C2 90 C1    		jnz	delay_l_0
0017+  C194 C9          		ret0094   C195 C9          .db 0C9h
0095   C196             .include "printChar4.inc" ; Џа®¤®«¦ Ґвбп ў scrollUp
0001+  C196             ;+---------------------------------------------------------------------------
0002+  C196             ; MXOS
0003+  C196             ; Обработка служебных кодов при выводе символа (продолжение)
0004+  C196             ;
0005+  C196             ; 2013-12-12 Дизассемблировано vinxru
0006+  C196             ;----------------------------------------------------------------------------
0007+  C196             
0008+  C196             ; ---------------------------------------------------------------------------
0009+  C196             ; Обработка кода 0Ah. Перевод строки
0010+  C196             
0011+  C196             printChar_c0A:	; cursorX = 0
0012+  C196 26 00       		mvi	h, 0
0013+  C198             
0014+  C198             		; Продолжение в printChar_c1A
0015+  C198             
0016+  C198             ; ---------------------------------------------------------------------------
0017+  C198             ; Обработка кода 1Ah. Вниз
0018+  C198             
0019+  C198             printChar_c1A:	; Если cursorY < 246, то cursorY += 10 и выход
0020+  C198 7D          		mov	a, l
0021+  C199 C6 0A       		adi	10
0022+  C19B D2 60 C1    		jnc	saveVCursorLA
0023+  C19E             
0024+  C19E             		; Сохраняем положение курсора (изменен только cursorX)
0025+  C19E 22 FC 8F    		shld	v_cursorY
0026+  C1A1             
0027+  C1A1             		; Далее прокрутка экрана вверх0096   C1A1             .include "scrollUp.inc"
0001+  C1A1             ;+---------------------------------------------------------------------------
0002+  C1A1             ; MXOS
0003+  C1A1             ; Прокрутка экрана вверх
0004+  C1A1             ;
0005+  C1A1             ; На выходе
0006+  C1A1             ;   af, bc - сохраняются
0007+  C1A1             ;
0008+  C1A1             ; 2013-12-12 Дизассемблировано vinxru
0009+  C1A1             ;----------------------------------------------------------------------------
0010+  C1A1             
0011+  C1A1             		; Сохраняем регистры
0012+  C1A1 C5          		push	b
0013+  C1A2 F5          		push	psw
0014+  C1A3             
0015+  C1A3             		; Сохраняем SP
0016+  C1A3 21 00 00    		lxi	h, 0
0017+  C1A6 39          		dad	sp
0018+  C1A7 22 F6 8F    		shld	v_oldSP
0019+  C1AA             
0020+  C1AA             		; Прокрутка экрана вверх
0021+  C1AA 31 0A 90    		lxi	sp, 900Ah	; Откуда
0022+  C1AD 26 90       		mvi	h, 90h		; Куда
0023+  C1AF 06 30       		mvi	b, 48		; Столбцов
0024+  C1B1 C3 6D C7    		jmp	scrollUp20097   C1B4 FF FF FF FF v_char:	.db 0FFh, 0FFh,	0FFh, 0FFh, 0FFh, 0FFh,	0FFh, 0FFh, 0FFh, 0FFh,	0FFh, 0FFh, 0FFh
0097   C1B8 FF FF FF FF 
0097   C1BC FF FF FF FF 
0097   C1C0 FF 
0098   C1C1             .include "keyScan.inc"
0001+  C1C1             ;+---------------------------------------------------------------------------
0002+  C1C1             ; MXOS
0003+  C1C1             ; Получить код нажатой клавиши
0004+  C1C1             ;
0005+  C1C1             ; На выходе
0006+  C1C1             ;  a - код
0007+  C1C1             ;
0008+  C1C1             ; 2013-12-12 Дизассемблировано vinxru
0009+  C1C1             ;----------------------------------------------------------------------------
0010+  C1C1             
0011+  C1C1 3E 83       setKeybMode83:	mvi	a, 83h
0012+  C1C3 32 E3 FF    		sta	IO_KEYB_MODE
0013+  C1C6 C9          		ret
0014+  C1C7             
0015+  C1C7             ; ---------------------------------------------------------------------------
0016+  C1C7             
0017+  C1C7             keyScan2:	; Режим чтения ряда
0018+  C1C7 CD 54 C2    		call	setKeybMode82
0019+  C1CA             
0020+  C1CA             		; Одним чтением првоеряем все клавиши
0021+  C1CA 3A E1 FF    		lda	IO_KEYB_B	
0022+  C1CD             
0023+  C1CD             		; Эти биты не используются в сканировании
0024+  C1CD F6 03       		ori	3
0025+  C1CF             
0026+  C1CF             		; Ни одна клавиша не нажата
0027+  C1CF FE FF       		cpi	0FFh
0028+  C1D1 C8          		rz
0029+  C1D2             
0030+  C1D2             		; Сохраняем регистры
0031+  C1D2 E5          		push	h
0032+  C1D3 C5          		push	b
0033+  C1D4 D5          		push	d
0034+  C1D5             		
0035+  C1D5             		; Перебираем 12 столбцов кнопок
0036+  C1D5 21 FE 0F    		lxi	h, 0FFEh
0037+  C1D8 11 AB C4    		lxi	d, v_keybTbl + 11
0038+  C1DB 06 FF       		mvi	b, 0FFh
0039+  C1DD 7C          loc_C1DD:	mov	a, h
0040+  C1DE 32 E2 FF    		sta	IO_KEYB_C
0041+  C1E1 7D          		mov	a, l
0042+  C1E2 32 E0 FF    		sta	IO_KEYB_A
0043+  C1E5 0F          		rrc
0044+  C1E6 2F          		cma
0045+  C1E7 E6 04       		ani	4
0046+  C1E9 4F          		mov	c, a
0047+  C1EA 3A E1 FF    		lda	IO_KEYB_B
0048+  C1ED B1          		ora	c
0049+  C1EE             
0050+  C1EE             		; Перебираем 6 кнопок в столбце
0051+  C1EE 0E 06       		mvi	c, 6
0052+  C1F0 0F          		rrc
0053+  C1F1 0F          		rrc
0054+  C1F2 0F          loc_C1F2:	rrc
0055+  C1F3 D4 0C C2    		cnc	keybScan3
0056+  C1F6 0D          		dcr	c
0057+  C1F7 C2 F2 C1    		jnz	loc_C1F2
0058+  C1FA             
0059+  C1FA             		; Цикл
0060+  C1FA 1B          		dcx	d
0061+  C1FB 29          		dad	h
0062+  C1FC 23          		inx	h
0063+  C1FD 7C          		mov	a, h
0064+  C1FE C6 F0       		adi	0F0h
0065+  C200 67          		mov	h, a
0066+  C201 DA DD C1    		jc	loc_C1DD
0067+  C204             
0068+  C204             		; Режим ВВ55 по уполчанию
0069+  C204 CD 54 C2    		call	setKeybMode82
0070+  C207             
0071+  C207             		; Результат
0072+  C207 78          		mov	a, b
0073+  C208             
0074+  C208             		; Восстаналвиаем регистры
0075+  C208 D1          		pop	d
0076+  C209 C1          		pop	b
0077+  C20A E1          		pop	h
0078+  C20B C9          		ret
0079+  C20C             
0080+  C20C             ;----------------------------------------------------------------------------
0081+  C20C             
0082+  C20C D5          keybScan3:	push	d
0083+  C20D F5          		push	psw
0084+  C20E 3E 06       		mvi	a, 6		; e += (6 - c) * 16
0085+  C210 91          		sub	c
0086+  C211 87          		add	a
0087+  C212 87          		add	a
0088+  C213 87          		add	a
0089+  C214 87          		add	a
0090+  C215 83          		add	e
0091+  C216 5F          		mov	e, a
0092+  C217 1A          		ldax	d		; b = *de;
0093+  C218 47          		mov	b, a
0094+  C219 F1          		pop	psw
0095+  C21A D1          		pop	d
0096+  C21B C9          		ret0099   C21C             .include "getch2.inc"
0001+  C21C             ;----------------------------------------------------------------------------
0002+  C21C             ; MXOS
0003+  C21C             ; Ожидание ввода с клавиатуры
0004+  C21C             ;
0005+  C21C             ; На выходе
0006+  C21C             ;  ? - код
0007+  C21C             ;
0008+  C21C             ; 2013-12-12 Дизассемблировано vinxru
0009+  C21C             ;----------------------------------------------------------------------------
0010+  C21C             
0011+  C21C             getch2:		; Сохраняем регистры
0012+  C21C E5          		push	h
0013+  C21D C5          		push	b
0014+  C21E D5          		push	d
0015+  C21F             
0016+  C21F             		; Получаем код нажатой клавиши и сохраняем его в v_lastKey
0017+  C21F CD C7 C1    		call	keyScan2
0018+  C222 32 F0 8F    		sta	v_lastKey
0019+  C225             
0020+  C225             getch_retry:	; Тут будет признак, нарисован курсор или нет
0021+  C225 0E 01       		mvi	c, 1
0022+  C227             
0023+  C227             loc_C227:	; Рисуем курсор
0024+  C227 CD 4D C3    		call	drawCursor2
0025+  C22A             
0026+  C22A             		; Задержка
0027+  C22A 3A F4 8F    		lda	v_cursorDelay
0028+  C22D 06 40       loc_C22D:	mvi	b, 40h
0029+  C22F CD 90 C1    		call	delay_l_0
0030+  C232 3D          		dcr	a
0031+  C233 C2 2D C2    		jnz	loc_C22D
0032+  C236             
0033+  C236             loc_C236:	; Рисуем/стираем курсор
0034+  C236 CD 48 C3    		call	drawCursor
0035+  C239             		
0036+  C239             		; Задержка мерцания курсора
0037+  C239 11 00 05    		lxi	d, 500h
0038+  C23C             
0039+  C23C             loc_C23C:	; Получаем код нажатой клавиши
0040+  C23C CD C7 C1    		call	keyScan2
0041+  C23F FE 80       		cpi	80h		; х.з.
0042+  C241 FE FF       		cpi	0FFh
0043+  C243 C2 60 C2    		jnz	getch2_pressed
0044+  C246             
0045+  C246             		; Записываем v_lastKey=0FFh
0046+  C246 32 F0 8F    		sta	v_lastKey
0047+  C249             
0048+  C249             		; Повторяем 500h раз
0049+  C249 1B          		dcx	d
0050+  C24A 7A          		mov	a, d
0051+  C24B B3          		ora	e
0052+  C24C C2 3C C2    		jnz	loc_C23C
0053+  C24F             
0054+  C24F             		; Повтор всего
0055+  C24F C3 36 C2    		jmp	loc_C236
0056+  C252             
0057+  C252             ; ---------------------------------------------------------------------------
0058+  C252             
0059+  C252 FF FF       .db 0FFh, 0FFh
0060+  C254             
0061+  C254             ; ---------------------------------------------------------------------------
0062+  C254             
0063+  C254 3E 82       setKeybMode82:	mvi	a, 82h
0064+  C256 32 E3 FF    		sta	IO_KEYB_MODE
0065+  C259 C9          		ret
0066+  C25A             
0067+  C25A             ; ---------------------------------------------------------------------------
0068+  C25A             
0069+  C25A 3E 91       setKeybMode91:	mvi	a, 91h
0070+  C25C 32 E3 FF    		sta	IO_KEYB_MODE
0071+  C25F C9          		ret
0072+  C260             
0073+  C260             ; ---------------------------------------------------------------------------
0074+  C260             ; Была нажата клавиша
0075+  C260             
0076+  C260             getch2_pressed:	; Сохраняем код
0077+  C260 47          		mov	b, a
0078+  C261             
0079+  C261             		; Если нарисован курсор, стираем его
0080+  C261 79          		mov	a, c
0081+  C262 0F          		rrc
0082+  C263 DA 69 C2    		jc	loc_C269
0083+  C266 CD 4D C3    		call	drawCursor2
0084+  C269             loc_C269:	
0085+  C269 2A EF 8F    		lhld	unk_8FEF	; h = v_lastKey
0086+  C26C 78          		mov	a, b		; a = b = код нажатой клавиши
0087+  C26D BC          		cmp	h
0088+  C26E C2 8D C2    		jnz	loc_C28D	; Код нажатой клавиши изменился
0089+  C271 BD          		cmp	l
0090+  C272 CA 95 C2    		jz	loc_C295
0091+  C275             
0092+  C275             		; Рисуем курсор
0093+  C275 CD 48 C3    		call	drawCursor
0094+  C278             
0095+  C278             		; Ждем, пока отпустят клавишу
0096+  C278 3A F5 8F    		lda	byte_8FF5
0097+  C27B 57          		mov	d, a
0098+  C27C CD C7 C1    loc_C27C:	call	keyScan2
0099+  C27F BC          		cmp	h
0100+  C280 C2 27 C2    		jnz	loc_C227	; Быстро нажали другую клавишу
0101+  C283 15          		dcr	d
0102+  C284 C2 7C C2    		jnz	loc_C27C
0103+  C287             
0104+  C287             		; Долго держали
0105+  C287             
0106+  C287             		; Стираем курсор
0107+  C287 CD 48 C3    		call	drawCursor
0108+  C28A             
0109+  C28A C3 90 C2    		jmp	loc_C290
0110+  C28D             ; ---------------------------------------------------------------------------
0111+  C28D             
0112+  C28D             loc_C28D:	; Звуковой сигнал
0113+  C28D CD 70 C1    		call	beep
0114+  C290             
0115+  C290             loc_C290:	;
0116+  C290 6C          		mov	l, h
0117+  C291 60          		mov	h, b	; код нажатой клавиши сохраняем в v_lastKey
0118+  C292 22 EF 8F    		shld	unk_8FEF
0119+  C295             
0120+  C295             loc_C295:	; Не служеюбные клавиши CAPS LOCK, SHIFT и РУС/LAT не влияют
0121+  C295 78          		mov	a, b
0122+  C296 FE 21       		cpi	21h
0123+  C298 DA 10 C3    		jc	getch_noShift   
0124+  C29B                             ; На клавиши c кодами 21h-3Fh влияет SHIFT
0125+  C29B FE 40       		cpi	40h
0126+  C29D DA FE C2    		jc	getch_shift 
0127+  C2A0                             ; На символьные клавиши (40h-7Eh) влияют CAPS LOCK, SHIFT и РУС/LAT
0128+  C2A0 FE 7F       		cpi	7Fh
0129+  C2A2 DA DE C2    		jc	getch_chars
0130+  C2A5                             ; Не служеюбные клавиши (7Fh+) CAPS LOCK, SHIFT и РУС/LAT не влияют
0131+  C2A5 CA 10 C3    		jz	getch_noShift
0132+  C2A8             
0133+  C2A8             		; ...
0134+  C2A8 00          		nop
0135+  C2A9 00          		nop
0136+  C2AA             
0137+  C2AA                             ; Переходим, если код клавиши не 81h
0138+  C2AA FE 81       		cpi	81h
0139+  C2AC C2 10 C3    		jnz	getch_noShift
0140+  C2AF             
0141+  C2AF                             ; Код клавиши 81h
0142+  C2AF             
0143+  C2AF             		; Если шифт не нажат
0144+  C2AF 3A E1 FF    		lda	IO_KEYB_B
0145+  C2B2 E6 02       		ani	2
0146+  C2B4 C2 5C C5    		jnz	loc_C55C
0147+  C2B7             
0148+  C2B7                             ; Код клавиши 81h с шифтом
0149+  C2B7             
0150+  C2B7             		; Звуковой сигнал
0151+  C2B7 CD 70 C1    		call	beep
0152+  C2BA             
0153+  C2BA             		; CAPS LOCK для KOI-7 или РУС/LAT для KOI-8
0154+  C2BA C3 9B C5    		jmp	getch_rc
0155+  C2BD             
0156+  C2BD             ; ---------------------------------------------------------------------------
0157+  C2BD             ; Нажата комбинация РУС/LAT
0158+  C2BD             
0159+  C2BD             getch_rusLat:	; на входе a = v_keyLocks
0160+  C2BD EE 81       		xri	81h
0161+  C2BF 32 EC 8F    		sta	v_keyLocks
0162+  C2C2             
0163+  C2C2             		; Особый звуковой сигнал
0164+  C2C2 3A F1 8F    		lda	v_beep
0165+  C2C5 F5          		push	psw
0166+  C2C6 3E 4F       		mvi	a, 4Fh
0167+  C2C8 32 F1 8F    		sta	v_beep
0168+  C2CB CD 70 C1    		call	beep
0169+  C2CE 3E 5F       		mvi	a, 5Fh
0170+  C2D0 32 F1 8F    		sta	v_beep
0171+  C2D3 CD 70 C1    		call	beep
0172+  C2D6 F1          		pop	psw
0173+  C2D7 32 F1 8F    		sta	v_beep
0174+  C2DA             
0175+  C2DA             		; ...
0176+  C2DA 00          		nop
0177+  C2DB             
0178+  C2DB C3 25 C2    		jmp	getch_retry
0179+  C2DE             
0180+  C2DE             ; ---------------------------------------------------------------------------
0181+  C2DE             ; Включаем кирилицу или строчные буквы
0182+  C2DE             
0183+  C2DE             getch_chars:	; Если не нажат CAPS LOCK, пропускаем код ниже
0184+  C2DE 3A EC 8F    		lda	v_keyLocks
0185+  C2E1 4F          		mov	c, a
0186+  C2E2 A7          		ana	a
0187+  C2E3 FA EA C2    		jm	loc_C2EA	; CAPS LOCK
0188+  C2E6             
0189+  C2E6             		; Превращаем заглавные в строчные
0190+  C2E6 78          		mov	a, b
0191+  C2E7 EE 20       		xri	20h
0192+  C2E9 47          		mov	b, a
0193+  C2EA             
0194+  C2EA             loc_C2EA:	; Если зафиксирвоан ли РУС/ЛАТ, помещаем в C=1
0195+  C2EA 79          		mov	a, c
0196+  C2EB E6 01       		ani	1
0197+  C2ED 4F          		mov	c, a
0198+  C2EE             
0199+  C2EE             		; Если шифт нажат, помещаем в A=0
0200+  C2EE 3A E1 FF    		lda	IO_KEYB_B
0201+  C2F1 E6 02       		ani	2
0202+  C2F3 0F          		rrc				;! Как на счет флага C ?
0203+  C2F4             
0204+  C2F4             		; Превращаем английские символы в русские если A^C==0
0205+  C2F4 A9          		xra	c
0206+  C2F5 78          		mov	a, b
0207+  C2F6 C2 A8 C5    		jnz	loc_C5A8
0208+  C2F9 C6 80       		adi	80h
0209+  C2FB C3 A8 C5    		jmp	loc_C5A8
0210+  C2FE             
0211+  C2FE             ; ---------------------------------------------------------------------------
0212+  C2FE             ; Меняем цифры на символы
0213+  C2FE             
0214+  C2FE             getch_shift:	; Если не нажат шифт, пропускаем код ниже
0215+  C2FE 3A E1 FF    		lda	IO_KEYB_B
0216+  C301 E6 02       		ani	2
0217+  C303 78          		mov	a, b
0218+  C304 C2 A8 C5    		jnz	loc_C5A8
0219+  C307             
0220+  C307             		; Меняем цифры на символы
0221+  C307 EE 10       		xri	10h
0222+  C309             
0223+  C309             		; Одно исключение 30h должен меняться на 5Fh
0224+  C309 FE 20       		cpi	20h
0225+  C30B C2 10 C3    		jnz	getch_noShift
0226+  C30E 3E 5F       		mvi	a, 5Fh
0227+  C310             
0228+  C310             		; Прододжение getch_noShift
0229+  C310             
0230+  C310             ; ---------------------------------------------------------------------------
0231+  C310             ; Символы без изменений
0232+  C310             
0233+  C310             getch_noShift:  ; Сохраняем код нажатой клавиши в B     
0234+  C310 47          		mov	b, a
0235+  C311             
0236+  C311 CD C1 C1    loc_C311:	call	setKeybMode83
0237+  C314 3E F7       		mvi	a, 0F7h
0238+  C316 32 E0 FF    		sta	IO_KEYB_A
0239+  C319 3A E1 FF    		lda	IO_KEYB_B
0240+  C31C 2F          		cma
0241+  C31D 0F          		rrc
0242+  C31E 0F          		rrc
0243+  C31F 0F          		rrc
0244+  C320 CD 54 C2    		call	setKeybMode82
0245+  C323 00          		nop
0246+  C324             
0247+  C324             		; Восстаналиваем код нажатой клавиши
0248+  C324 78          		mov	a, b
0249+  C325             
0250+  C325             popa_ret_2:	; Восстаналиваем регистры и выходим
0251+  C325 D1          		pop	d
0252+  C326 C1          		pop	b
0253+  C327 E1          		pop	h
0254+  C328 C9          		ret0100   C329             .include "calcCursorAddr.inc"
0001+  C329             ;+---------------------------------------------------------------------------
0002+  C329             ; MXOS
0003+  C329             ; Расчет адреса курсора в видеопамяти. И перевод строки, если курсор был
0004+  C329             ; за правым краем экрана.
0005+  C329             ;
0006+  C329             ; На выходе
0007+  C329             ;  hl - координаты курсора
0008+  C329             ;  a * 256 + l - адрес в видеопамяти
0009+  C329             ;
0010+  C329             ; 2013-12-12 Дизассемблировано vinxru
0011+  C329             ;----------------------------------------------------------------------------
0012+  C329             
0013+  C329             calcCursorAddr:	; В HL положение курсора
0014+  C329 2A FC 8F    		lhld	v_cursorY
0015+  C32C             
0016+  C32C             		; Если cursorX >= 190, то перевод строки (вывод кода 10)
0017+  C32C             		; Иначе рассчитываем адрес старшего байта a = cursorX / 4 + 90h
0018+  C32C 7C          		mov	a, h
0019+  C32D FE BE       		cpi	190
0020+  C32F DA 41 C3    		jc	calcCursorAd_1
0021+  C332 0E 0A       		mvi	c, 10
0022+  C334 C3 3A C3    		jmp	calcCursorAd_0
0101   C337             .include "getch.inc"
0001+  C337             ;----------------------------------------------------------------------------
0002+  C337             ; MXOS
0003+  C337             ; Ожидание ввода с клавиатуры
0004+  C337             ;
0005+  C337             ; На выходе
0006+  C337             ;  ? - код
0007+  C337             ;
0008+  C337             ; 2013-12-12 Дизассемблировано vinxru
0009+  C337             ;----------------------------------------------------------------------------
0010+  C337             
0011+  C337 C3 1C C2    getch:		jmp	getch20102   C33A             .include "calcCursorAddr2.inc"
0001+  C33A             ;+---------------------------------------------------------------------------
0002+  C33A             ; MXOS
0003+  C33A             ; Расчет адреса курсора в видеопамяти (продолжение);
0004+  C33A             ;
0005+  C33A             ; 2013-12-12 Дизассемблировано vinxru
0006+  C33A             ;----------------------------------------------------------------------------
0007+  C33A             
0008+  C33A             calcCursorAd_0:	; Перевод строки (на входе C=10)
0009+  C33A CD 37 C0    		call	printChar
0010+  C33D             
0011+  C33D             		; Восстановление регистров после printChar (хотя он не портит регистры)
0012+  C33D 2A FC 8F    		lhld	v_cursorY
0013+  C340 7C          		mov	a, h
0014+  C341             
0015+  C341             calcCursorAd_1:	; Расчет старшего байта адреса
0016+  C341             		; a = cursorX / 4 + 90h		
0017+  C341 0F          		rrc
0018+  C342 0F          		rrc
0019+  C343 E6 3F       		ani	3Fh
0020+  C345 C6 90       		adi	90h
0021+  C347 C9          		ret
0103   C348             .include "drawCursor.inc"
0001+  C348             ;+---------------------------------------------------------------------------
0002+  C348             ; MXOS
0003+  C348             ; Рисование курсора на экране
0004+  C348             ;
0005+  C348             ; На выходе
0006+  C348             ;  bc,de,hl - сохраняются
0007+  C348             ;
0008+  C348             ; 2013-12-12 Дизассемблировано vinxru
0009+  C348             ;----------------------------------------------------------------------------
0010+  C348             
0011+  C348             drawCursor:	; Если установлен 7-ой бит v_cursorCfg & 0x80, выходим
0012+  C348 3A E9 8F    		lda	v_cursorCfg
0013+  C34B A7          		ana	a
0014+  C34C F8          		rm
0015+  C34D             
0016+  C34D             drawCursor2:	; Курсор нарисован/стерт
0017+  C34D 0C          		inr	c
0018+  C34E             		
0019+  C34E             drawCursor3:	; Сохраняем регистры
0020+  C34E E5          		push	h
0021+  C34F C5          		push	b
0022+  C350 D5          		push	d
0023+  C351             
0024+  C351             		; Рассчитываем адрес на экране
0025+  C351 CD 29 C3    		call	calcCursorAddr
0026+  C354 57          		mov	d, a
0027+  C355             
0028+  C355             		; Положение курсора от +2 до -5 (при битах 654 от 0 до 7)
0029+  C355             		; b = v_cursorCfg
0030+  C355             		; e = ~((v_cursorCfg / 16) % 8 - 3) + l
0031+  C355 3A E9 8F    		lda	v_cursorCfg
0032+  C358 47          		mov	b, a
0033+  C359 0F          		rrc
0034+  C35A 0F          		rrc
0035+  C35B 0F          		rrc
0036+  C35C 0F          		rrc
0037+  C35D E6 07       		ani	7
0038+  C35F D6 03       		sui	3
0039+  C361 2F          		cma
0040+  C362 85          		add	l
0041+  C363 5F          		mov	e, a
0042+  C364             
0043+  C364             		; Рассчитыаем маску курсора
0044+  C364             		;  hl = 011111100b << (((~h) % 4 +1)*2)
0045+  C364 7C          		mov	a, h
0046+  C365 2F          		cma
0047+  C366 E6 03       		ani	3
0048+  C368 21 FC 00    		lxi	h, 011111100b ; FCh
0049+  C36B 3C          		inr	a
0050+  C36C 29          drawCursor_0:	dad	h
0051+  C36D 29          		dad	h
0052+  C36E C3 43 C4    		jmp	drawCursor_10104   C371             .include "tapeWriteDelay.inc"
0001+  C371             ;+---------------------------------------------------------------------------
0002+  C371             ; MXOS
0003+  C371             ; Задержка при записи на ленту 
0004+  C371             ;
0005+  C371             ; 2013-12-12 Дизассемблировано vinxru
0006+  C371             ;----------------------------------------------------------------------------
0007+  C371             
0008+  C371 3A FE 8F    writeDelay:	lda	v_writeDelay
0009+  C374 C3 CC C3    		jmp	delay_a0105   C377             .include "tapeRead.inc"
0001+  C377             ;+---------------------------------------------------------------------------
0002+  C377             ; MXOS
0003+  C377             ; Чтение байта с ленты
0004+  C377             ;
0005+  C377             ; На входе
0006+  C377             ;  a=255 загрузка первого байта 
0007+  C377             ;  a=8   загрузка
0008+  C377             ;
0009+  C377             ; На выходе
0010+  C377             ;  c - байт
0011+  C377             ;  de,hl - сохраняются
0012+  C377             ;
0013+  C377             ; 2013-12-12 Дизассемблировано vinxru
0014+  C377             ;----------------------------------------------------------------------------
0015+  C377             
0016+  C377             tapeRead:	; Сохраняем регистры
0017+  C377 C5          		push	b
0018+  C378 D5          		push	d
0019+  C379             
0020+  C379             		; Тут будет принятый байт
0021+  C379 0E 00       		mvi	c, 0
0022+  C37B             
0023+  C37B             		; d=8 если загрузка (счетчик бит) или 0FFh если ожидание
0024+  C37B 57          		mov	d, a
0025+  C37C             
0026+  C37C             tapeRead_0:	; Получаем состояние
0027+  C37C 3A E1 FF    		lda	IO_KEYB_B
0028+  C37F E6 01       		ani	1
0029+  C381 5F          		mov	e, a
0030+  C382             
0031+  C382             		; Сдвигаем C
0032+  C382 79          		mov	a, c
0033+  C383 E6 7F       		ani	7Fh
0034+  C385 07          		rlc
0035+  C386 4F          		mov	c, a
0036+  C387             
0037+  C387             tapeRead_1:	; Получаем состояние
0038+  C387 3A E1 FF    		lda	IO_KEYB_B
0039+  C38A             
0040+  C38A             		; Если нажата клавиша, выходим
0041+  C38A FE 80       		cpi	80h
0042+  C38C DA 78 C4    		jc	tapeReadError
0043+  C38F             
0044+  C38F             		; Ждем изменения сигнала
0045+  C38F E6 01       		ani	1
0046+  C391 BB          		cmp	e
0047+  C392 CA 87 C3    		jz	tapeRead_1
0048+  C395             
0049+  C395             		; Сохраняем бит
0050+  C395 B1          		ora	c
0051+  C396 4F          		mov	c, a
0052+  C397             
0053+  C397             		; Задержка
0054+  C397 CD C9 C3    		call	readDelay
0055+  C39A             
0056+  C39A 3A E1 FF    		lda	IO_KEYB_B
0057+  C39D E6 01       		ani	1
0058+  C39F 5F          		mov	e, a
0059+  C3A0             
0060+  C3A0             		; Если происходит загрузка данных, переходим на tapeRead_4
0061+  C3A0 7A          		mov	a, d
0062+  C3A1 B7          		ora	a
0063+  C3A2 F2 BE C3    		jp	tapeRead_4
0064+  C3A5             
0065+  C3A5             		; Если происходит ожидание
0066+  C3A5             		; Если не найден 0E6h, переходим tapeRead_2
0067+  C3A5 79          		mov	a, c		
0068+  C3A6 FE E6       		cpi	0E6h
0069+  C3A8 C2 B2 C3    		jnz	tapeRead_2
0070+  C3AB             
0071+  C3AB             		; Начинаем загрузку без инверсии
0072+  C3AB AF          		xra	a
0073+  C3AC 32 F3 8F    		sta	v_tapeInverse
0074+  C3AF C3 BC C3    		jmp	tapeRead_3
0075+  C3B2             
0076+  C3B2             tapeRead_2:	; Если не найден 19h, переходим на tapeRead_0
0077+  C3B2 FE 19       		cpi	19h
0078+  C3B4 C2 7C C3    		jnz	tapeRead_0
0079+  C3B7             
0080+  C3B7             		; Начинаем загрузку с инверсией
0081+  C3B7 3E FF       		mvi	a, 0FFh
0082+  C3B9 32 F3 8F    		sta	v_tapeInverse
0083+  C3BC             
0084+  C3BC             		; Загружаем 8 бит
0085+  C3BC 16 09       tapeRead_3:	mvi	d, 9
0086+  C3BE             
0087+  C3BE             		; Повторяем 8 байт
0088+  C3BE 15          tapeRead_4:	dcr	d
0089+  C3BF C2 7C C3    		jnz	tapeRead_0
0090+  C3C2             
0091+  C3C2             		; Инверсия байта
0092+  C3C2 3A F3 8F    		lda	v_tapeInverse
0093+  C3C5 A9          		xra	c
0094+  C3C6             
0095+  C3C6             		; Восстаналиваем регистры
0096+  C3C6 D1          		pop	d
0097+  C3C7 C1          		pop	b
0098+  C3C8 C9          		ret
0106   C3C9             .include "tapeReadDelay.inc"
0001+  C3C9             ;+---------------------------------------------------------------------------
0002+  C3C9             ; MXOS
0003+  C3C9             ; Задержка при чтении с ленты
0004+  C3C9             ;
0005+  C3C9             ; 2013-12-12 Дизассемблировано vinxru
0006+  C3C9             ;----------------------------------------------------------------------------
0007+  C3C9             
0008+  C3C9 3A FF 8F    readDelay:	lda	v_readDelay
0009+  C3CC 47          delay_a:	mov	b, a
0010+  C3CD C3 90 C1    		jmp	delay_l_0
0107   C3D0             .include "tapeWrite.inc"
0001+  C3D0             ;+---------------------------------------------------------------------------
0002+  C3D0             ; MXOS
0003+  C3D0             ; Запись байта на ленту
0004+  C3D0             ;
0005+  C3D0             ; На входе 
0006+  C3D0             ;   a - байт
0007+  C3D0             ;
0008+  C3D0             ; На выходе
0009+  C3D0             ;   все регистры сохраняются
0010+  C3D0             ;
0011+  C3D0             ; 2013-12-12 Дизассемблировано vinxru
0012+  C3D0             ;----------------------------------------------------------------------------
0013+  C3D0             
0014+  C3D0             tapeWrite:	; Сохранение регистров
0015+  C3D0 C5          		push	b
0016+  C3D1 D5          		push	d
0017+  C3D2 F5          		push	psw
0018+  C3D3             
0019+  C3D3 57          		mov	d, a
0020+  C3D4             
0021+  C3D4             		; Надо записть 8 бит
0022+  C3D4 0E 08       		mvi	c, 8		
0023+  C3D6             
0024+  C3D6             tapeWrite_1:	; Сдвинуть D
0025+  C3D6 7A          		mov	a, d
0026+  C3D7 07          		rlc
0027+  C3D8 57          		mov	d, a
0028+  C3D9             
0029+  C3D9             		; Вывести бит на ленту
0030+  C3D9 E6 01       		ani	1
0031+  C3DB F6 0E       		ori	0Eh
0032+  C3DD 32 E3 FF    		sta	IO_KEYB_MODE
0033+  C3E0 5F          		mov	e, a
0034+  C3E1             
0035+  C3E1             		; Задержка
0036+  C3E1 CD 71 C3    		call	writeDelay
0037+  C3E4             
0038+  C3E4             		; Вывести инверсный бит на магнитофон
0039+  C3E4 7B          		mov	a, e
0040+  C3E5 EE 01       		xri	1
0041+  C3E7 32 E3 FF    		sta	IO_KEYB_MODE
0042+  C3EA             
0043+  C3EA             		; Задержка
0044+  C3EA CD 71 C3    		call	writeDelay
0045+  C3ED             
0046+  C3ED             		; Повторить 8 раз
0047+  C3ED 0D          		dcr	c
0048+  C3EE C2 D6 C3    		jnz	tapeWrite_1
0049+  C3F1             
0050+  C3F1             		; Восстановление регистров и выход
0051+  C3F1 F1          		pop	psw
0052+  C3F2 D1          		pop	d
0053+  C3F3 C1          		pop	b
0054+  C3F4 C9          		ret0108   C3F5 00 00 00 00 .db 0, 0, 0, 0
0109   C3F9             .include "tapeLoadInt.inc"
0001+  C3F9             ;+---------------------------------------------------------------------------
0002+  C3F9             ; MXOS
0003+  C3F9             ; Загрузка программы с ленты. КС не загружается.
0004+  C3F9             ;
0005+  C3F9             ; В случае ошибки управление передается по адресу в v_tapeError
0006+  C3F9             ;
0007+  C3F9             ; На выходе 
0008+  C3F9             ;  v_tapeAddr - адрес загруженной программы
0009+  C3F9             ;
0010+  C3F9             ; 2013-12-12 Дизассемблировано vinxru
0011+  C3F9             ;----------------------------------------------------------------------------
0012+  C3F9             
0013+  C3F9             tapeLoadInt:	; Ждем пилот-тон и читаем слово - это адрес загрузки программы
0014+  C3F9 3E FF       		mvi	a, 0FFh
0015+  C3FB CD 77 C3    		call	tapeRead		
0016+  C3FE 6F          		mov	l, a
0017+  C3FF 3E 08       		mvi	a, 8
0018+  C401 CD 77 C3    		call	tapeRead
0019+  C404 67          		mov	h, a
0020+  C405 22 E3 8F    		shld	v_tapeAddr
0021+  C408             
0022+  C408             		; Читаем следующее слово - это конец программы
0023+  C408 3E 08       		mvi	a, 8
0024+  C40A CD 77 C3    		call	tapeRead
0025+  C40D 5F          		mov	e, a
0026+  C40E 3E 08       		mvi	a, 8
0027+  C410 CD 77 C3    		call	tapeRead
0028+  C413 57          		mov	d, a
0029+  C414             
0030+  C414             		; Читаем тело программы
0031+  C414 3E 08       loc_C414:	mvi	a, 8		
0032+  C416 CD 77 C3    loc_C416:	call	tapeRead
0033+  C419 77          		mov	m, a
0034+  C41A CD 27 C4    		call	cmp_hl_de
0035+  C41D 23          		inx	h
0036+  C41E C2 14 C4    		jnz	loc_C414
0037+  C421             
0038+  C421             		; Выходим не запуская
0039+  C421 C9          		ret
0040+  C422             
0041+  C422             ; ---------------------------------------------------------------------------
0042+  C422             ; Не используется
0043+  C422             
0044+  C422 3E FF       tapeLoadAny:	mvi	a, 0FFh
0045+  C424 C3 16 C4    		jmp	loc_C4160110   C427             .include "cmp_hl_de.inc"
0001+  C427             ;+---------------------------------------------------------------------------
0002+  C427             ; MXOS
0003+  C427             ; Сравнить HL и DE
0004+  C427             ;
0005+  C427             ; 2013-12-12 Дизассемблировано vinxru
0006+  C427             ;----------------------------------------------------------------------------
0007+  C427             
0008+  C427 7C          cmp_hl_de:	mov	a, h
0009+  C428 BA          		cmp	d
0010+  C429 C0          		rnz
0011+  C42A 7D          		mov	a, l
0012+  C42B BB          		cmp	e
0013+  C42C C9          		ret
0111   C42D             .include "memcpy_bc_hl.inc"
0001+  C42D             ;+---------------------------------------------------------------------------
0002+  C42D             ; MXOS
0003+  C42D             ; Скопировать блок памяти
0004+  C42D             ;
0005+  C42D             ; На входе
0006+  C42D             ;  hl - откуда начало
0007+  C42D             ;  de - откуда конец + 1
0008+  C42D             ;  (de-hl) - длина
0009+  C42D             ;  bc - куда
0010+  C42D             ;
0011+  C42D             ; На выходе
0012+  C42D             ;  de - сохраняется
0013+  C42D             ;
0014+  C42D             ; 2013-12-12 Дизассемблировано vinxru
0015+  C42D             ;----------------------------------------------------------------------------
0016+  C42D             
0017+  C42D 7E          memcpy_bc_hl:	mov	a, m
0018+  C42E 02          		stax	b
0019+  C42F 23          		inx	h
0020+  C430 03          		inx	b
0021+  C431 CD 27 C4    		call	cmp_hl_de
0022+  C434 C2 2D C4    		jnz	memcpy_bc_hl
0023+  C437 C9          		ret0112   C438             .include "printString1.inc"
0001+  C438             ;+---------------------------------------------------------------------------
0002+  C438             ; MXOS
0003+  C438             ; Вывод строки на экран
0004+  C438             ;
0005+  C438             ; На входе
0006+  C438             ;  hl - строка
0007+  C438             ;
0008+  C438             ; На выходе
0009+  C438             ;  af, bc, de - сохраняются
0010+  C438             ;
0011+  C438             ; 2013-12-12 Дизассемблировано vinxru
0012+  C438             ;----------------------------------------------------------------------------
0013+  C438             
0014+  C438 C3 26 C5    printString1:	jmp	printString
0113   C43B             .include "printChar6.inc"
0001+  C43B             ;+---------------------------------------------------------------------------
0002+  C43B             ; MXOS
0003+  C43B             ; Обработка служебных кодов при выводе символа (продолжение)
0004+  C43B             ;
0005+  C43B             ; 2013-12-12 Дизассемблировано vinxru
0006+  C43B             ;----------------------------------------------------------------------------
0007+  C43B             
0008+  C43B             ; ---------------------------------------------------------------------------
0009+  C43B             ; Обработка ESC+F
0010+  C43B             
0011+  C43B 3E 80       printChar_eF:	mvi	a, 80h
0012+  C43D 32 EB 8F    		sta	v_escMode
0013+  C440 C9          		ret0114   C441 00 00       .db 0, 0
0115   C443             .include "drawCursor2.inc"
0001+  C443             ;+---------------------------------------------------------------------------
0002+  C443             ; MXOS
0003+  C443             ; Рисование курсора на экране (продолжение)
0004+  C443             ;
0005+  C443             ; 2013-12-12 Дизассемблировано vinxru
0006+  C443             ;----------------------------------------------------------------------------
0007+  C443             
0008+  C443             drawCursor_1:	; Цикл
0009+  C443 3D          		dcr	a
0010+  C444 C2 6C C3    		jnz	drawCursor_0
0011+  C447             
0012+  C447             		; b = v_cursorCfg & 0xF
0013+  C447 78          		mov	a, b
0014+  C448 E6 0F       		ani	0Fh
0015+  C44A 47          		mov	b, a
0016+  C44B             
0017+  C44B             		; Вывод курсора (b - высота, de - адрес на экране, hl - курсор)
0018+  C44B             
0019+  C44B             drawCursor_2:	; Повторить код ниже B раз
0020+  C44B 05          		dcr	b
0021+  C44C FA 25 C3    		jm	popa_ret_2
0022+  C44F             
0023+  C44F             		; *de--	^= hl;
0024+  C44F 1A          		ldax	d
0025+  C450 AC          		xra	h
0026+  C451 12          		stax	d
0027+  C452 14          		inr	d
0028+  C453 1A          		ldax	d
0029+  C454 AD          		xra	l
0030+  C455 12          		stax	d
0031+  C456 15          		dcr	d
0032+  C457 1D          		dcr	e
0033+  C458 C3 4B C4    		jmp	drawCursor_2		0116   C45B             .include "reboot1.inc"
0001+  C45B             ;+---------------------------------------------------------------------------
0002+  C45B             ; MXOS
0003+  C45B             ; Перезагрузка (продолжение)
0004+  C45B             ;
0005+  C45B             ; 2013-12-12 Дизассемблировано vinxru
0006+  C45B             ;----------------------------------------------------------------------------
0007+  C45B             
0008+  C45B             reboot1:	; Для выключения звука
0009+  C45B 3E 36       		mvi	a, 36h
0010+  C45D             
0011+  C45D             		; Включаем ОЗУ
0012+  C45D 32 FC FF    		sta	IO_RAM
0013+  C460             
0014+  C460             		; Выключаем звук		
0015+  C460 32 EF FF    		sta	IO_TIMER+3
0016+  C463             
0017+  C463             		; Инициализация переменных
0018+  C463 21 7E C4    		lxi	h, initVars	; Откуда
0019+  C466 11 9F C4    		lxi	d, initVarsEnd	; Конец
0020+  C469 01 DF 8F    		lxi	b, vars		; Куда
0021+  C46C CD 2D C4    		call	memcpy_bc_hl
0022+  C46F             
0023+  C46F             		; Установка цвета
0024+  C46F             #if DISABLE_COLOR_BUG
0025+  C46F 3E 70       		mvi	a, INIT_COLOR
0026+  C471 32 F8 FF    		sta	IO_COLOR
0027+  C474~            #else
0028+  C474~            		mvi	a, 0Fh  
0029+  C474~            		sta	IO_KEYB_MODE 
0030+  C474             #endif
0031+  C474             
0032+  C474             #if LOAD_FONT
0033+  C474             onceInitFont:
0034+  C474 C3 D4 CE    		jmp	initFont
0035+  C477~            #else
0036+  C477~            		jmp	reboot2
0037+  C477             #endif0117   C477 00          .db 0
0118   C478             .include "tapeReadError.inc"
0001+  C478             ;+---------------------------------------------------------------------------
0002+  C478             ; MXOS
0003+  C478             ; Вызывается при ошибке чтения с ленты
0004+  C478             ;
0005+  C478             ; 2013-12-12 Дизассемблировано vinxru
0006+  C478             ;----------------------------------------------------------------------------
0007+  C478             
0008+  C478 D1          tapeReadError:	pop	d
0009+  C479 C1          		pop	b
0010+  C47A 2A E1 8F    		lhld	v_tapeError
0011+  C47D E9          		pchl0119   C47E             
0120   C47E             ; ---------------------------------------------------------------------------
0121   C47E             
0122   C47E FF FF       initVars:	.dw -1
0123   C480 00 C8       		.dw 0C800h		; v_tapeError
0124   C482 FF FF       		.dw -1			; v_tapeAddr
0125   C484 FF FF       		.dw -1
0126   C486             #if LOAD_FONT
0127   C486 20 1D       		.dw FONT_ADDR/8		; v_charGen
0128   C488~            #else
0129   C488~            		.dw -1			; v_charGen
0130   C488             #endif
0131   C488 A9          		.db 0A9h		; v_cursorCfg
0132   C489 FF          		.db -1			; v_koi8
0133   C48A FF          		.db -1			; v_escMode
0134   C48B 3A          		.db 03Ah		; v_keyLocks
0135   C48C FF FF       		.dw -1
0136   C48E FF          		.db -1			; unk_8FEF
0137   C48F FF          		.db -1			; v_lastKey
0138   C490 5F 20       		.db 05Fh, 20h		; v_beep
0139   C492 FF          		.db 0FFh		; v_tapeInverse
0140   C493 20          		.db 020h		; v_cursorDelay
0141   C494 E0          		.db 0E0h		; byte_8FF5
0142   C495 FF FF       		.dw -1			; v_oldSP
0143   C497 FF FF       		.dw -1
0144   C499 00 00       		.dw 0			; v_inverse
0145   C49B FF          		.db -1			; v_cursorY
0146   C49C FF          		.db -1			; v_cursorX
0147   C49D 28          		.db 28h			; v_writeDelay
0148   C49E 3C          		.db 3Ch			; v_readDelay
0149   C49F 00          initVarsEnd:	.db 00h
0150   C4A0             
0151   C4A0             ; Љ« ўЁ вга 
0152   C4A0             
0153   C4A0 81 0C 19 1A v_keybTbl:	.db 81h, 0Ch, 19h, 1Ah, 09h, 1Bh, 20h,  8,  80h, 18h, 0Ah, 0Dh, 0, 0, 0, 0
0153   C4A4 09 1B 20 08 
0153   C4A8 80 18 0A 0D 
0153   C4AC 00 00 00 00 
0154   C4B0 71 7E 73 6D 		.db 71h, 7Eh, 73h, 6Dh, 69h, 74h, 78h, 62h, 60h, 2Ch, 2Fh, 7Fh, 0, 0, 0, 0
0154   C4B4 69 74 78 62 
0154   C4B8 60 2C 2F 7F 
0154   C4BC 00 00 00 00 
0155   C4C0 66 79 77 61 		.db 66h, 79h, 77h, 61h, 70h, 72h, 6Fh, 6Ch, 64h, 76h, 7Ch, 2Eh, 0, 0, 0, 0
0155   C4C4 70 72 6F 6C 
0155   C4C8 64 76 7C 2E 
0155   C4CC 00 00 00 00 
0156   C4D0 6A 63 75 6B 		.db 6Ah, 63h, 75h, 6Bh, 65h, 6Eh, 67h, 7Bh, 7Dh, 7Ah, 68h, 3Ah, 0, 0, 0, 0
0156   C4D4 65 6E 67 7B 
0156   C4D8 7D 7A 68 3A 
0156   C4DC 00 00 00 00 
0157   C4E0 3B 31 32 33 		.db 3Bh, 31h, 32h, 33h, 34h, 35h, 36h, 37h, 38h, 39h, 30h, 2Dh, 0, 0, 0, 0
0157   C4E4 34 35 36 37 
0157   C4E8 38 39 30 2D 
0157   C4EC 00 00 00 00 
0158   C4F0 00 01 02 03 		.db 00h, 01h, 02h, 03h, 04h, 05h, 06h, 07h, 8Ah, 8Bh, 8Ch, 1Fh, 0, 0, 0, 0
0158   C4F4 04 05 06 07 
0158   C4F8 8A 8B 8C 1F 
0158   C4FC 00 00 00 00 
0159   C500             
0160   C500             .include "printer.inc"
0001+  C500             ;+---------------------------------------------------------------------------
0002+  C500             ; MXOS
0003+  C500             ; Вывод байта на принтер
0004+  C500             ;
0005+  C500             ; На входе 
0006+  C500             ;   c - байт
0007+  C500             ;
0008+  C500             ; На выходе 
0009+  C500             ;   af, bc, de, hl - cохраняются
0010+  C500             ;
0011+  C500             ; 2013-12-12 Дизассемблировано vinxru
0012+  C500             ;----------------------------------------------------------------------------
0013+  C500             
0014+  C500             printer:	; Сохраняем регистры
0015+  C500 F5          		push	psw
0016+  C501             
0017+  C501             		; Режим порта расширения
0018+  C501 3E 90       		mvi	a, 90h
0019+  C503 32 E7 FF    		sta	IO_PROG+3
0020+  C506             
0021+  C506             		; Выводим байт на принтер
0022+  C506 79          		mov	a, c		
0023+  C507 2F          		cma
0024+  C508 32 E5 FF    		sta	IO_PROG+1
0025+  C50B             
0026+  C50B             printer_loop:	; Выход	при нажатии любой клавиши
0027+  C50B 3A E1 FF    		lda	IO_KEYB_B	
0028+  C50E E6 02       		ani	2
0029+  C510 CA 24 C5    		jz	printer_ret
0030+  C513             
0031+  C513             		; Ждем пока принтер не будет готов
0032+  C513 3A E4 FF    		lda	IO_PROG		
0033+  C516 E6 40       		ani	40h
0034+  C518 C2 0B C5    		jnz	printer_loop
0035+  C51B             		
0036+  C51B             		; Строб
0037+  C51B 3E 03       		mvi	a, 3		
0038+  C51D 32 E6 FF    		sta	IO_PROG+2
0039+  C520 AF          		xra	a
0040+  C521 32 E6 FF    		sta	IO_PROG+2
0041+  C524             
0042+  C524             printer_ret:	; Восстаналвиаем регистры
0043+  C524 F1          		pop	psw
0044+  C525 C9          		ret0161   C526             .include "printString.inc"
0001+  C526             ;+---------------------------------------------------------------------------
0002+  C526             ; MXOS
0003+  C526             ; Вывод строки на экран
0004+  C526             ;
0005+  C526             ; На входе
0006+  C526             ;  hl - строка
0007+  C526             ;
0008+  C526             ; На выходе
0009+  C526             ;  af, bc, de - сохраняются
0010+  C526             ;
0011+  C526             ; 2013-12-12 Дизассемблировано vinxru
0012+  C526             ;----------------------------------------------------------------------------
0013+  C526             
0014+  C526             printString:	; Сохраняем регистры
0015+  C526 C5          		push	b
0016+  C527 F5          		push	psw
0017+  C528             
0018+  C528             printString_1:	; Читаем очередной байт
0019+  C528 7E          		mov	a, m
0020+  C529             		
0021+  C529             		; Если прочитан 0, выходим
0022+  C529 B7          		ora	a
0023+  C52A CA 35 C5    		jz	printString_2
0024+  C52D             
0025+  C52D             		; Выводим байт на экран
0026+  C52D 4F          		mov	c, a
0027+  C52E CD 37 C0    		call	printChar
0028+  C531             
0029+  C531             		; Следующий байт
0030+  C531 23          		inx	h
0031+  C532 C3 28 C5    		jmp	printString_1
0032+  C535             
0033+  C535             ; ---------------------------------------------------------------------------
0034+  C535             
0035+  C535             printString_2:	; Восстанавливаем регистры
0036+  C535 F1          		pop	psw
0037+  C536 C1          		pop	b
0038+  C537 C9          		ret		0162   C538             .include "reboot2.inc"
0001+  C538             ;+---------------------------------------------------------------------------
0002+  C538             ; MXOS
0003+  C538             ; Перезагрузка (продолжение)
0004+  C538             ;
0005+  C538             ; 2013-12-12 Дизассемблировано vinxru
0006+  C538             ;----------------------------------------------------------------------------
0007+  C538             
0008+  C538             reboot2:	; Очищаем экран
0009+  C538 CD 10 C0    		call	clearScreen
0010+  C53B             
0011+  C53B             		; Проверяем, нажата ли какая нибудь клавиша
0012+  C53B CD 03 C0    		call	j_keyScan
0013+  C53E             
0014+  C53E             		; Выводим версию ОС на экран
0015+  C53E F5          		push	psw
0016+  C53F 21 51 C5    		 lxi	h, aBios4_40	; "\fBIOS 4.40"
0017+  C542 CD 38 C4    		 call	printString1
0018+  C545 F1          		pop	psw
0019+  C546             
0020+  C546             		; Если не нажата ни одна клавиша, запускаем файл с RAM-диска
0021+  C546 3C          		inr	a
0022+  C547 CA 00 C8    		jz	j_reboot3
0023+  C54A             
0024+  C54A             		; Загружаем программу с ленты (без контроля КС) и запускаем
0025+  C54A CD F9 C3    		call	tapeLoadInt
0026+  C54D 2A E3 8F    		lhld	v_tapeAddr
0027+  C550 E9          		pchl
0028+  C551             
0029+  C551             ; ---------------------------------------------------------------------------
0030+  C551             
0031+  C551 0C          aBios4_40:	.db 0Ch
0032+  C552 42 49 4F 53 		.text "BIOS 4.40"
0032+  C556 20 34 2E 34 
0032+  C55A 30 
0033+  C55B 00          		.db 0
0163   C55C             .include "getch3.inc"
0001+  C55C             ;----------------------------------------------------------------------------
0002+  C55C             ; MXOS
0003+  C55C             ; Ожидание ввода с клавиатуры (продолжение)
0004+  C55C             ;
0005+  C55C             ; На выходе
0006+  C55C             ;  ? - код
0007+  C55C             ;
0008+  C55C             ; 2013-12-12 Дизассемблировано vinxru
0009+  C55C             ;----------------------------------------------------------------------------
0010+  C55C             
0011+  C55C             loc_C55C:	; Если нажат лишь РУС/LAT - то обрабатываем его как CAPS/LOCK
0012+  C55C CD 5A C2    		call	setKeybMode91
0013+  C55F 3E F8       		mvi	a, 0F8h
0014+  C561 32 E1 FF    		sta	IO_KEYB_B
0015+  C564 3A E0 FF    		lda	IO_KEYB_A		
0016+  C567 F5          		push	psw
0017+  C568 CD 54 C2    		call	setKeybMode82
0018+  C56B F1          		pop	psw
0019+  C56C E6 08       		ani	8
0020+  C56E C2 88 C5    		jnz	getch_capsLock
0021+  C571             
0022+  C571             		; Меняем KOI-7 / KOI-8
0023+  C571 3A EA 8F    		lda	v_koi8
0024+  C574 2F          		cma
0025+  C575 32 EA 8F    		sta	v_koi8
0026+  C578             
0027+  C578             		; Звуковой сигнал
0028+  C578 CD 70 C1    		call	beep
0029+  C57B             
0030+  C57B 3E 3A       		mvi	a, 3Ah
0031+  C57D 32 EC 8F    		sta	v_keyLocks
0032+  C580             
0033+  C580             		; Меняем частоту
0034+  C580 3E 5F       		mvi	a, 5Fh
0035+  C582 32 F1 8F    		sta	v_beep
0036+  C585             
0037+  C585 C3 25 C2    		jmp	getch_retry
0038+  C588             
0039+  C588             ; ---------------------------------------------------------------------------
0040+  C588             ; CAPS LOCK для KOI-7
0041+  C588             
0042+  C588             getch_capsLock:	; Переключаем capsLock
0043+  C588 3A EC 8F    		lda	v_keyLocks
0044+  C58B EE 80       		xri	80h
0045+  C58D 32 EC 8F    		sta	v_keyLocks
0046+  C590             
0047+  C590             		; Изменяем высоту звуковго сигнала		
0048+  C590 3A F1 8F    		lda	v_beep
0049+  C593 EE 10       		xri	10h
0050+  C595 32 F1 8F    		sta	v_beep
0051+  C598             
0052+  C598             		; Ждем следующую клавишу
0053+  C598 C3 25 C2    		jmp	getch_retry
0054+  C59B             
0055+  C59B             ; ---------------------------------------------------------------------------
0056+  C59B             ; CAPS LOCK для KOI-7 или РУС/LAT для KOI-8
0057+  C59B             
0058+  C59B             getch_rc:	; В режиме KOI-8 мы переключаем кодировку
0059+  C59B 3A EA 8F    		lda	v_koi8
0060+  C59E 3C          		inr	a
0061+  C59F             
0062+  C59F 3A EC 8F    		lda	v_keyLocks	; Требуется в getch_rusLat
0063+  C5A2 C2 BD C2    		jnz	getch_rusLat
0064+  C5A5             
0065+  C5A5             		; В режиме KOI-7 мы перключаем регистр
0066+  C5A5 C3 88 C5    		jmp	getch_capsLock	
0067+  C5A8             
0068+  C5A8             ; ---------------------------------------------------------------------------
0069+  C5A8             
0070+  C5A8             loc_C5A8:	; Включен KOI-7
0071+  C5A8 47          		mov	b, a
0072+  C5A9             
0073+  C5A9 3A E1 FF    		lda	IO_KEYB_B
0074+  C5AC E6 02       		ani	2
0075+  C5AE C2 11 C3    		jnz	loc_C311
0076+  C5B1             
0077+  C5B1 3E A0       		mvi	a, 0A0h
0078+  C5B3 A8          		xra	b
0079+  C5B4 47          		mov	b, a
0080+  C5B5             
0081+  C5B5 C3 11 C3    		jmp	loc_C3110164   C5B8             .include "printChar2.inc"	; Џа®¤®«¦ Ґвбп ў scrollDown
0001+  C5B8             ;+---------------------------------------------------------------------------
0002+  C5B8             ; MXOS
0003+  C5B8             ; Вывод символа на экран (или принтер)
0004+  C5B8             ;
0005+  C5B8             ; На входе
0006+  C5B8             ;  с - символ
0007+  C5B8             ;
0008+  C5B8             ; На выходе
0009+  C5B8             ;  регистры не сохраняются
0010+  C5B8             ;
0011+  C5B8             ; 2013-12-12 Дизассемблировано vinxru
0012+  C5B8             ;----------------------------------------------------------------------------
0013+  C5B8             
0014+  C5B8             printChar2:	; Помещаем в HL координаты курсора
0015+  C5B8 2A FC 8F    		lhld	v_cursorY
0016+  C5BB             
0017+  C5BB             		; Продолжаем, если не включен режим обработки ESC последовательности (v_escMode==0FFh)
0018+  C5BB 3A EB 8F    		lda	v_escMode
0019+  C5BE 3C          		inr	a
0020+  C5BF C2 5D C6    		jnz	printChar_esc
0021+  C5C2             
0022+  C5C2             		; Тут v_escMode==0FFh
0023+  C5C2             
0024+  C5C2             		; Если это печатные символы (>=20h), переходим к печати
0025+  C5C2 79          		mov	a, c
0026+  C5C3 FE 20       		cpi	' '
0027+  C5C5 D2 D7 C5    		jnc	printChar_real
0028+  C5C8             
0029+  C5C8             		; Это табуляция
0030+  C5C8 FE 09       		cpi	9
0031+  C5CA CA 50 C0    		jz	printChar_c9	; там v_cursorX+=24 и ret
0032+  C5CD             
0033+  C5CD             		; Любой символ кроме ESC
0034+  C5CD FE 1B       		cpi	1Bh
0035+  C5CF C2 1C C1    		jnz	printChar3
0036+  C5D2             
0037+  C5D2             		; Далее ESC. Включаем режим обработки ESC последовательности (v_escMode=0)
0038+  C5D2 AF          		xra	a
0039+  C5D3 32 EB 8F    		sta	v_escMode
0040+  C5D6 C9          		ret
0041+  C5D7             
0042+  C5D7             ; ---------------------------------------------------------------------------
0043+  C5D7             ; Преобразование символа из KOI-7 в KOI-8 и вывод на экран (служебные коды 
0044+  C5D7             ; так же будут выводится)
0045+  C5D7             
0046+  C5D7             printChar_real:	; Символ для печати
0047+  C5D7 4F          		mov	c, a
0048+  C5D8             
0049+  C5D8             		; Продолжаем, если включен режим KOI-7 
0050+  C5D8 3A EA 8F    		lda	v_koi8
0051+  C5DB 3C          		inr	a
0052+  C5DC C2 F0 C5    		jnz	printChar_real2
0053+  C5DF             
0054+  C5DF             		; Если символ больше или равен 0C0h просто выходим
0055+  C5DF 79          		mov	a, c
0056+  C5E0 FE C0       		cpi	0C0h
0057+  C5E2 D0          		rnc
0058+  C5E3             
0059+  C5E3             		; Если символ находится в пределах 60h ... 7Fh, увеличиваем его код на 80h
0060+  C5E3 FE 60       		cpi	60h
0061+  C5E5 DA F0 C5    		jc	printChar_real2
0062+  C5E8 FE 80       		cpi	80h
0063+  C5EA D2 F0 C5    		jnc	printChar_real2
0064+  C5ED C6 80       		adi	80h
0065+  C5EF 4F          		mov	c, a
0066+  C5F0             
0067+  C5F0             ; ---------------------------------------------------------------------------
0068+  C5F0             ; Вывод символа на экран в KOI-8 (служебные коды так же будут выводится)
0069+  C5F0             
0070+  C5F0             printChar_real2:	
0071+  C5F0             		; Тут полиморфизм
0072+  C5F0 3A FA 8F    		lda	v_inverse
0073+  C5F3 A7          		ana	a
0074+  C5F4 CC E6 C0    printChar_poly:	cz	normalVideo
0075+  C5F7             
0076+  C5F7             		; Если v_charGen не равен 0FFFFh, то используется знакогнератор по адресу v_charGen*8
0077+  C5F7 2A E7 8F    		lhld	v_charGen
0078+  C5FA 7C          		mov	a, h
0079+  C5FB 3C          		inr	a
0080+  C5FC C2 59 C0    		jnz	printChar_alt
0081+  C5FF 7D          		mov	a, l
0082+  C600 3C          		inr	a
0083+  C601 C2 59 C0    		jnz	printChar_alt
0084+  C604             
0085+  C604             		; Иначе используем символы из ПЗУ. 
0086+  C604             		; Адрес символа в ПЗУ (de = 0x800 + c*8)
0087+  C604 21 00 01    		lxi	h, 100h		
0088+  C607 06 00       		mvi	b, 0
0089+  C609 09          		dad	b
0090+  C60A 29          		dad	h
0091+  C60B 29          		dad	h
0092+  C60C 29          		dad	h
0093+  C60D EB          		xchg
0094+  C60E             
0095+  C60E             		; Промежуточное место для символа
0096+  C60E 21 B4 C1    		lxi	h, v_char
0097+  C611 E5          		push	h
0098+  C612             
0099+  C612             		; Копируем 8 байт из ПЗУ
0100+  C612 32 FE FF    		sta	IO_ROM
0101+  C615 1A          		ldax	d
0102+  C616 77          		mov	m, a
0103+  C617 23          		inx	h
0104+  C618 13          		inx	d
0105+  C619 1A          		ldax	d
0106+  C61A 77          		mov	m, a
0107+  C61B 23          		inx	h
0108+  C61C 13          		inx	d
0109+  C61D 1A          		ldax	d
0110+  C61E 77          		mov	m, a
0111+  C61F 23          		inx	h
0112+  C620 13          		inx	d
0113+  C621 1A          		ldax	d
0114+  C622 77          		mov	m, a
0115+  C623 23          		inx	h
0116+  C624 13          		inx	d
0117+  C625 1A          		ldax	d
0118+  C626 77          		mov	m, a
0119+  C627 23          		inx	h
0120+  C628 13          		inx	d
0121+  C629 1A          		ldax	d
0122+  C62A 77          		mov	m, a
0123+  C62B 23          		inx	h
0124+  C62C 13          		inx	d
0125+  C62D 1A          		ldax	d
0126+  C62E 77          		mov	m, a
0127+  C62F 23          		inx	h
0128+  C630 13          		inx	d
0129+  C631 1A          		ldax	d
0130+  C632 77          		mov	m, a
0131+  C633 32 FC FF    		sta	IO_RAM
0132+  C636             
0133+  C636             		; Вывод символа
0134+  C636 D1          		pop	d
0135+  C637 C3 60 C0    		jmp	printChar_de
0136+  C63A             
0137+  C63A             ; ---------------------------------------------------------------------------
0138+  C63A             ; Обработка режима ESC+F
0139+  C63A             
0140+  C63A             printChar_esc80:; Если символ с кодом 0, выключаем режим обработки ESC
0141+  C63A 79          		mov	a, c
0142+  C63B B7          		ora	a
0143+  C63C CA 58 C6    		jz	printChar_esc80_exit
0144+  C63F             
0145+  C63F             		; Обработка кодов <20h
0146+  C63F FE 20       		cpi	20h
0147+  C641 DA 1C C1    		jc	printChar3
0148+  C644             
0149+  C644             		; Если код >= 80h, выйти
0150+  C644 FE 80       		cpi	80h
0151+  C646 D0          		rnc
0152+  C647             
0153+  C647             		; Если c >= 40h, вывести на экран c+40h
0154+  C647 FE 40       		cpi	40h
0155+  C649 D2 52 C6    		jnc	printChar_esc80_2
0156+  C64C             
0157+  C64C             		; Иначе вывести c - 20h
0158+  C64C D6 20       		sui	20h ; ' '
0159+  C64E 4F          		mov	c, a
0160+  C64F C3 F0 C5    		jmp	printChar_real2
0161+  C652             
0162+  C652             ; ---------------------------------------------------------------------------
0163+  C652             
0164+  C652             printChar_esc80_2:
0165+  C652             		; Если c >= 40h, вывести на экран c+40h
0166+  C652 C6 40       		adi	40h
0167+  C654 4F          		mov	c, a
0168+  C655 C3 F0 C5    		jmp	printChar_real2
0169+  C658             
0170+  C658             ; ---------------------------------------------------------------------------
0171+  C658             
0172+  C658             printChar_esc80_exit:
0173+  C658 3D          		dcr	a
0174+  C659 32 EB 8F    		sta	v_escMode
0175+  C65C C9          		ret
0176+  C65D             
0177+  C65D             ; ---------------------------------------------------------------------------
0178+  C65D             ; Печать символа в ESC-режиме
0179+  C65D             
0180+  C65D             printChar_esc:	; Перейти если v_escMode=80h
0181+  C65D 3A EB 8F    		lda	v_escMode
0182+  C660 FE 80       		cpi	80h
0183+  C662 CA 3A C6    		jz	printChar_esc80
0184+  C665             
0185+  C665             		; Выключить режим обработки ESC последовательности
0186+  C665 F5          		push	psw
0187+  C666 3E FF       		mvi	a, 0FFh
0188+  C668 32 EB 8F    		sta	v_escMode
0189+  C66B F1          		pop	psw
0190+  C66C             
0191+  C66C             		; Перейти если v_escMode==0
0192+  C66C B7          		ora	a
0193+  C66D CA A7 C6    		jz	printChar_esc0
0194+  C670             
0195+  C670             		; Перейти если обработка ESC+Y (v_escMode==1)
0196+  C670 3D          		dcr	a
0197+  C671 CA 7D C6    		jz	printChar_esc1
0198+  C674             
0199+  C674             		; Перейти если v_escMode==2
0200+  C674 3D          		dcr	a
0201+  C675 CA 99 C6    		jz	printChar_esc2
0202+  C678             
0203+  C678             		; Перейти если v_escMode==3
0204+  C678 3D          		dcr	a
0205+  C679 CA 0D C7    		jz	printChar_esc3
0206+  C67C             
0207+  C67C             		; Выйти
0208+  C67C C9          		ret
0209+  C67D             
0210+  C67D             ; ---------------------------------------------------------------------------
0211+  C67D             ; Обработка ESC+Y
0212+  C67D             
0213+  C67D             printChar_esc1:	; Если код меньше 20h или больше 20h + 24, то пропускаем установку Y
0214+  C67D 79          		mov	a, c
0215+  C67E FE 39       		cpi	20h + 25
0216+  C680 D2 93 C6    		jnc	loc_C693
0217+  C683 D6 20       		sui	20h
0218+  C685 DA 93 C6    		jc	loc_C693
0219+  C688             
0220+  C688             		; cursorY = 8 + a*10
0221+  C688 87          		add	a
0222+  C689 4F          		mov	c, a
0223+  C68A 81          		add	c
0224+  C68B 81          		add	c
0225+  C68C 81          		add	c
0226+  C68D 81          		add	c
0227+  C68E C6 08       		adi	8
0228+  C690 32 FC 8F    		sta	v_cursorY
0229+  C693             
0230+  C693             loc_C693:	; Следующий символ будет обработан в printChar_esc2
0231+  C693 3E 02       		mvi	a, 2
0232+  C695 32 EB 8F    		sta	v_escMode
0233+  C698 C9          		ret
0234+  C699             
0235+  C699             ; ---------------------------------------------------------------------------
0236+  C699             ; Обработка ESC+Y
0237+  C699             
0238+  C699             printChar_esc2:	; Если код меньше 20h или больше 20h + 63, то пропускаем установку X
0239+  C699 79          		mov	a, c
0240+  C69A FE 60       		cpi	60h
0241+  C69C D0          		rnc
0242+  C69D D6 20       		sui	20h
0243+  C69F D8          		rc
0244+  C6A0             
0245+  C6A0             		; cursorX = c*3;
0246+  C6A0 4F          		mov	c, a
0247+  C6A1 87          		add	a
0248+  C6A2 81          		add	c
0249+  C6A3 32 FD 8F    		sta	v_cursorX
0250+  C6A6 C9          		ret
0251+  C6A7             
0252+  C6A7             ; ---------------------------------------------------------------------------
0253+  C6A7             ; Обработка первого символа ESC последовательности
0254+  C6A7             
0255+  C6A7             printChar_esc0:	; Если код больше 20h
0256+  C6A7 79          		mov	a, c
0257+  C6A8 FE 28       		cpi	'(' ; 28h
0258+  C6AA CA 45 C0    		jz	printChar_e28
0259+  C6AD FE 29       		cpi	')' ; 29h
0260+  C6AF CA 4B C0    		jz	printChar_e29
0261+  C6B2 FE 50       		cpi	'P' ; 50h
0262+  C6B4 CA FD C6    		jz	printChar_eP
0263+  C6B7 D6 41       		sui	'A' ; 41h
0264+  C6B9 CA 03 C7    		jz	printChar19
0265+  C6BC 3D          		dcr	a ; 'B' 42h
0266+  C6BD CA 08 C7    		jz	printChar1A
0267+  C6C0 3D          		dcr	a ; 'C' 43h
0268+  C6C1 CA E9 C6    		jz	printChar18
0269+  C6C4 3D          		dcr	a ; 'D' 44h
0270+  C6C5 CA EE C6    		jz	printChar08
0271+  C6C8 3D          		dcr	a ; 'E' 45h
0272+  C6C9 CA F3 C6    		jz	printChar1F
0273+  C6CC 3D          		dcr	a ; 'F' 46h
0274+  C6CD CA 3B C4    		jz	printChar_eF
0275+  C6D0 3D          		dcr	a
0276+  C6D1 3D          		dcr	a ; 'H' 48h
0277+  C6D2 CA F8 C6    		jz	printChar0C
0278+  C6D5 3D          		dcr	a ; 'I' 49h
0279+  C6D6 CA 27 C7    		jz	printChar_eI
0280+  C6D9 3D          		dcr	a
0281+  C6DA 3D          		dcr	a
0282+  C6DB D6 0E       		sui	14 ; 'Y' 59h
0283+  C6DD CA E3 C6    		jz	setEscMode_eY
0284+  C6E0             
0285+  C6E0             		; Вывод символа
0286+  C6E0 C3 B8 C5    		jmp	printChar2
0287+  C6E3             
0288+  C6E3             ; ---------------------------------------------------------------------------
0289+  C6E3             ; Обработка ESC+Y.
0290+  C6E3             
0291+  C6E3             setEscMode_eY:	; Следующий символ будет обработан в printChar_esc1 
0292+  C6E3 3E 01       		mvi	a, 1
0293+  C6E5 32 EB 8F    		sta	v_escMode
0294+  C6E8 C9          		ret
0295+  C6E9             
0296+  C6E9             ; ---------------------------------------------------------------------------
0297+  C6E9             
0298+  C6E9 0E 18       printChar18:	mvi	c, 18h
0299+  C6EB C3 B8 C5    		jmp	printChar2
0300+  C6EE             
0301+  C6EE             ; ---------------------------------------------------------------------------
0302+  C6EE             
0303+  C6EE 0E 08       printChar08:	mvi	c, 8
0304+  C6F0 C3 B8 C5    		jmp	printChar2
0305+  C6F3             
0306+  C6F3             ; ---------------------------------------------------------------------------
0307+  C6F3             
0308+  C6F3 0E 1F       printChar1F:	mvi	c, 1Fh
0309+  C6F5 C3 B8 C5    		jmp	printChar2
0310+  C6F8             
0311+  C6F8             ; ---------------------------------------------------------------------------
0312+  C6F8             
0313+  C6F8 0E 0C       printChar0C:	mvi	c, 0Ch
0314+  C6FA C3 B8 C5    		jmp	printChar2
0315+  C6FD             
0316+  C6FD             ; ---------------------------------------------------------------------------
0317+  C6FD             ; Обработка ESP+P. Вклчюение режима эхопечати на принтере
0318+  C6FD             
0319+  C6FD 3E 03       printChar_eP:	mvi	a, 3
0320+  C6FF 32 EB 8F    		sta	v_escMode
0321+  C702 C9          		ret
0322+  C703             
0323+  C703             ; ---------------------------------------------------------------------------
0324+  C703             
0325+  C703 0E 19       printChar19:	mvi	c, 19h
0326+  C705 C3 B8 C5    		jmp	printChar2
0327+  C708             
0328+  C708             ; ---------------------------------------------------------------------------
0329+  C708             
0330+  C708 0E 1A       printChar1A:	mvi	c, 1Ah
0331+  C70A C3 B8 C5    		jmp	printChar2
0332+  C70D             
0333+  C70D             ; ---------------------------------------------------------------------------
0334+  C70D             ; Режим эхопечати на принтере. Включается ESC+P
0335+  C70D             
0336+  C70D             printChar_esc3:	; Выходим, из режима, если код нулевой
0337+  C70D 79          		mov	a, c
0338+  C70E B7          		ora	a
0339+  C70F C8          		rz
0340+  C710             
0341+  C710             		; Печать на принтере
0342+  C710 CD 00 C5    		call	printer
0343+  C713             
0344+  C713             		; Печать на экране
0345+  C713 CD B8 C5    		call	printChar2
0346+  C716             
0347+  C716             		; Находимся в этом режиме до кода 0 или ESC
0348+  C716 3E 03       		mvi	a, 3
0349+  C718 32 EB 8F    		sta	v_escMode
0350+  C71B C9          		ret
0351+  C71C             
0352+  C71C             ; ---------------------------------------------------------------------------
0353+  C71C             ; Продолжение обработки ESC+I. Перемещение курсора вверх с прокруткой экрана
0354+  C71C             
0355+  C71C             printChar_eI_2:	; Если cursorY > 18, перемещаем курсор вверх и выходим
0356+  C71C FE 13       		cpi	19
0357+  C71E D2 B8 C5    		jnc	printChar2
0358+  C721             
0359+  C721             		; Устанаваливаем v_cursorY=8
0360+  C721 3E 08       		mvi	a, 8
0361+  C723 32 FC 8F    		sta	v_cursorY
0362+  C726 C9          		ret
0363+  C727             
0364+  C727             ; ---------------------------------------------------------------------------
0365+  C727             ; Обработка ESC+I. Перемещение курсора вверх с прокруткой экрана
0366+  C727             
0367+  C727             printChar_eI:	; Используется дальше функцией printChar2
0368+  C727 0E 19       		mvi	c, 19h
0369+  C729             
0370+  C729             		; Прокручиваем экран вних, только если v_cursorY == 8.
0371+  C729             		; иначе переходим на printChar_eI_2
0372+  C729 3A FC 8F    		lda	v_cursorY
0373+  C72C FE 08       		cpi	8
0374+  C72E C2 1C C7    		jnz	printChar_eI_20165   C731             .include "scrollDown.inc"
0001+  C731             ;+---------------------------------------------------------------------------
0002+  C731             ; MXOS
0003+  C731             ; Прокрутка экрана вниз
0004+  C731             ;
0005+  C731             ; На выходе
0006+  C731             ;   af, bc - сохраняются
0007+  C731             ;
0008+  C731             ; 2013-12-12 Дизассемблировано vinxru
0009+  C731             ;----------------------------------------------------------------------------
0010+  C731             
0011+  C731             		; Сохраняем регистры
0012+  C731 C5          		push	b
0013+  C732 F5          		push	psw
0014+  C733 21 00 00    		lxi	h, 0
0015+  C736 39          		dad	sp
0016+  C737 22 F6 8F    		shld	v_oldSP
0017+  C73A             
0018+  C73A             		; Подготовка переменных
0019+  C73A 31 00 C0    		lxi	sp, 0C000h ; Куда
0020+  C73D 26 BF       		mvi	h, 0BFh	   ; Откуда
0021+  C73F 06 30       		mvi	b, 48      ; Столбцов
0022+  C741 0E 29       loc_C741:	mvi	c, 246 / 6 ; 246 строк
0023+  C743 2E F5       		mvi	l, 245	   ; Начинаем с 245 строки
0024+  C745             
0025+  C745             loc_C745:	; Копируем 6 байт из HL в SP
0026+  C745 56          		mov	d, m
0027+  C746 2B          		dcx	h
0028+  C747 5E          		mov	e, m
0029+  C748 2B          		dcx	h
0030+  C749 D5          		push	d		
0031+  C74A 56          		mov	d, m
0032+  C74B 2B          		dcx	h
0033+  C74C 5E          		mov	e, m
0034+  C74D 2B          		dcx	h
0035+  C74E D5          		push	d
0036+  C74F 56          		mov	d, m
0037+  C750 2B          		dcx	h
0038+  C751 5E          		mov	e, m
0039+  C752 2B          		dcx	h
0040+  C753 D5          		push	d
0041+  C754             
0042+  C754             		; Цикл
0043+  C754 0D          		dcr	c
0044+  C755 C2 45 C7    		jnz	loc_C745
0045+  C758             
0046+  C758             		; Сохраняем H
0047+  C758 7C          		mov	a, h
0048+  C759             		
0049+  C759             		; Очищаем верхние 10 строк
0050+  C759 2A FA 8F    		lhld	v_inverse
0051+  C75C E5          		push	h
0052+  C75D E5          		push	h
0053+  C75E E5          		push	h
0054+  C75F E5          		push	h
0055+  C760 E5          		push	h
0056+  C761             
0057+  C761             		; Восстанавливаем H
0058+  C761 67          		mov	h, a
0059+  C762             
0060+  C762             		; Следующий столбец
0061+  C762 05          		dcr	b
0062+  C763 C2 41 C7    		jnz	loc_C741
0063+  C766             
0064+  C766             		; Восстанавлиаем регистры и выходим
0065+  C766 2A F6 8F    		lhld	v_oldSP
0066+  C769 F9          		sphl
0067+  C76A F1          		pop	psw
0068+  C76B C1          		pop	b
0069+  C76C C9          		ret0166   C76D             .include "scrollUp2.inc"
0001+  C76D             ;+---------------------------------------------------------------------------
0002+  C76D             ; MXOS
0003+  C76D             ; Прокрутка экрана вверх (продолжение)
0004+  C76D             ;
0005+  C76D             ; 2013-12-12 Дизассемблировано vinxru
0006+  C76D             ;----------------------------------------------------------------------------
0007+  C76D             
0008+  C76D             scrollUp2:	; Копируем 246 байт из SP в H0 
0009+  C76D 0E 29       		mvi	c, 246 / 6
0010+  C76F 2E 00       		mvi	l, 0
0011+  C771             
0012+  C771             scrollUp2_0:	; Копирование 6 байт из SP в HL
0013+  C771 D1          		pop	d
0014+  C772 73          		mov	m, e
0015+  C773 23          		inx	h
0016+  C774 72          		mov	m, d
0017+  C775 23          		inx	h
0018+  C776 D1          		pop	d
0019+  C777 73          		mov	m, e
0020+  C778 23          		inx	h
0021+  C779 72          		mov	m, d
0022+  C77A 23          		inx	h
0023+  C77B D1          		pop	d
0024+  C77C 73          		mov	m, e
0025+  C77D 23          		inx	h
0026+  C77E 72          		mov	m, d
0027+  C77F 23          		inx	h
0028+  C780             
0029+  C780             		; Цикл
0030+  C780 0D          		dcr	c
0031+  C781 C2 71 C7    		jnz	scrollUp2_0
0032+  C784             
0033+  C784             		; Сохраняем H
0034+  C784 7C          		mov	a, h
0035+  C785             		
0036+  C785             		; Заполняем 10 байт 
0037+  C785 2A FA 8F    		lhld	v_inverse
0038+  C788 E5          		push	h
0039+  C789 E5          		push	h
0040+  C78A E5          		push	h
0041+  C78B E5          		push	h
0042+  C78C E5          		push	h
0043+  C78D             
0044+  C78D             		; Следующий столбец (SP += 20)
0045+  C78D 21 14 00    		lxi	h, 14h
0046+  C790 39          		dad	sp
0047+  C791 F9          		sphl
0048+  C792             
0049+  C792             		; Восстанавливаем H
0050+  C792 67          		mov	h, a
0051+  C793             
0052+  C793             		; Следующий столбец
0053+  C793 24          		inr	h
0054+  C794             
0055+  C794             		; Цикл
0056+  C794 05          		dcr	b
0057+  C795 C2 6D C7    		jnz	scrollUp2
0058+  C798             
0059+  C798             		; Восстановление регистров и выход
0060+  C798 2A F6 8F    		lhld	v_oldSP
0061+  C79B F9          		sphl
0062+  C79C F1          		pop	psw
0063+  C79D C1          		pop	b
0064+  C79E C9          		ret0167   C79F             
0168   C79F             ; ЌҐ ЁбЇ®«м§гҐвбп
0169   C79F             
0170   C79F FF FF FF FF 		.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0170   C7A3 FF FF FF FF 
0170   C7A7 FF FF FF FF 
0170   C7AB FF FF FF FF 
0171   C7AF FF FF FF FF 		.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0171   C7B3 FF FF FF FF 
0171   C7B7 FF FF FF FF 
0171   C7BB FF FF FF FF 
0172   C7BF FF FF FF FF 		.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0172   C7C3 FF FF FF FF 
0172   C7C7 FF FF FF FF 
0172   C7CB FF FF FF FF 
0173   C7CF FF FF FF FF 		.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0173   C7D3 FF FF FF FF 
0173   C7D7 FF FF FF FF 
0173   C7DB FF FF FF FF 
0174   C7DF FF FF FF FF 		.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0174   C7E3 FF FF FF FF 
0174   C7E7 FF FF FF FF 
0174   C7EB FF FF FF FF 
0175   C7EF FF FF FF FF 		.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0175   C7F3 FF FF FF FF 
0175   C7F7 FF FF FF FF 
0175   C7FB FF FF FF FF 
0176   C7FF FF          		.db 0FFh
0177   C800             
0178   C800             .org 0C800h
0179   C800             
0180   C800             .include "jmps_c800.inc"
0001+  C800 C3 E7 C9    j_reboot3:	jmp	reboot3		; Запустить NC.COM
0002+  C803 C3 37 C3    j_getch:	jmp	getch		; Ожидание ввода с клавиатуры
0003+  C806 C3 77 C3    j_tapeRead:	jmp	tapeRead	; Чтение байта с магнитофона
0004+  C809 C3 37 C0    j_printChar:	jmp	printChar	; Вывод символы на экран
0005+  C80C C3 D0 C3    j_tapeWrite:	jmp	tapeWrite	; Запись байта на магнитофон
0006+  C80F C3 AB C8    		jmp	input		; Ввод строки с клавиатуры
0007+  C812 C3 03 C0    		jmp	j_keyScan	; Получить код нажатой клавиши
0008+  C815 C3 8B C8    		jmp	printHexByte	; Вывести 16-ричное число (байт)
0009+  C818 C3 38 C4    j_printString:	jmp	printString1	; Вывести строку на экран
0010+  C81B C3 03 C0    		jmp	j_keyScan	; Получить код нажатой клавиши
0011+  C81E C3 6C C8    		jmp	getCursorPos	; Получить координаты курсора в HL (координаты в пикселях)
0012+  C821 C3 69 C8    		jmp	setCursorPos	; Установить координаты курсора из HL (координаты в пикселях)
0013+  C824 C3 D4 C9    		jmp	tapeLoad	; Загрузить программу с магнитофона
0014+  C827 C3 9B C9    		jmp	tapeSave	; Сохранить программу на магнитофон
0015+  C82A C3 84 C9    		jmp	calcCS		; Расчет контрольной суммы
0016+  C82D C3 80 C8    		jmp	printHexWord	; Вывести 16-ричное число (слово)
0017+  C830 C3 7C C8    		jmp	getMemTop	; Получить объем доступной памяти
0018+  C833 C3 70 C8    		jmp	setMemTop	; Установить объем доступной памяти
0019+  C836 C3 00 C5    		jmp	printer		; Напечатать байт на принтере
0020+  C839 C3 00 C8    		jmp	j_reboot3	; Запустить NC.COM
0021+  C83C C3 E7 C9    		jmp	reboot3		; Запустить NC.COM
0022+  C83F C3 AE CD    		jmp	fileList	; Получить список файлов
0023+  C842 C3 87 CB    		jmp	fileGetSetDrive	; Получить/установить активное устройство
0024+  C845 C3 F9 CB    		jmp	fileCreate	; Создать файл
0025+  C848 C3 D9 CC    		jmp	fileLoad	; Загрузить файл по адресу из заголовка этого файла
0026+  C84B C3 25 CD    		jmp	fileDelete	; Удалить файл
0027+  C84E C3 4B CD    		jmp	fileRename	; Переименовать файл
0028+  C851 C3 07 CD    		jmp	fileLoadInfo	; Загрузить информацию о файле
0029+  C854 C3 87 CD    		jmp	fileGetSetAddr	; Получить/установить адрес загрузки файла
0030+  C857 C3 6D CD    		jmp	fileGetSetAttr	; Получить/установить атрибуты файла
0031+  C85A C3 DB CD    		jmp	fileNamePrepare	; Преобразовать имя файла во внутренний формат
0032+  C85D C3 76 CA    		jmp	fileExec	; Запустить файл
0033+  C860 C3 73 CB    		jmp	installDriver	; Установить драйвер накопителя
0034+  C863 C3 1D CB    j_diskDriver:	jmp	diskDriver	; Драйвер выбранного диска
0035+  C866 C3 C8 CC    		jmp	fileLoad2	; Загрузить файл по адресу DE0181   C869             .include "setGetCursorPos.inc"
0001+  C869             ;+---------------------------------------------------------------------------
0002+  C869             ; MXOS
0003+  C869             ; Установить положение курсора
0004+  C869             ;
0005+  C869             ; На входе 
0006+  C869             ;  h - координата X в пикселях / 2
0007+  C869             ;  l - координата Y в пикселях
0008+  C869             ;
0009+  C869             ; На выходе 
0010+  C869             ;  af, bc, de, hl - Сохраняются
0011+  C869             ;
0012+  C869             ; 2013-12-12 Дизассемблировано vinxru
0013+  C869             ;----------------------------------------------------------------------------
0014+  C869             
0015+  C869 22 FC 8F    setCursorPos:	shld	v_cursorY
0016+  C86C             
0017+  C86C             ;----------------------------------------------------------------------------
0018+  C86C             ; Получить положение курсора
0019+  C86C             ;
0020+  C86C             ; На выходе 
0021+  C86C             ;  af, bc, de - Сохраняются
0022+  C86C             ;  h - координата X в пикселях / 2
0023+  C86C             ;  l - координата Y в пикселях
0024+  C86C             ;----------------------------------------------------------------------------
0025+  C86C             
0026+  C86C 2A FC 8F    getCursorPos:	lhld	v_cursorY
0027+  C86F C9          		ret
0182   C870             .include "setGetMemTop.inc"
0001+  C870             ;+---------------------------------------------------------------------------
0002+  C870             ; MXOS
0003+  C870             ; Установить объем доступной памяти
0004+  C870             ;
0005+  C870             ; На входе
0006+  C870             ;  hl - доступная память. Если меньше 0D000h, то значение не изменяется.
0007+  C870             ;
0008+  C870             ; На выходе
0009+  C870             ;  все регистры сохраняются
0010+  C870             ;
0011+  C870             ; 2013-12-12 Дизассемблировано vinxru
0012+  C870             ;----------------------------------------------------------------------------
0013+  C870             
0014+  C870 F5          setMemTop:	push	psw
0015+  C871 7C          		mov	a, h
0016+  C872 FE D0       		cpi	0D0h
0017+  C874 DA 7A C8    		jc	setMemTop_0
0018+  C877 22 8C CE    		  shld	v_memTop
0019+  C87A F1          setMemTop_0:	pop	psw
0020+  C87B C9          		ret
0021+  C87C             
0022+  C87C             ;----------------------------------------------------------------------------
0023+  C87C             ; Получить объем доступной памяти
0024+  C87C             ;
0025+  C87C             ; На выходе
0026+  C87C             ;  hl - доступная память
0027+  C87C             ;
0028+  C87C             ; На выходе
0029+  C87C             ;  все регистры сохраняются
0030+  C87C             ;----------------------------------------------------------------------------
0031+  C87C             		
0032+  C87C 2A 8C CE    getMemTop:	lhld	v_memTop
0033+  C87F C9          		ret0183   C880             .include "printHex.inc"
0001+  C880             ;+---------------------------------------------------------------------------
0002+  C880             ; MXOS
0003+  C880             ; Вывод 16-ричного числа на экран (слово)
0004+  C880             ;
0005+  C880             ; На входе
0006+  C880             ;  hl - число
0007+  C880             ;
0008+  C880             ; На выходе
0009+  C880             ;  все регистры сохраняются
0010+  C880             ;
0011+  C880             ; 2013-12-12 Дизассемблировано vinxru
0012+  C880             ;----------------------------------------------------------------------------
0013+  C880             
0014+  C880             printHexWord:	; Сохраняем регистры
0015+  C880 F5          		push	psw		
0016+  C881             
0017+  C881             		; Старший байт
0018+  C881 7C          		mov	a, h
0019+  C882 CD 8B C8    		call	printHexByte
0020+  C885             
0021+  C885             		; Младшйи байт
0022+  C885 7D          		mov	a, l
0023+  C886 CD 8B C8    		call	printHexByte
0024+  C889             
0025+  C889             		; Восстаналиваем регистры
0026+  C889 F1          		pop	psw
0027+  C88A C9          		ret
0028+  C88B             
0029+  C88B             ;----------------------------------------------------------------------------
0030+  C88B             ; Вывод 16-ричного числа на экран (байт)
0031+  C88B             ;
0032+  C88B             ; На входе
0033+  C88B             ;  a - число
0034+  C88B             ;
0035+  C88B             ; На выходе
0036+  C88B             ;  все регистры сохраняются
0037+  C88B             ;----------------------------------------------------------------------------
0038+  C88B             
0039+  C88B             printHexByte:	; Сохраняем регистры
0040+  C88B C5          		push	b
0041+  C88C F5          		push	psw
0042+  C88D             
0043+  C88D             		; Сохраняем A для вывода второй цифры
0044+  C88D 47          		mov	b, a
0045+  C88E             
0046+  C88E             		; Первая цифра - старшие 4 бита
0047+  C88E 07          		rlc
0048+  C88F 07          		rlc
0049+  C890 07          		rlc
0050+  C891 07          		rlc
0051+  C892 CD 9C C8    		call	printHexNibble
0052+  C895             
0053+  C895             		; Вторая цифра - младщие 4 бита
0054+  C895 78          		mov	a, b
0055+  C896 CD 9C C8    		call	printHexNibble
0056+  C899             
0057+  C899             		; Восстаналиваем регистры
0058+  C899 F1          		pop	psw
0059+  C89A C1          		pop	b
0060+  C89B C9          		ret
0061+  C89C             
0062+  C89C             ;----------------------------------------------------------------------------
0063+  C89C             ; Вывод 16-ричного числа на экран (цифра)
0064+  C89C             ;
0065+  C89C             ; На входе
0066+  C89C             ;  a - число, используются младшие 4 бита
0067+  C89C             ;
0068+  C89C             ; На выходе
0069+  C89C             ;  c, a - изменяются, остальные регистры сохраняются
0070+  C89C             ;----------------------------------------------------------------------------
0071+  C89C             
0072+  C89C E6 0F       printHexNibble:	ani	0Fh
0073+  C89E C6 30       		adi	'0'
0074+  C8A0 FE 3A       		cpi	'9'+1
0075+  C8A2 DA A7 C8    		jc	printHexNib_0
0076+  C8A5 C6 07       		  adi	'A'-'0'-10
0077+  C8A7 4F          printHexNib_0:	mov	c, a
0078+  C8A8 C3 09 C8    		jmp	j_printChar0184   C8AB             .include "input.inc"
0001+  C8AB             ;+---------------------------------------------------------------------------
0002+  C8AB             ; MXOS
0003+  C8AB             ; Ввод строки
0004+  C8AB             ;
0005+  C8AB             ; На входе
0006+  C8AB             ;  hl - начало буфера
0007+  C8AB             ;  de - конец буфера
0008+  C8AB             ;
0009+  C8AB             ; На выходе
0010+  C8AB             ;  bc, de, hl - сохраняются
0011+  C8AB             ;
0012+  C8AB             ; 2013-12-12 Дизассемблировано vinxru
0013+  C8AB             ;----------------------------------------------------------------------------
0014+  C8AB             
0015+  C8AB             input:		; Сохраняем регистры
0016+  C8AB E5          		push	h
0017+  C8AC C5          		push	b
0018+  C8AD F5          		push	psw
0019+  C8AE             
0020+  C8AE             		; Сохраняем значения
0021+  C8AE 22 82 CE    		shld	v_input_start
0022+  C8B1 EB          		xchg
0023+  C8B2 22 88 CE    		shld	v_input_end
0024+  C8B5             
0025+  C8B5             		; Помещаем в конец буфера 0
0026+  C8B5 62          		mov	h, d
0027+  C8B6 6B          		mov	l, e
0028+  C8B7 36 00       		mvi	m, 0
0029+  C8B9             
0030+  C8B9             input_loop:	; Ждем клавиашу
0031+  C8B9 CD 03 C8    		call	j_getch
0032+  C8BC 4F          		mov	c, a
0033+  C8BD             
0034+  C8BD             		; Нажата служебная клавиша
0035+  C8BD FE 20       		cpi	20h
0036+  C8BF DA 14 C9    		jc	input_spec
0037+  C8C2             
0038+  C8C2             		; Нажата клавиша Back space
0039+  C8C2 FE 7F       		cpi	7Fh
0040+  C8C4 CA 03 C9    		jz	input_bkspc
0041+  C8C7             
0042+  C8C7             		; ...
0043+  C8C7 00          		nop
0044+  C8C8 00          		nop
0045+  C8C9 00          		nop
0046+  C8CA             
0047+  C8CA             		; Это конец буфера
0048+  C8CA E5          		push	h
0049+  C8CB 2A 88 CE    		lhld	v_input_end
0050+  C8CE CD 46 C9    		call	cmp_hl_de_2
0051+  C8D1 E1          		pop	h
0052+  C8D2 C2 DE C8    		jnz	loc_C8DE		
0053+  C8D5 CD 46 C9    		call	cmp_hl_de_2
0054+  C8D8 CA B9 C8    		jz	input_loop
0055+  C8DB 1A          		ldax	d
0056+  C8DC 1B          		dcx	d
0057+  C8DD 12          		stax	d
0058+  C8DE C5          loc_C8DE:	push	b
0059+  C8DF 44          		mov	b, h
0060+  C8E0 4D          		mov	c, l
0061+  C8E1 03          		inx	b
0062+  C8E2 CD 54 C9    		call	memmove_bc_hl
0063+  C8E5 C1          		pop	b
0064+  C8E6 71          		mov	m, c		; *hl++	= c;
0065+  C8E7 CD 09 C8    		call	j_printChar	; Вывод	символа	на экран
0066+  C8EA 23          		inx	h
0067+  C8EB 13          		inx	d		
0068+  C8EC E5          loc_C8EC:	push	h
0069+  C8ED 2A FC 8F    		lhld	v_cursorY
0070+  C8F0 E3          		xthl
0071+  C8F1 E5          		push	h
0072+  C8F2 CD 18 C8    		call	j_printString
0073+  C8F5 0E 20       		mvi	c, ' '
0074+  C8F7 CD 09 C8    		call	j_printChar
0075+  C8FA E1          		pop	h
0076+  C8FB E3          		xthl
0077+  C8FC 22 FC 8F    		shld	v_cursorY
0078+  C8FF E1          		pop	h
0079+  C900             
0080+  C900             		; Продолжение
0081+  C900 C3 B9 C8    		jmp	input_loop
0082+  C903             
0083+  C903             ; ---------------------------------------------------------------------------
0084+  C903             
0085+  C903             input_bkspc:	; Если курсор в начале строки ничего не удаляем
0086+  C903 CD 46 C9    		call	cmp_hl_de_2
0087+  C906 CA B9 C8    		jz	input_loop
0088+  C909             
0089+  C909             		; Сдвигаем строку
0090+  C909 44          		mov	b, h
0091+  C90A 4D          		mov	c, l
0092+  C90B 23          		inx	h
0093+  C90C CD 54 C9    		call	memmove_bc_hl
0094+  C90F             
0095+  C90F             		; Уменьшаем положение курсора
0096+  C90F 2B          		dcx	h
0097+  C910             
0098+  C910 1B          		dcx	d
0099+  C911 C3 EC C8    		jmp	loc_C8EC
0100+  C914             
0101+  C914             ; ---------------------------------------------------------------------------
0102+  C914             
0103+  C914             input_spec:	; Нажато влево
0104+  C914 FE 08       		cpi	8
0105+  C916 CA 28 C9    		jz	input_left
0106+  C919             
0107+  C919             		; Нажато вправо
0108+  C919 FE 18       		cpi	18h
0109+  C91B CA 3C C9    		jz	input_right
0110+  C91E             
0111+  C91E             		; Нажат не ввод
0112+  C91E FE 0D       		cpi	0Dh
0113+  C920 C2 B9 C8    		jnz	input_loop
0114+  C923             
0115+  C923             		; Нажат ввод
0116+  C923             
0117+  C923             		; Сохраняем в конец стрки 0D
0118+  C923 12          		stax	d
0119+  C924             
0120+  C924             		; Восстанавливаем регистры и выходим
0121+  C924 F1          		pop	psw
0122+  C925 C1          		pop	b
0123+  C926 E1          		pop	h
0124+  C927 C9          		ret
0125+  C928             
0126+  C928             ; ---------------------------------------------------------------------------
0127+  C928             
0128+  C928             input_left:	; Если курсор в начале строки (hl==v_input_start) не перемещаем курсор
0129+  C928 EB          		xchg
0130+  C929 E5          		push	h		
0131+  C92A 2A 82 CE    		lhld	v_input_start
0132+  C92D CD 46 C9    		call	cmp_hl_de_2
0133+  C930 E1          		pop	h
0134+  C931 EB          		xchg
0135+  C932 CA B9 C8    		jz	input_loop
0136+  C935             
0137+  C935             		; Уменьшаем положение курсора
0138+  C935 2B          		dcx	h
0139+  C936             
0140+  C936             input_lr:	; Перемещаем курсор вправо/влево
0141+  C936 CD 09 C8    		call	j_printChar
0142+  C939             
0143+  C939             		; Продолжаем ввод
0144+  C939 C3 B9 C8    		jmp	input_loop
0145+  C93C             
0146+  C93C             ; ---------------------------------------------------------------------------
0147+  C93C             
0148+  C93C             input_right:	; Если курсор в конце строк (hl==de) не перемещаем курсор
0149+  C93C CD 46 C9    		call	cmp_hl_de_2
0150+  C93F CA B9 C8    		jz	input_loop
0151+  C942             
0152+  C942             		; Увеличиваем положение курсора
0153+  C942 23          		inx	h
0154+  C943             
0155+  C943             		; Общее продолжение
0156+  C943 C3 36 C9    		jmp	input_lr0185   C946             .include "cmp_hl_de_2.inc"
0001+  C946             ;+---------------------------------------------------------------------------
0002+  C946             ; MXOS
0003+  C946             ; Сравнить HL и DE
0004+  C946             ;
0005+  C946             ; 2013-12-12 Дизассемблировано vinxru
0006+  C946             ;----------------------------------------------------------------------------
0007+  C946             
0008+  C946 7C          cmp_hl_de_2:	mov	a, h
0009+  C947 BA          		cmp	d
0010+  C948 D8          		rc
0011+  C949 C0          		rnz
0012+  C94A 7D          		mov	a, l
0013+  C94B BB          		cmp	e
0014+  C94C C9          		ret0186   C94D             .include "sbb_de_hl_to_hl.inc"
0001+  C94D             ;+---------------------------------------------------------------------------
0002+  C94D             ; MXOS
0003+  C94D             ; HL = DE - HL
0004+  C94D             ;
0005+  C94D             ; 2013-12-12 Дизассемблировано vinxru
0006+  C94D             ;----------------------------------------------------------------------------
0007+  C94D             
0008+  C94D             sbb_de_hl_to_hl:
0009+  C94D 7B          		mov	a, e
0010+  C94E 95          		sub	l
0011+  C94F 6F          		mov	l, a
0012+  C950 7A          		mov	a, d
0013+  C951 9C          		sbb	h
0014+  C952 67          		mov	h, a
0015+  C953 C9          		ret0187   C954             .include "memmove_bc_hl.inc"
0001+  C954             ;+---------------------------------------------------------------------------
0002+  C954             ; MXOS
0003+  C954             ; Копирование накладывающихся блоков памяти (с ошибкой)
0004+  C954             ;
0005+  C954             ; На входе
0006+  C954             ;  hl - откуда
0007+  C954             ;  de - откуда, конечный адрес не включая
0008+  C954             ;  bc - куда BC с увеличением адресов
0009+  C954             ;
0010+  C954             ; 2013-12-12 Дизассемблировано vinxru
0011+  C954             ;----------------------------------------------------------------------------
0012+  C954             
0013+  C954             memmove_bc_hl:	; Сохраняем регистры
0014+  C954 E5          		push	h
0015+  C955 C5          		push	b
0016+  C956 D5          		push	d
0017+  C957             
0018+  C957             		; Если b<h или c<l, то
0019+  C957 78          		mov	a, b
0020+  C958 BC          		cmp	h
0021+  C959 DA 76 C9    		jc	memcpy_bc_hl2
0022+  C95C             		; Тут не хватает jnz
0023+  C95C 79          		mov	a, c
0024+  C95D BD          		cmp	l
0025+  C95E DA 76 C9    		jc	memcpy_bc_hl2
0026+  C961             
0027+  C961             		; bc = bc + de - hl
0028+  C961 E5          		push	h		
0029+  C962 CD 4D C9    		call	sbb_de_hl_to_hl
0030+  C965 09          		dad	b
0031+  C966 44          		mov	b, h
0032+  C967 4D          		mov	c, l
0033+  C968 E1          		pop	h
0034+  C969             
0035+  C969             memcpyb_bc_de:	; Копируем из DE в BC с уменьшением адресов, пока HL не равно DE
0036+  C969 1A          		ldax	d
0037+  C96A 02          		stax	b
0038+  C96B CD 46 C9    		call	cmp_hl_de_2
0039+  C96E 1B          		dcx	d
0040+  C96F 0B          		dcx	b
0041+  C970 C2 69 C9    		jnz	memcpyb_bc_de
0042+  C973             
0043+  C973             		; Восстановление регистров и выход
0044+  C973 C3 80 C9    		jmp	pop_dbh_ret2
0045+  C976             
0046+  C976             ; ---------------------------------------------------------------------------
0047+  C976             
0048+  C976             memcpy_bc_hl2:	; Копируем из HL в BC с увеличением адресов, пока HL не равно DE
0049+  C976 7E          		mov	a, m
0050+  C977 02          		stax	b
0051+  C978 CD 46 C9    		call	cmp_hl_de_2
0052+  C97B 23          		inx	h
0053+  C97C 03          		inx	b
0054+  C97D C2 76 C9    		jnz	memcpy_bc_hl2
0055+  C980             
0056+  C980             pop_dbh_ret2:	; Восстановление регистров и выход
0057+  C980 D1          		pop	d
0058+  C981 C1          		pop	b
0059+  C982 E1          		pop	h
0060+  C983 C9          		ret0188   C984             .include "calcCS.inc"
0001+  C984             ;+---------------------------------------------------------------------------
0002+  C984             ; MXOS
0003+  C984             ; Расчет контрольной суммы
0004+  C984             ;
0005+  C984             ; На входе
0006+  C984             ;  hl - начальный адрес
0007+  C984             ;  de - конечный адрес
0008+  C984             ;
0009+  C984             ; На выходе
0010+  C984             ;  bc - контрольная сумма
0011+  C984             ;
0012+  C984             ; 2013-12-12 Дизассемблировано vinxru
0013+  C984             ;----------------------------------------------------------------------------
0014+  C984             
0015+  C984 01 00 00    calcCS:		lxi	b, 0
0016+  C987 7E          calcCS_1:	mov	a, m
0017+  C988 81          		add	c
0018+  C989 4F          		mov	c, a
0019+  C98A F5          		push	psw
0020+  C98B CD 46 C9    		call	cmp_hl_de_2
0021+  C98E CA 99 C9    		jz	calcCS_2
0022+  C991 F1          		pop	psw
0023+  C992 78          		mov	a, b
0024+  C993 8E          		adc	m
0025+  C994 47          		mov	b, a
0026+  C995 23          		inx	h
0027+  C996 C3 87 C9    		jmp	calcCS_1
0028+  C999             
0029+  C999             ; ---------------------------------------------------------------------------
0030+  C999             
0031+  C999 F1          calcCS_2:	pop	psw
0032+  C99A C9          		ret0189   C99B             .include "tapeSave.inc"
0001+  C99B             ;+---------------------------------------------------------------------------
0002+  C99B             ; MXOS
0003+  C99B             ; Запись программы на ленту
0004+  C99B             ;
0005+  C99B             ; На входе
0006+  C99B             ;  hl - начальный адрес
0007+  C99B             ;  de - конечный адрес
0008+  C99B             ;
0009+  C99B             ; На выходе
0010+  C99B             ;  bc - контрольная сумма
0011+  C99B             ;  de,hl - сохраняются
0012+  C99B             ;
0013+  C99B             ; 2013-12-12 Дизассемблировано vinxru
0014+  C99B             ;----------------------------------------------------------------------------
0015+  C99B             
0016+  C99B             tapeSave:	; Расчитываем CRC
0017+  C99B E5          		push	h
0018+  C99C CD 84 C9    		call	calcCS
0019+  C99F E1          		pop	h
0020+  C9A0             
0021+  C9A0 E5          		push	h
0022+  C9A1 C5          		push	b
0023+  C9A2             
0024+  C9A2             		; Пилот-тон (256 нулей)
0025+  C9A2 06 00       		mvi	b, 0
0026+  C9A4 AF          loc_C9A4:	xra	a
0027+  C9A5 CD 0C C8    		call	j_tapeWrite
0028+  C9A8 05          		dcr	b
0029+  C9A9 C2 A4 C9    		jnz	loc_C9A4
0030+  C9AC             
0031+  C9AC             		; Стартовый байт 0E6h
0032+  C9AC 3E E6       		mvi	a, 0E6h
0033+  C9AE CD 0C C8    		call	j_tapeWrite
0034+  C9B1             
0035+  C9B1             		; Запись адреса первого байта
0036+  C9B1 CD CC C9    		call	tapeWriteWord
0037+  C9B4 EB          		xchg
0038+  C9B5             
0039+  C9B5             		; Запись адреса последнего байта
0040+  C9B5 CD CC C9    		call	tapeWriteWord
0041+  C9B8 EB          		xchg
0042+  C9B9             		
0043+  C9B9             loc_C9B9:	; Запись блока памяти от HL до DE
0044+  C9B9 7E          		mov	a, m
0045+  C9BA CD 0C C8    		call	j_tapeWrite
0046+  C9BD CD 46 C9    		call	cmp_hl_de_2
0047+  C9C0 23          		inx	h
0048+  C9C1 C2 B9 C9    		jnz	loc_C9B9
0049+  C9C4             
0050+  C9C4             		; Запись CRC
0051+  C9C4 E1          		pop	h
0052+  C9C5 CD CC C9    		call	tapeWriteWord
0053+  C9C8             
0054+  C9C8             		; Возвращаем CRC в регистре BC
0055+  C9C8 44          		mov	b, h
0056+  C9C9 4D          		mov	c, l
0057+  C9CA             
0058+  C9CA             		; Восстанавливаем регистры и выходим
0059+  C9CA E1          		pop	h
0060+  C9CB C9          		ret0190   C9CC             .include "tapeWriteWord.inc"
0001+  C9CC             ;+---------------------------------------------------------------------------
0002+  C9CC             ; MXOS
0003+  C9CC             ; Запись слова на ленту
0004+  C9CC             ;
0005+  C9CC             ; На входе
0006+  C9CC             ;  hl - слово
0007+  C9CC             ;
0008+  C9CC             ; На выходе
0009+  C9CC             ;  bc,de,hl - сохраняются
0010+  C9CC             ;
0011+  C9CC             ; 2013-12-12 Дизассемблировано vinxru
0012+  C9CC             ;----------------------------------------------------------------------------
0013+  C9CC             
0014+  C9CC 7D          tapeWriteWord:	mov	a, l
0015+  C9CD CD 0C C8    		call	j_tapeWrite
0016+  C9D0 7C          		mov	a, h
0017+  C9D1 C3 0C C8    		jmp	j_tapeWrite
0191   C9D4             .include "tapeLoad.inc"
0001+  C9D4             ;+---------------------------------------------------------------------------
0002+  C9D4             ; MXOS
0003+  C9D4             ; Загрузка программы с ленты. КС загружается, но не проверяется.
0004+  C9D4             ;
0005+  C9D4             ; В случае ошибки управление передается по адресу в v_tapeError
0006+  C9D4             ;
0007+  C9D4             ; На выходе 
0008+  C9D4             ;  bc - контольная сумма
0009+  C9D4             ;  hl, v_tapeAddr - адрес загруженной программы
0010+  C9D4             ;
0011+  C9D4             ; 2013-12-12 Дизассемблировано vinxru
0012+  C9D4             ;----------------------------------------------------------------------------
0013+  C9D4             
0014+  C9D4             tapeLoad:	; Загружаем файл с ленты без загрузки КС
0015+  C9D4 CD F9 C3    		call	tapeLoadInt
0016+  C9D7             
0017+  C9D7             		; Читаем КС
0018+  C9D7 3E 08       		mvi	a, 8
0019+  C9D9 CD 06 C8    		call	j_tapeRead
0020+  C9DC 4F          		mov	c, a
0021+  C9DD 3E 08       		mvi	a, 8
0022+  C9DF CD 06 C8    		call	j_tapeRead
0023+  C9E2 47          		mov	b, a
0024+  C9E3             
0025+  C9E3             		; В HL возврааем адрес запуска
0026+  C9E3 2A E3 8F    		lhld	v_tapeAddr
0027+  C9E6 C9          		ret0192   C9E7             .include "reboot3.inc"
0001+  C9E7             ;+---------------------------------------------------------------------------
0002+  C9E7             ; MXOS
0003+  C9E7             ; Обновление драйвера по адресу 0FFC0h и запуск NC.COM
0004+  C9E7             ;
0005+  C9E7             ; А так же однократный запуск AUTOEX.BAT, если не нажата клавиша.
0006+  C9E7             ;
0007+  C9E7             ; 2013-12-12 Дизассемблировано vinxru
0008+  C9E7             ;----------------------------------------------------------------------------
0009+  C9E7             
0010+  C9E7             reboot3:	; Инициализация стека
0011+  C9E7 31 C0 FF    		lxi	sp, STACK_ADDR
0012+  C9EA             
0013+  C9EA             		; Копируем драйвер в отведенное для него место
0014+  C9EA 21 FE CA    		lxi	h, driverStart
0015+  C9ED 11 1C CB    		lxi	d, driverEnd
0016+  C9F0 01 C0 FF    		lxi	b, 0FFC0h
0017+  C9F3 CD 54 C9    		call	memmove_bc_hl
0018+  C9F6             
0019+  C9F6             		; Обновляем переменные
0020+  C9F6 21 00 C8    		lxi	h, j_reboot3
0021+  C9F9 22 E1 8F    		shld	v_tapeError
0022+  C9FC             
0023+  C9FC             		; Код ниже будет выполнен лишь один раз после холодной перезагрузки.
0024+  C9FC             		; То есть при теплой перезагрузке он не вызывается.
0025+  C9FC C3 FF C9    reboot3_0:	jmp	reboot3_1
0026+  C9FF 21 19 CA    reboot3_1:	lxi	h, reboot3_2
0027+  CA02 22 FD C9    		shld	reboot3_0+1
0028+  CA05             
0029+  CA05             		; В этом файле будет запуск дравера накопителя A:
0030+  CA05             #if START_FROM_RAM
0031+  CA05 21 C7 CE    		lxi	h, aDriver
0032+  CA08 CD 76 CA    		call	fileExec		
0033+  CA0B             #endif
0034+  CA0B             
0035+  CA0B             		; Если нажата клавиша, пропустить запуск B:AUTOEX.BAT
0036+  CA0B 3A E1 FF    		lda	IO_KEYB_B	
0037+  CA0E E6 02       		ani	2
0038+  CA10 CA 19 CA    		jz	reboot3_2
0039+  CA13             
0040+  CA13             		; Запуск файла B:AUTOEX.BAT
0041+  CA13 21 97 CE    		lxi	h, aBAutoex_bat
0042+  CA16 CD 76 CA    		call	fileExec
0043+  CA19             
0044+  CA19             reboot3_2:	; Запуск файла NC.COM
0045+  CA19 21 8E CE    		lxi	h, aANc_com
0046+  CA1C CD 76 CA    		call	fileExec
0047+  CA1F             
0048+  CA1F             		; Теплая перезагрузка
0049+  CA1F C3 00 C8    		jmp	j_reboot30193   CA22             .include "fileExecBat.inc"
0001+  CA22             ;+---------------------------------------------------------------------------
0002+  CA22             ; MXOS
0003+  CA22             ; Запустить BAT файл. Вызывается функцией fileExec
0004+  CA22             ;
0005+  CA22             ; 2013-12-12 Дизассемблировано vinxru
0006+  CA22             ;----------------------------------------------------------------------------
0007+  CA22             
0008+  CA22 D1          execBat:	pop	d
0009+  CA23             
0010+  CA23             		; Сбрасываем счетчик
0011+  CA23 21 00 FC    		lxi	h, diskDirectory 
0012+  CA26 22 8A CE    		shld	v_batPtr		
0013+  CA29 EB          		xchg
0014+  CA2A             
0015+  CA2A             		; Проверяем наличие BAT-файла
0016+  CA2A 21 AD CE    		lxi	h, v_fileName
0017+  CA2D 0E 01       		mvi	c, 1
0018+  CA2F CD 87 CD    		call	fileGetSetAddr
0019+  CA32 DA DA CA    		jc	badCommand
0020+  CA35             
0021+  CA35             		; Сохраняем имя BAT-файла
0022+  CA35 21 AD CE    		lxi	h, v_fileName	
0023+  CA38 11 BC CE    		lxi	d, v_fileName_end
0024+  CA3B 01 BD CE    		lxi	b, v_batFileName
0025+  CA3E CD 54 C9    		call	memmove_bc_hl
0026+  CA41             
0027+  CA41             		; Сохраняем диск содержащий BAT-файл
0028+  CA41 3A 81 CE    		lda	v_drive
0029+  CA44 32 4C CA    		sta	v_batDrive+1
0030+  CA47             
0031+  CA47             execBat_loop:	; Этот цикл выполняется для каждой строки BAT-файла
0032+  CA47             
0033+  CA47             		; Сохраняем текущий диск
0034+  CA47 3A 81 CE    		lda	v_drive
0035+  CA4A 47          		mov	b, a
0036+  CA4B             
0037+  CA4B             v_batDrive:	; Выбрать диск содержащий BAT файл
0038+  CA4B 3E 01       		mvi	a, 1		
0039+  CA4D CD 8F CB    		call	fileSelectDrive
0040+  CA50             
0041+  CA50             		; Загрузить BAT-файл в память
0042+  CA50 21 BD CE    		lxi	h, v_batFileName 
0043+  CA53 CD D9 CC    		call	fileLoad
0044+  CA56 2A 8A CE    		lhld	v_batPtr
0045+  CA59             
0046+  CA59             		; Сохраняем начало строки
0047+  CA59 54          		mov	d, h
0048+  CA5A 5D          		mov	e, l
0049+  CA5B             
0050+  CA5B             execBat_0:	; Ищем конец строки
0051+  CA5B 7E          		mov	a, m		
0052+  CA5C 23          		inx	h
0053+  CA5D             
0054+  CA5D             		; Найден конец строки, запускаем файл
0055+  CA5D FE 0D       		cpi	0Dh		
0056+  CA5F CA 68 CA    		jz	execBat_1
0057+  CA62             
0058+  CA62             		; Конец	файла
0059+  CA62 FE FF       		cpi	0FFh		
0060+  CA64 C2 5B CA    		jnz	execBat_0
0061+  CA67 C9          		ret
0062+  CA68             
0063+  CA68             ; ---------------------------------------------------------------------------
0064+  CA68             
0065+  CA68             execBat_1:	; Сохраняем указатель
0066+  CA68 22 8A CE    		shld	v_batPtr	
0067+  CA6B             
0068+  CA6B             		; Восстановление активного диска		
0069+  CA6B 78          		mov	a, b		
0070+  CA6C CD 8F CB    		call	fileSelectDrive
0071+  CA6F             
0072+  CA6F             		; Запустить файл
0073+  CA6F EB          		xchg			
0074+  CA70 CD 76 CA    		call	fileExec
0075+  CA73             
0076+  CA73 C3 47 CA    		jmp	execBat_loop0194   CA76             .include "fileExec.inc"
0001+  CA76             ;+---------------------------------------------------------------------------
0002+  CA76             ; MXOS
0003+  CA76             ; Запустить файл
0004+  CA76             ;
0005+  CA76             ; На входе
0006+  CA76             ;  hl - ком строка в формате [Диск:]файл[ аргументы]
0007+  CA76             ;
0008+  CA76             ; На выходе
0009+  CA76             ;  сf - ошибка
0010+  CA76             ;
0011+  CA76             ; 2013-12-12 Дизассемблировано vinxru
0012+  CA76             ;----------------------------------------------------------------------------
0013+  CA76             
0014+  CA76             fileExec:	; Сюда будем записывать результат
0015+  CA76 11 00 FF    		lxi	d, v_cmdLine
0016+  CA79             		
0017+  CA79             		; Если первый символ меньше пробела, выходим c CF
0018+  CA79 7E          		mov	a, m
0019+  CA7A FE 20       		cpi	' '
0020+  CA7C DA E0 CA    		jc	stc_ret
0021+  CA7F             
0022+  CA7F             		; Максимальный размер ком строки (+2 терминатора, итого 82h)
0023+  CA7F 0E 80       		mvi	c, 80h		
0024+  CA81             
0025+  CA81             fileExec_0:	; Если символ меньше пробела, выходим
0026+  CA81 7E          		mov	a, m
0027+  CA82 FE 20       		cpi	20h
0028+  CA84 DA 8E CA    		jc	fileExec_1
0029+  CA87             
0030+  CA87             		; Копируем симовол из HL в DE
0031+  CA87 12          		stax	d
0032+  CA88 23          		inx	h
0033+  CA89 13          		inx	d
0034+  CA8A             
0035+  CA8A             		; Повторяем 80h раз
0036+  CA8A 0D          		dcr	c
0037+  CA8B C2 81 CA    		jnz	fileExec_0
0038+  CA8E             
0039+  CA8E             fileExec_1:	; В конец имени помещаем 13,0
0040+  CA8E 3E 0D       		mvi	a, 0Dh
0041+  CA90 12          		stax	d
0042+  CA91 AF          		xra	a
0043+  CA92 13          		inx	d
0044+  CA93 12          		stax	d
0045+  CA94             
0046+  CA94             		; Выводим на экран 0
0047+  CA94 CD E2 CA    		call	printCharA
0048+  CA97             
0049+  CA97             		; Вывод имени файла на экран
0050+  CA97 21 00 FF    		lxi	h, v_cmdLine
0051+  CA9A CD 18 C8    		call	j_printString
0052+  CA9D             
0053+  CA9D             		; Подготовка имени файла
0054+  CA9D 21 00 FF    		lxi	h, v_cmdLine
0055+  CAA0 11 AD CE    		lxi	d, v_fileName
0056+  CAA3 CD DB CD    		call	fileNamePrepare
0057+  CAA6             
0058+  CAA6 E5          		push	h
0059+  CAA7             
0060+  CAA7             		; Если это BAT-файл
0061+  CAA7 11 A4 CE    		lxi	d, aBat		; "BAT"
0062+  CAAA CD E7 CA    		call	cmpFileExt
0063+  CAAD CA 22 CA    		jz	execBat
0064+  CAB0             
0065+  CAB0             		; Если это COM или EXE файл
0066+  CAB0 CD E7 CA    		call	cmpFileExt
0067+  CAB3 CA BC CA    		jz	loc_CAB6
0068+  CAB6 CD E7 CA    		call	cmpFileExt
0069+  CAB9 C2 D9 CA    		jnz	loc_CAD3
0070+  CABC             loc_CAB6:	
0071+  CABC D1          		pop	d
0072+  CABD             
0073+  CABD             		; Загрузить файл
0074+  CABD 21 AD CE    		lxi	h, v_fileName
0075+  CAC0 CD D9 CC    		call	fileLoad
0076+  CAC3 DA DA CA    		jc	badCommand
0077+  CAC6             
0078+  CAC6 D5          		push	d
0079+  CAC7             
0080+  CAC7 CD E2 CA    		call	printCharA
0081+  CACA             
0082+  CACA             		; Получаем адрес загрузки файла
0083+  CACA 11 0A 00    		lxi	d, 10
0084+  CACD 19          		dad	d
0085+  CACE 5E          		mov	e, m
0086+  CACF 23          		inx	h
0087+  CAD0 56          		mov	d, m
0088+  CAD1             
0089+  CAD1             		; Адрес возврата
0090+  CAD1 21 D7 CA    		lxi	h, loc_CAD1
0091+  CAD4 E3          		xthl
0092+  CAD5             
0093+  CAD5             		; Перейти на DE
0094+  CAD5 EB          		xchg
0095+  CAD6 E9          		pchl
0096+  CAD7             
0097+  CAD7             ; ---------------------------------------------------------------------------
0098+  CAD7             
0099+  CAD7 B7          loc_CAD1:	ora	a
0100+  CAD8 C9          		ret
0101+  CAD9             
0102+  CAD9             ; ---------------------------------------------------------------------------
0103+  CAD9             
0104+  CAD9 D1          loc_CAD3:	pop	d
0105+  CADA 21 55 CE    badCommand:	lxi	h, aBadCommandOrFi ; "\nBAD COMMAND OR FILE NAME"
0106+  CADD CD 18 C8    		call	j_printString		                     
0107+  CAE0 37          stc_ret:	stc
0108+  CAE1 C9          		ret
0109+  CAE2             
0110+  CAE2             ; ---------------------------------------------------------------------------
0111+  CAE2             
0112+  CAE2 0E 0A       printCharA:	mvi	c, 0Ah
0113+  CAE4 C3 09 C8    		jmp	j_printChar		0195   CAE7             .include "fileCmpExt.inc"
0001+  CAE7             ;+---------------------------------------------------------------------------
0002+  CAE7             ; MXOS
0003+  CAE7             ; Сранивать расширения файлов
0004+  CAE7             ;
0005+  CAE7             ; На входе
0006+  CAE7             ;  de - адрес расширения 1
0007+  CAE7             ;  v_fileName_ext - расширение 2
0008+  CAE7             ;
0009+  CAE7             ; На выходе
0010+  CAE7             ;  zf=0 - расширения равны
0011+  CAE7             ;  de - de+3
0012+  CAE7             ;
0013+  CAE7             ; 2013-12-12 Дизассемблировано vinxru
0014+  CAE7             ;----------------------------------------------------------------------------
0015+  CAE7             
0016+  CAE7 21 B3 CE    cmpFileExt:	lxi	h, v_fileName_ext
0017+  CAEA             
0018+  CAEA             		; Сравниваем 3 символа
0019+  CAEA 01 03 00                    lxi	b, 3
0020+  CAED 1A          cmpFileExt_0:	ldax	d
0021+  CAEE BE          		cmp	m
0022+  CAEF C2 F8 CA    		jnz	cmpFileExt_1
0023+  CAF2 23          		inx	h
0024+  CAF3 13          		inx	d
0025+  CAF4 0D          		dcr	c
0026+  CAF5 C2 ED CA    		jnz	cmpFileExt_0
0027+  CAF8             
0028+  CAF8             		; ZF=1 если равны
0029+  CAF8             
0030+  CAF8             cmpFileExt_1:	; Делаем так, что бы DE на выходе функции был на 3 больше, 
0031+  CAF8             		; чем на входе в функцию
0032+  CAF8 F5          		push	psw
0033+  CAF9 EB          		xchg
0034+  CAFA 09          		dad	b
0035+  CAFB EB          		xchg
0036+  CAFC F1          		pop	psw
0037+  CAFD             
0038+  CAFD             		; Выход
0039+  CAFD C9          		ret0196   CAFE             .include "driver_FFC0.inc"
0001+  CAFE             ;+---------------------------------------------------------------------------
0002+  CAFE             ; MXOS
0003+  CAFE             ; Драйвер диска в ДОЗУ, ПЗУ (часть находящаяся по адресу 0FFC0h)
0004+  CAFE             ;
0005+  CAFE             ; 2013-12-12 Дизассемблировано и доработано vinxru
0006+  CAFE             ;----------------------------------------------------------------------------
0007+  CAFE             
0008+  CAFE~            #if BIG_MEM==0
0009+  CAFE~            
0010+  CAFE~            ; ---------------------------------------------------------------------------
0011+  CAFE~            ; Чтение 256-байтного блока с диска
0012+  CAFE~            
0013+  CAFE~            driverStart:	
0014+  CAFE~            driverR:	sta	IO_ARAM		; Сюда встает STA IO_ROM для ROM-диска
0015+  CAFE~            		ldax	d
0016+  CAFE~            		sta	IO_RAM
0017+  CAFE~            		mov	m, a
0018+  CAFE~            		inx	h
0019+  CAFE~            		inr	e
0020+  CAFE~            		jnz	0FFC0h
0021+  CAFE~            		ret
0022+  CAFE~            
0023+  CAFE~            ; ---------------------------------------------------------------------------
0024+  CAFE~            
0025+  CAFE~            		.db 0FFh
0026+  CAFE~            		.db 0FFh
0027+  CAFE~            
0028+  CAFE~            ; ---------------------------------------------------------------------------
0029+  CAFE~            ; Запись 256-байтного блока на диск
0030+  CAFE~            
0031+  CAFE~            driverW:	mov	a, m		; Сюда встает RET для ROM-диска
0032+  CAFE~            		sta	IO_ARAM
0033+  CAFE~            		stax	d
0034+  CAFE~            		sta	IO_RAM
0035+  CAFE~            		inx	h
0036+  CAFE~            		inr	e
0037+  CAFE~            		jnz	0FFD0h
0038+  CAFE~            driverEnd:	ret
0039+  CAFE~            
0040+  CAFE             #else
0041+  CAFE             
0042+  CAFE             ; ---------------------------------------------------------------------------
0043+  CAFE             ; Чтение 256-байтного блока с диска
0044+  CAFE             
0045+  CAFE 79          driverStart:	mov 	a, c
0046+  CAFF 32 FD FF    driverR:	sta	IO_ARAM		; Сюда встает STA IO_ROM для ROM-диска
0047+  CB02 1A          		ldax	d
0048+  CB03 32 FC FF    		sta	IO_RAM
0049+  CB06 77          		mov	m, a
0050+  CB07 23          		inx	h
0051+  CB08 1C          		inr	e
0052+  CB09 C2 C0 FF    		jnz	0FFC0h
0053+  CB0C C9          		ret
0054+  CB0D             
0055+  CB0D             ; ---------------------------------------------------------------------------
0056+  CB0D             ; Запись 256-байтного блока на диск
0057+  CB0D             
0058+  CB0D 23          loc_FFCF:	inx	h
0059+  CB0E             loc_FFD0:
0060+  CB0E 46          driverW:	mov	b, m		; Сюда встает RET для ROM-диска
0061+  CB0F 79          		mov 	a, c
0062+  CB10 32 FD FF    		sta	IO_ARAM
0063+  CB13 78          		mov	a, b
0064+  CB14 12          		stax	d
0065+  CB15 32 FC FF    		sta	IO_RAM
0066+  CB18 1C          		inr	e
0067+  CB19 C2 CF FF    		jnz	0FFCFh
0068+  CB1C C9          driverEnd:	ret
0069+  CB1D             
0070+  CB1D             ; ---------------------------------------------------------------------------
0071+  CB1D             ; Проверка
0072+  CB1D             
0073+  CB1D~            #if loc_FFD0-driverStart+0FFC0h != 0FFD0h
0074+  CB1D~            ’®зЄ _ўе®¤ _FFD0_б¬ҐбвЁ« бм
0075+  CB1D             #endif
0076+  CB1D             
0077+  CB1D~            #if driverEnd-driverStart+1 > 32
0078+  CB1D~            „а ©ўҐа_­Ґ_ў«Ґ§
0079+  CB1D             #endif
0080+  CB1D             
0081+  CB1D             #endif0197   CB1D             .include "driver.inc"
0001+  CB1D             ;+---------------------------------------------------------------------------
0002+  CB1D             ; MXOS
0003+  CB1D             ; Драйвер диска в ДОЗУ, ПЗУ
0004+  CB1D             ;
0005+  CB1D             ; Запись 256-байтного блока
0006+  CB1D             ;   На входе
0007+  CB1D             ;     e - 1
0008+  CB1D             ;     d - номер блока 
0009+  CB1D             ;     hl - адрес буфера в памяти
0010+  CB1D             ;   На выходе
0011+  CB1D             ;     все регистры сохраняются
0012+  CB1D             ;
0013+  CB1D             ; Чтение 256-байтного блока
0014+  CB1D             ;   На входе
0015+  CB1D             ;     e - 2
0016+  CB1D             ;     d - номер блока 
0017+  CB1D             ;     hl - адрес буфера в памяти
0018+  CB1D             ;   На выходе
0019+  CB1D             ;     все регистры сохраняются
0020+  CB1D             ;
0021+  CB1D             ; Получение размера накопителя
0022+  CB1D             ;   На входе
0023+  CB1D             ;     e - 3
0024+  CB1D             ;   На выходе
0025+  CB1D             ;     a - кол-во секторов на диске (для функции e=0)
0026+  CB1D             ;     bc, de, hl - сохраняются
0027+  CB1D             ;
0028+  CB1D             ; 2013-12-12 Дизассемблировано и доработано vinxru
0029+  CB1D             ;----------------------------------------------------------------------------
0030+  CB1D             
0031+  CB1D             #if START_FROM_RAM
0032+  CB1D             ROM_SIZE = 70h
0033+  CB1D~            #else
0034+  CB1D~            #if ROM_64K
0035+  CB1D~            ROM_SIZE = 0
0036+  CB1D~            #else
0037+  CB1D~            ROM_SIZE = 0C0h
0038+  CB1D~            #endif
0039+  CB1D             #endif
0040+  CB1D             
0041+  CB1D             diskDriver:	; Сохраняем регистры
0042+  CB1D E5          		push	h
0043+  CB1E             #if BIG_MEM
0044+  CB1E C5          		push	b		; +1
0045+  CB1F             #endif
0046+  CB1F D5          		push	d
0047+  CB20 F5          		push	psw
0048+  CB21             
0049+  CB21             		; Заранее загружаем в С активный диск
0050+  CB21             #if BIG_MEM
0051+  CB21 3A 81 CE    		lda	v_drive		; +4
0052+  CB24 4F          		mov	c, a		; +5
0053+  CB25 0D          		dcr	c		; +6
0054+  CB26             #endif
0055+  CB26             		; Функция 1 - Запись блока
0056+  CB26 1D          		dcr	e
0057+  CB27 CA 6D CB    		jz	diskDriver_w
0058+  CB2A             
0059+  CB2A             		; Функция 2 - Чтение блока
0060+  CB2A 1D          		dcr	e
0061+  CB2B CA 3A CB    		jz	diskDriver_r
0062+  CB2E             		
0063+  CB2E             		; Функция 3 - Получение размера диска
0064+  CB2E F1          		pop	psw		
0065+  CB2F~            #if BIG_MEM==0
0066+  CB2F~            		lda	v_drive         ; +3
0067+  CB2F~            		ana	a
0068+  CB2F~            		mvi	a, ROM_SIZE
0069+  CB2F             #else
0070+  CB2F 0C          		inr	c
0071+  CB30 3E 70       		mvi	a, ROM_SIZE
0072+  CB32             #endif
0073+  CB32 CA 37 CB    		jz	diskDriver_1
0074+  CB35 3E FF       		mvi	a, 0FFh		; Размер RAM-диска 64K-256
0075+  CB37             diskDriver_1:		
0076+  CB37             		; Восстановливаем регистры и выходим
0077+  CB37             #if BIG_MEM
0078+  CB37 C3 18 CC    		jmp	pop_dbh_ret
0079+  CB3A~            #else
0080+  CB3A~            		pop	d
0081+  CB3A~            		pop	h
0082+  CB3A~            		ret
0083+  CB3A             #endif
0084+  CB3A             		
0085+  CB3A             ; ---------------------------------------------------------------------------
0086+  CB3A             ; Функция 2 - Чтение блока
0087+  CB3A             
0088+  CB3A             diskDriver_r:	
0089+  CB3A             #if ROM_64K
0090+  CB3A             		; Это ПЗУ
0091+  CB3A 0C          		inr	c
0092+  CB3B C2 65 CB    		jnz	rom_64k
0093+  CB3E             		; Это старшая часть ПЗУ
0094+  CB3E 3E 80       		mvi	a, 80h
0095+  CB40 AA          		xra	d
0096+  CB41 FA 65 CB    		jm	rom_64k
0097+  CB44             		; 
0098+  CB44 57          		mov	d, a
0099+  CB45             		; Первые 4 байта в ПЗУ СТД это программа инициаизации
0100+  CB45 13          		inx	d
0101+  CB46 13          		inx	d
0102+  CB47 13          		inx	d
0103+  CB48 13          		inx	d
0104+  CB49             		; Включаем ПЗУ СТД (да, надо регистр цвета сбросить для этого)
0105+  CB49 AF          		xra	a
0106+  CB4A 32 F8 FF    		sta	IO_COLOR
0107+  CB4D             		; Включаем ПЗУ СТД
0108+  CB4D 32 FF FF    rom_64k_0:	sta	IO_PAGE_STD
0109+  CB50             		; Чтение
0110+  CB50 1A          		ldax	d
0111+  CB51             		; Включение ОЗУ MX
0112+  CB51 32 FC F7    		sta	IO_RAM-800h
0113+  CB54             		; Запись
0114+  CB54 77          		mov	m, a
0115+  CB55 23          		inx	h
0116+  CB56             		; Цикл
0117+  CB56 13          		inx	d
0118+  CB57 3E 04       		mvi	a, 4
0119+  CB59 BB          		cmp	e
0120+  CB5A C2 4D CB    		jnz	rom_64k_0
0121+  CB5D             		; Восстаналиваем цвет
0122+  CB5D 3E 70       		mvi	a, INIT_COLOR
0123+  CB5F 32 F8 FF    		sta	IO_COLOR
0124+  CB62             		; Выходим
0125+  CB62 C3 69 CB    		jmp	popa_adh_ret
0126+  CB65             		
0127+  CB65 0D          rom_64k:	dcr	c
0128+  CB66             #endif
0129+  CB66~            #if BIG_MEM==0
0130+  CB66~            		; Не нужно, тут и так E=0
0131+  CB66~            		mvi	e, 0		;+1
0132+  CB66             #endif
0133+  CB66 CD C0 FF    		call	0FFC0h
0134+  CB69             
0135+  CB69             popa_adh_ret:	; Восстанавливаем регистры и выходим
0136+  CB69 F1          		pop	psw
0137+  CB6A             #if BIG_MEM
0138+  CB6A C3 18 CC    		jmp	pop_dbh_ret
0139+  CB6D~            #else
0140+  CB6D~            		pop	d
0141+  CB6D~            		pop	h
0142+  CB6D~            		ret
0143+  CB6D             #endif
0144+  CB6D             
0145+  CB6D             ; ---------------------------------------------------------------------------
0146+  CB6D             ; Функция 1 - Запись блока
0147+  CB6D             
0148+  CB6D             diskDriver_w:	
0149+  CB6D~            #if BIG_MEM==0
0150+  CB6D~            		; Не нужно, тут и так E=0
0151+  CB6D~            		mvi	e, 0		;-1 у нас лишний байт в драйвере
0152+  CB6D             #endif
0153+  CB6D CD D0 FF    		call	0FFD0h
0154+  CB70             
0155+  CB70             		; Восстановливаем регистры и выходим
0156+  CB70 C3 69 CB    		jmp	popa_adh_ret0198   CB73             .include "installDriver.inc"
0001+  CB73             ;+---------------------------------------------------------------------------
0002+  CB73             ; MXOS
0003+  CB73             ; Установить драйвер устройства
0004+  CB73             ;
0005+  CB73             ; На входе
0006+  CB73             ;  a - диск
0007+  CB73             ;  hl - адрес драйвера
0008+  CB73             ;
0009+  CB73             ; На выходе
0010+  CB73             ;  bc, de, hl - сохраняются
0011+  CB73             ;
0012+  CB73             ; 2013-12-12 Дизассемблировано vinxru
0013+  CB73             ;----------------------------------------------------------------------------
0014+  CB73             
0015+  CB73             installDriver:	; Сохранение регистров
0016+  CB73 D5          		push	d
0017+  CB74 E5          		push	h
0018+  CB75             
0019+  CB75             		; Максимум дисков
0020+  CB75 E6 07       		ani	7
0021+  CB77             
0022+  CB77             		; Вычисление адреса в таблице дисков
0023+  CB77 87          		add	a
0024+  CB78 6F          		mov	l, a
0025+  CB79 26 00       		mvi	h, 0
0026+  CB7B 11 6F CE    		lxi	d, v_drives
0027+  CB7E 19          		dad	d
0028+  CB7F             
0029+  CB7F             		; Установка драйвера
0030+  CB7F D1          		pop	d
0031+  CB80 73          		mov	m, e
0032+  CB81 23          		inx	h
0033+  CB82 72          		mov	m, d
0034+  CB83             
0035+  CB83             		; Восстановление регистров
0036+  CB83 EB          		xchg
0037+  CB84 D1          		pop	d
0038+  CB85 0F          		rrc
0039+  CB86             
0040+  CB86             		; Выход
0041+  CB86 C9          		ret		0199   CB87             .include "fileGetSetDrive.inc"
0001+  CB87             ;+---------------------------------------------------------------------------
0002+  CB87             ; MXOS
0003+  CB87             ; Получение/изменение текущего накопителя
0004+  CB87             ;
0005+  CB87             ; На входе 
0006+  CB87             ;   e  - 0=чтение, 1=изменение
0007+  CB87             ;   a  - накопитель от 0 до 7
0008+  CB87             ;
0009+  CB87             ; На выходе 
0010+  CB87             ;   a  - накопитель
0011+  CB87             ;   bc,de,hl - сохраняются
0012+  CB87             ;
0013+  CB87             ; 2013-12-12 Дизассемблировано vinxru
0014+  CB87             ;----------------------------------------------------------------------------
0015+  CB87             
0016+  CB87             fileGetSetDrive:
0017+  CB87 1D          		dcr	e
0018+  CB88 CA 8F CB    		jz	fileSelectDrive
0019+  CB8B 3A 81 CE    		lda	v_drive
0020+  CB8E C9          		ret
0021+  CB8F             
0022+  CB8F             ; ---------------------------------------------------------------------------
0023+  CB8F             
0024+  CB8F             fileSelectDrive:; Максимум устройств
0025+  CB8F E6 07       		ani	7
0026+  CB91             
0027+  CB91             		; Сохраняем выбранное устройство
0028+  CB91 32 81 CE    		sta	v_drive
0029+  CB94             
0030+  CB94             		; Пригодится ниже (a = a * 2)
0031+  CB94 87          		add	a
0032+  CB95             
0033+  CB95             		; Сохраняем регистры
0034+  CB95 E5          		push	h
0035+  CB96 D5          		push	d
0036+  CB97             
0037+  CB97             		; Получаем точку входа драйвера
0038+  CB97 6F          		mov	l, a
0039+  CB98 26 00       		mvi	h, 0
0040+  CB9A 11 6F CE    		lxi	d, v_drives
0041+  CB9D 19          		dad	d
0042+  CB9E 5E          		mov	e, m
0043+  CB9F 23          		inx	h
0044+  CBA0 56          		mov	d, m
0045+  CBA1 EB          		xchg
0046+  CBA2             
0047+  CBA2             		; Сохраняем её
0048+  CBA2 22 64 C8    		shld	j_diskDriver+1
0049+  CBA5             
0050+  CBA5             		; Восстаналвиаем A
0051+  CBA5 0F          		rrc
0052+  CBA6             
0053+  CBA6             .include "driver_sel.inc"
0001++ CBA6             ;+---------------------------------------------------------------------------
0002++ CBA6             ; MXOS
0003++ CBA6             ; Драйвер диска в ДОЗУ, ПЗУ. Вызывается при смене диска.
0004++ CBA6             ;
0005++ CBA6             ; 2013-12-12 Дизассемблировано и доработано vinxru
0006++ CBA6             ;----------------------------------------------------------------------------
0007++ CBA6             
0008++ CBA6             		; Cохраняем A в E
0009++ CBA6 5F          		mov	e, a
0010++ CBA7             
0011++ CBA7             		; Корректируем стандартный драйвер.
0012++ CBA7             		; Если это диск 0 - то работаем с ПЗУ, иначе с ДОЗУ.
0013++ CBA7 A7          		ana	a
0014++ CBA8             #if START_FROM_RAM
0015++ CBA8 3E FC       		mvi	a, IO_RAM & 0FFh	; STA IO_RAM
0016++ CBAA~            #else
0017++ CBAA~            		mvi	a, IO_ROM & 0FFh	; STA IO_ROM
0018++ CBAA             #endif
0019++ CBAA 2E C9       		mvi	l, 0C9h			; RET
0020++ CBAC             
0021++ CBAC CA B3 CB    		jz	disableRom_2
0022++ CBAF             #if BIG_MEM
0023++ CBAF 2E 46       		 mvi	l, 46h			; MOV B, M
0024++ CBB1~            #else
0025++ CBB1~            		 mvi	l, 7Eh			; MOV A, M
0026++ CBB1             #endif
0027++ CBB1 3E FD       		 mvi	a, IO_ARAM & 0FFh	; STA IO_ARAM
0028++ CBB3 32 C2 FF    disableRom_2:	sta	0FFC0h + (driverR - driverStart) + 1
0029++ CBB6 7D          		mov	a, l
0030++ CBB7 32 D0 FF    		sta	0FFC0h + (driverW - driverStart)
0031++ CBBA             
0032++ CBBA             		; Восстанавливаем A из E
0033++ CBBA 7B          		mov	a, e0054+  CBBB             
0055+  CBBB             		; Восстанавливаем регистры и выходим
0056+  CBBB D1          		pop	d
0057+  CBBC E1          		pop	h
0058+  CBBD C9          		ret
0200   CBBE             .include "loadSaveFatDir.inc"
0001+  CBBE             ;+---------------------------------------------------------------------------
0002+  CBBE             ; MXOS
0003+  CBBE             ; Сохранить FAT и корневой каталог на устройство
0004+  CBBE             ;
0005+  CBBE             ; На выходе
0006+  CBBE             ;  регистры bc,de,hl сохраняются
0007+  CBBE             ;
0008+  CBBE             ; 2013-12-12 Дизассемблировано vinxru
0009+  CBBE             ;----------------------------------------------------------------------------
0010+  CBBE             
0011+  CBBE             saveFatDir:	; Сохраняем регистры
0012+  CBBE D5          		push	d
0013+  CBBF             
0014+  CBBF             		; Режим - запись
0015+  CBBF 1E 01       		mvi	e, 1	
0016+  CBC1             
0017+  CBC1             		; Переход к общему коду			
0018+  CBC1 C3 C7 CB    		jmp	loadFatDir_0
0019+  CBC4             
0020+  CBC4             ;----------------------------------------------------------------------------
0021+  CBC4             ; Загрузить FAT и корневой каталог с устройства
0022+  CBC4             ;
0023+  CBC4             ; На выходе
0024+  CBC4             ;  регистры bc,de,hl сохраняются
0025+  CBC4             ;----------------------------------------------------------------------------
0026+  CBC4             
0027+  CBC4             loadFatDir:	; Сохраняем регистры
0028+  CBC4 D5          		push	d
0029+  CBC5             
0030+  CBC5             		; Режим - чтение
0031+  CBC5 1E 02       		mvi	e, 2
0032+  CBC7             
0033+  CBC7             loadFatDir_0:	; Сохраняем регистры
0034+  CBC7 E5          		push	h
0035+  CBC8             
0036+  CBC8             		; Чтение/запись 1024 байт с начала диска в FB00h
0037+  CBC8 21 00 FE    		lxi	h, diskDirectoryL
0038+  CBCB 16 03       		mvi	d, 3		; Сектор
0039+  CBCD CD 63 C8    loadFatDir_1:	 call	j_diskDriver
0040+  CBD0 25          		 dcr	h
0041+  CBD1 15          		 dcr	d
0042+  CBD2 F2 CD CB    		jp	loadFatDir_1
0043+  CBD5             
0044+  CBD5             		; Восстанавливаем регистры и выходим
0045+  CBD5 E1          		pop	h
0046+  CBD6 D1          		pop	d
0047+  CBD7 C9          		ret0201   CBD8             .include "fileFindCluster.inc"
0001+  CBD8             ;+---------------------------------------------------------------------------
0002+  CBD8             ; MXOS
0003+  CBD8             ; Поиск свободного кластера 
0004+  CBD8             ;
0005+  CBD8             ; На выходе
0006+  CBD8             ;  cf - ошибка
0007+  CBD8             ;  a - кластер
0008+  CBD8             ;  регистры BC,DE,HL сохраняются
0009+  CBD8             ;
0010+  CBD8             ; 2013-12-12 Дизассемблировано vinxru
0011+  CBD8             ;----------------------------------------------------------------------------
0012+  CBD8             
0013+  CBD8             fileFindClusterFirst:
0014+  CBD8             		; Сохраняем регистры
0015+  CBD8 E5          		push	h
0016+  CBD9             
0017+  CBD9             		; Начинаем поиск с первого кластера (первые 4 не используются)
0018+  CBD9 21 04 FB    		lxi	h,  fat + 4
0019+  CBDC C3 E3 CB    		jmp	fileFindClus_2
0020+  CBDF             
0021+  CBDF             ;----------------------------------------------------------------------------
0022+  CBDF             ; Продолжение поиска свободного кластера 
0023+  CBDF             ;
0024+  CBDF             ; На выходе
0025+  CBDF             ;  cf - ошибка
0026+  CBDF             ;  a - кластер
0027+  CBDF             ;  регистры BC,DE,HL сохраняются
0028+  CBDF             ;----------------------------------------------------------------------------
0029+  CBDF             
0030+  CBDF             fileFindClusterNext:
0031+  CBDF             		; Сохраняем регистры
0032+  CBDF E5          		push	h
0033+  CBE0             
0034+  CBE0             		; Начинаем поиск с этого кластера
0035+  CBE0 2A 7F CE    		lhld	v_findCluster
0036+  CBE3             
0037+  CBE3             		; Ищем свободный кластер
0038+  CBE3             		; В соответствующей ячейке таблицы FAT должен быть 0
0039+  CBE3 AF          fileFindClus_2:	xra	a
0040+  CBE4 BE          fileFindClus_0:	cmp	m
0041+  CBE5 CA F1 CB    		jz	fileFindClus_1	; Найден
0042+  CBE8 2C          		inr	l
0043+  CBE9 C2 E4 CB    		jnz	fileFindClus_0
0044+  CBEC             
0045+  CBEC             		; Восстаналиваем регистры и выходим A=1, CF=1, ZF=0
0046+  CBEC E1          		pop	h
0047+  CBED 3E 01       		mvi	a, 1
0048+  CBEF 37          		stc
0049+  CBF0 C9          		ret
0050+  CBF1             
0051+  CBF1             ; ---------------------------------------------------------------------------
0052+  CBF1             
0053+  CBF1             fileFindClus_1:	; Свобожный кластер найден
0054+  CBF1 7D          		mov	a, l
0055+  CBF2             
0056+  CBF2             		; Устаналиваем ZF=0. Номер кластера не может быть нулевым.
0057+  CBF2             		; В случае ошибки мы то же выходим с ZF=1
0058+  CBF2 B7          		ora	a
0059+  CBF3             
0060+  CBF3             		; Для ускорения поиска сохраняем номер следующего кластера в v_findCluster
0061+  CBF3 2C          		inr	l
0062+  CBF4 22 7F CE    		shld	v_findCluster
0063+  CBF7             
0064+  CBF7             		; Восстанавливаем регистры и выходим с CF=0, ZF=0
0065+  CBF7 E1          		pop	h
0066+  CBF8 C9          		ret0202   CBF9             .include "fileCreate.inc"
0001+  CBF9             ;----------------------------------------------------------------------------
0002+  CBF9             ; MXOS
0003+  CBF9             ; Создать файл
0004+  CBF9             ;
0005+  CBF9             ; На входе
0006+  CBF9             ;  hl - имя файла и информация (всё в формате записи каталога)
0007+  CBF9             ;
0008+  CBF9             ; На выходе
0009+  CBF9             ;  сf - ошибка
0010+  CBF9             ;
0011+  CBF9             ; 2013-12-12 Дизассемблировано vinxru
0012+  CBF9             ;----------------------------------------------------------------------------
0013+  CBF9             
0014+  CBF9             fileCreate:	; Сохраняем регистры
0015+  CBF9 E5          		push	h
0016+  CBFA C5          		push	b
0017+  CBFB D5          		push	d
0018+  CBFC             
0019+  CBFC             		; Если файл существует, то удаляем его
0020+  CBFC CD 90 CC    		call	fileFind
0021+  CBFF D4 31 CD    		cnc	deleteFileInt
0022+  CC02             
0023+  CC02             		; Сохраняем готовую запись каталога
0024+  CC02 E5          		push	h
0025+  CC03             
0026+  CC03             		; Ищем свободную запись в каталоге
0027+  CC03 21 00 FC    		lxi	h, diskDirectory	; Адрес каталога
0028+  CC06 11 10 00    		lxi	d, 16			; Размер записи в каталоге
0029+  CC09 06 30       		mvi	b, 48			; Максимум файлов
0030+  CC0B 7E          fileCreate_0:	mov	a, m
0031+  CC0C 3C          		inr	a
0032+  CC0D CA 1C CC    		jz	fileCreate_1		; Свободная запись найдена
0033+  CC10 19          		dad	d
0034+  CC11 05          		dcr	b
0035+  CC12 C2 0B CC    		jnz	fileCreate_0
0036+  CC15             
0037+  CC15             		; Свободных записей нет
0038+  CC15             
0039+  CC15             		; Освобождаем стек
0040+  CC15 E1          		pop	h
0041+  CC16             
0042+  CC16             		; Установка A=0, ZF=1
0043+  CC16 AF          		xra	a		
0044+  CC17             
0045+  CC17             stc_pop_dbh_ret:; Установка флага CF=1
0046+  CC17 37          		stc
0047+  CC18             
0048+  CC18             pop_dbh_ret:	; Восстановление регистров и выход
0049+  CC18 D1          		pop	d
0050+  CC19 C1          		pop	b
0051+  CC1A E1          		pop	h
0052+  CC1B C9          		ret
0053+  CC1C             
0054+  CC1C             ; ---------------------------------------------------------------------------
0055+  CC1C             ; Свободная запись найдена
0056+  CC1C             
0057+  CC1C             fileCreate_1:	; Адрес свободной записи в DE
0058+  CC1C EB          		xchg
0059+  CC1D             
0060+  CC1D             		; Готовая запись каталога в HL
0061+  CC1D E1          		pop	h
0062+  CC1E             
0063+  CC1E             		; Копируем готовую запись в каталог 
0064+  CC1E 0E 0E       		mvi	c, 14
0065+  CC20 7E          fileCreate_2:	mov	a, m
0066+  CC21 12          		stax	d
0067+  CC22 23          		inx	h
0068+  CC23 13          		inx	d
0069+  CC24 0D          		dcr	c
0070+  CC25 C2 20 CC    		jnz	fileCreate_2
0071+  CC28             
0072+  CC28             		; Сохраняем адрес созданного файла
0073+  CC28 EB          		xchg
0074+  CC29 22 84 CE    		shld	v_createdFile
0075+  CC2C             			
0076+  CC2C             		; Ищем свободный кластер
0077+  CC2C CD D8 CB    		call	fileFindClusterFirst
0078+  CC2F DA 17 CC    		jc	stc_pop_dbh_ret
0079+  CC32             
0080+  CC32 F5          		push	psw
0081+  CC33             
0082+  CC33             		; Сохраняем в каталог адрес первого кластера
0083+  CC33 23          		inx	h
0084+  CC34 77          		mov	m, a ; [15]
0085+  CC35             
0086+  CC35             		; Читаем длину
0087+  CC35 2B          		dcx	h
0088+  CC36 2B          		dcx	h
0089+  CC37 56          		mov	d, m ; [13]
0090+  CC38 2B          		dcx	h
0091+  CC39 5E          		mov	e, m ; [12]
0092+  CC3A             
0093+  CC3A             		; Читаем адрес
0094+  CC3A 2B          		dcx	h
0095+  CC3B 46          		mov	b, m ; [11]
0096+  CC3C 2B          		dcx	h
0097+  CC3D 6E          		mov	l, m ; [10]
0098+  CC3E             
0099+  CC3E             		; Сохраняем адрес
0100+  CC3E 60          		mov	h, b
0101+  CC3F 22 82 CE    		shld	v_input_start
0102+  CC42             
0103+  CC42             		; Сохраняем длину
0104+  CC42 EB          		xchg
0105+  CC43 22 88 CE    		shld	v_input_end
0106+  CC46             
0107+  CC46             		; ?
0108+  CC46 44          		mov	b, h
0109+  CC47 04          		inr	b
0110+  CC48 26 FB       		mvi	h, 0FBh
0111+  CC4A             
0112+  CC4A             		; Первый кластер файла
0113+  CC4A F1          		pop	psw
0114+  CC4B 4F          		mov	c, a
0115+  CC4C 6F          		mov	l, a
0116+  CC4D             
0117+  CC4D C3 56 CC    		jmp	loc_CC24
0118+  CC50             
0119+  CC50             ; ---------------------------------------------------------------------------
0120+  CC50             
0121+  CC50 CD DF CB    allocClusters:	call	fileFindClusterNext
0122+  CC53 DA 17 CC    		jc	stc_pop_dbh_ret		
0123+  CC56 77          loc_CC24:	mov	m, a
0124+  CC57 6F          		mov	l, a
0125+  CC58 05          		dcr	b
0126+  CC59 C2 50 CC    		jnz	allocClusters
0127+  CC5C 75          		mov	m, l		
0128+  CC5D 06 FB       		mvi	b, 0FBh
0129+  CC5F EB          		xchg
0130+  CC60 1E 01       		mvi	e, 1		
0131+  CC62 51          loc_CC30:	mov	d, c
0132+  CC63 CD 63 C8    		call	j_diskDriver
0133+  CC66 24          		inr	h
0134+  CC67 0A          		ldax	b
0135+  CC68 B9          		cmp	c
0136+  CC69 4F          		mov	c, a
0137+  CC6A C2 62 CC    		jnz	loc_CC30		
0138+  CC6D 2A 88 CE    		lhld	v_input_end
0139+  CC70 23          		inx	h
0140+  CC71 EB          		xchg
0141+  CC72 2A 82 CE    		lhld	v_input_start
0142+  CC75 06 00       		mvi	b, 0		
0143+  CC77 7A          loc_CC45:	mov	a, d
0144+  CC78 B3          		ora	e
0145+  CC79 CA 84 CC    		jz	loc_CC52
0146+  CC7C 7E          		mov	a, m
0147+  CC7D 80          		add	b
0148+  CC7E 47          		mov	b, a
0149+  CC7F 23          		inx	h
0150+  CC80 1B          		dcx	d
0151+  CC81 C3 77 CC    		jmp	loc_CC45
0152+  CC84             
0153+  CC84             ; ---------------------------------------------------------------------------
0154+  CC84             
0155+  CC84 78          loc_CC52:	mov	a, b
0156+  CC85 2A 84 CE    		lhld	v_createdFile
0157+  CC88 77          		mov	m, a
0158+  CC89 CD BE CB    		call	saveFatDir
0159+  CC8C B7          		ora	a
0160+  CC8D C3 18 CC    		jmp	pop_dbh_ret0203   CC90             .include "fileFind.inc"
0001+  CC90             ;+---------------------------------------------------------------------------
0002+  CC90             ; MXOS
0003+  CC90             ; Найти файл
0004+  CC90             ;
0005+  CC90             ; На входе
0006+  CC90             ;  hl - имя
0007+  CC90             ;
0008+  CC90             ; На выходе
0009+  CC90             ;  bc,de,hl - сохраняются
0010+  CC90             ;  cf - ошибка
0011+  CC90             ;  v_foundedFile - найденный файл
0012+  CC90             ;
0013+  CC90             ; 2013-12-12 Дизассемблировано vinxru
0014+  CC90             ;----------------------------------------------------------------------------
0015+  CC90             
0016+  CC90             fileFind:	; Загрузка FAT и корневого каталога в память
0017+  CC90 CD C4 CB    		call	loadFatDir
0018+  CC93             
0019+  CC93             fileFind2:	; Сохраняем регистры
0020+  CC93 C5          		push	b
0021+  CC94 D5          		push	d
0022+  CC95             
0023+  CC95             		; Начало каталога
0024+  CC95 11 00 FC    		lxi	d, diskDirectory
0025+  CC98             
0026+  CC98             		; Кол-во файлов в каталоге
0027+  CC98 06 30       		mvi	b, 48
0028+  CC9A             
0029+  CC9A             fileFind_loop:	; Сохраняем адрес начала имени в каталоге и образец
0030+  CC9A E5          		push	h
0031+  CC9B D5          		push	d
0032+  CC9C             
0033+  CC9C             		; Если первый символ имени 0FFh, переходим к следующем файлу
0034+  CC9C 1A          		ldax	d
0035+  CC9D 3C          		inr	a
0036+  CC9E CA B7 CC    		jz	fileFind_next
0037+  CCA1             
0038+  CCA1             		; Длина имени 9 символов
0039+  CCA1 0E 09       		mvi	c, 9
0040+  CCA3             
0041+  CCA3             fileFind_name:	; Если символы не равны, переходим к следующему файлу
0042+  CCA3 1A          		ldax	d
0043+  CCA4 BE          		cmp	m
0044+  CCA5 C2 B7 CC    		jnz	fileFind_next
0045+  CCA8 23          		inx	h
0046+  CCA9 13          		inx	d
0047+  CCAA             
0048+  CCAA             		; Цикл
0049+  CCAA 0D          		dcr	c
0050+  CCAB C2 A3 CC    		jnz	fileFind_name
0051+  CCAE             
0052+  CCAE             		; Сохраняем адрес найденного файла
0053+  CCAE E1          		pop	h
0054+  CCAF 22 86 CE    		shld	v_foundedFile
0055+  CCB2             
0056+  CCB2             		; Восстаналиваем регистры и выходим с CF=0
0057+  CCB2 E1          		pop	h
0058+  CCB3 B7          		ora	a	; х.з.
0059+  CCB4 D1          		pop	d
0060+  CCB5 C1          		pop	b
0061+  CCB6 C9          		ret
0062+  CCB7             
0063+  CCB7             ; ---------------------------------------------------------------------------
0064+  CCB7             
0065+  CCB7             fileFind_next:	; Вычисляем адрес следующего файла
0066+  CCB7 D1          		pop	d
0067+  CCB8 21 10 00    		lxi	h, 10h
0068+  CCBB 19          		dad	d
0069+  CCBC EB          		xchg
0070+  CCBD             
0071+  CCBD             		; Восстанавливаем образец
0072+  CCBD E1          		pop	h
0073+  CCBE             
0074+  CCBE             		; Еще остались файлы?
0075+  CCBE 05          		dcr	b
0076+  CCBF C2 9A CC    		jnz	fileFind_loop
0077+  CCC2             
0078+  CCC2             		; Восстаналиваем регистры и выходим с CF=1 и A=3
0079+  CCC2 D1          		pop	d
0080+  CCC3 C1          		pop	b
0081+  CCC4 3E 03       		mvi	a, 3
0082+  CCC6 37          		stc
0083+  CCC7 C9          		ret0204   CCC8             .include "fileLoad.inc"
0001+  CCC8             ;+---------------------------------------------------------------------------
0002+  CCC8             ; MXOS
0003+  CCC8             ; Загрузить файл
0004+  CCC8             ;
0005+  CCC8             ; На входе
0006+  CCC8             ;  hl - имя
0007+  CCC8             ;  de - адрес загрузки
0008+  CCC8             ;
0009+  CCC8             ; На выходе
0010+  CCC8             ;  bc,de,hl - сохраняются
0011+  CCC8             ;  v_foundedFile - найденный файл
0012+  CCC8             ;  cf - ошибка
0013+  CCC8             ;
0014+  CCC8             ; 2013-12-12 Дизассемблировано vinxru
0015+  CCC8             ;----------------------------------------------------------------------------
0016+  CCC8             
0017+  CCC8             fileLoad2:	; Ищем файл с именем в HL
0018+  CCC8 CD 93 CC    		call	fileFind2
0019+  CCCB D8          		rc
0020+  CCCC             
0021+  CCCC             		; Сохранить регистры
0022+  CCCC E5          		push	h
0023+  CCCD C5          		push	b
0024+  CCCE D5          		push	d
0025+  CCCF             
0026+  CCCF             		; Указатель на длину найденного файла
0027+  CCCF 2A 86 CE    		lhld	v_foundedFile
0028+  CCD2 01 0D 00    		lxi	b, 13
0029+  CCD5 09          		dad	b
0030+  CCD6             
0031+  CCD6 C3 EC CC    		jmp	loc_CCBA
0032+  CCD9             
0033+  CCD9             ;----------------------------------------------------------------------------
0034+  CCD9             ; Загрузить файл по адресу указанному в заголовке
0035+  CCD9             ;
0036+  CCD9             ; На входе
0037+  CCD9             ;  hl - имя
0038+  CCD9             ;
0039+  CCD9             ; На выходе
0040+  CCD9             ;  bc,de,hl - сохраняются
0041+  CCD9             ;  v_foundedFile - найденный файл
0042+  CCD9             ;  cf - ошибка
0043+  CCD9             ;----------------------------------------------------------------------------
0044+  CCD9             
0045+  CCD9             fileLoad:	; Ищем файл с именем в HL
0046+  CCD9 CD 90 CC    		call	fileFind
0047+  CCDC D8          		rc
0048+  CCDD             
0049+  CCDD             		; Сохраняем регистры
0050+  CCDD E5          		push	h
0051+  CCDE C5          		push	b
0052+  CCDF D5          		push	d
0053+  CCE0             
0054+  CCE0             		; DE = адрес загрузки
0055+  CCE0 2A 86 CE    		lhld	v_foundedFile
0056+  CCE3 11 0A 00    		lxi	d, 10
0057+  CCE6 19          		dad	d
0058+  CCE7 5E          		mov	e, m ; +10
0059+  CCE8 23          		inx	h
0060+  CCE9 56          		mov	d, m ; +11
0061+  CCEA             
0062+  CCEA 23          		inx	h
0063+  CCEB 23          		inx	h
0064+  CCEC             
0065+  CCEC             loc_CCBA:	; Длина файла в кластерах
0066+  CCEC 46          		mov	b, m ; +13
0067+  CCED 04          		inr	b
0068+  CCEE             		
0069+  CCEE             		; Первый кластер
0070+  CCEE 23          		inx	h
0071+  CCEF 23          		inx	h
0072+  CCF0 7E          		mov	a, m ; +15
0073+  CCF1             
0074+  CCF1 EB          		xchg
0075+  CCF2             
0076+  CCF2             loc_CCC0:	; Читаем кластер в память
0077+  CCF2 1E 02       		mvi	e, 2		; Чтение
0078+  CCF4 57          		mov	d, a		; Кластер
0079+  CCF5 CD 63 C8    		call	j_diskDriver
0080+  CCF8             
0081+  CCF8             		; Следующий кластер
0082+  CCF8 24          		inr	h
0083+  CCF9 5A          		mov	e, d
0084+  CCFA 16 FB       		mvi	d, 0FBh
0085+  CCFC 1A          		ldax	d
0086+  CCFD             
0087+  CCFD             		; Цикл
0088+  CCFD 05          		dcr	b
0089+  CCFE C2 F2 CC    		jnz	loc_CCC0
0090+  CD01             
0091+  CD01             		; Восстанавливаем регистры
0092+  CD01 D1          		pop	d
0093+  CD02 C1          		pop	b
0094+  CD03 E1          		pop	h
0095+  CD04             
0096+  CD04 C3 0B CD    		jmp	loc_CCD9
0097+  CD07             
0098+  CD07             ; ---------------------------------------------------------------------------
0099+  CD07             
0100+  CD07             fileLoadInfo:	; Ищем файл с именем в HL
0101+  CD07 CD 90 CC    		call	fileFind
0102+  CD0A D8          		rc
0103+  CD0B             
0104+  CD0B             loc_CCD9:	; Сохраняем регистры
0105+  CD0B E5          		push	h
0106+  CD0C C5          		push	b
0107+  CD0D D5          		push	d
0108+  CD0E             
0109+  CD0E             		; Что то в DE
0110+  CD0E 01 09 00    		lxi	b, 9
0111+  CD11 09          		dad	b
0112+  CD12 EB          		xchg
0113+  CD13             
0114+  CD13             		; Информация о файле исключая имя
0115+  CD13 2A 86 CE    		lhld	v_foundedFile
0116+  CD16 09          		dad	b
0117+  CD17             
0118+  CD17             		; Копируем 7 байт из HL в DE
0119+  CD17 06 07       		mvi	b, 7
0120+  CD19 7E          loc_CCE7:	mov	a, m
0121+  CD1A 12          		stax	d
0122+  CD1B 23          		inx	h
0123+  CD1C 13          		inx	d
0124+  CD1D 05          		dcr	b
0125+  CD1E C2 19 CD    		jnz	loc_CCE7
0126+  CD21             
0127+  CD21             		; Выход CF=0
0128+  CD21 B7          		ora	a
0129+  CD22 C3 18 CC    		jmp	pop_dbh_ret
0205   CD25             .include "fileDelete.inc"
0001+  CD25             ;+---------------------------------------------------------------------------
0002+  CD25             ; MXOS
0003+  CD25             ; Удаление файла
0004+  CD25             ;
0005+  CD25             ; На входе
0006+  CD25             ;  hl - имя файла
0007+  CD25             ;
0008+  CD25             ; На выходе
0009+  CD25             ;  cf - ошибка
0010+  CD25             ;  bc,de,hl - сохраняются
0011+  CD25             ;
0012+  CD25             ; 2013-12-12 Дизассемблировано vinxru
0013+  CD25             ;----------------------------------------------------------------------------
0014+  CD25             
0015+  CD25             fileDelete:	; Найти файл с именем из HL
0016+  CD25 CD 90 CC    		call	fileFind
0017+  CD28 D8          		rc
0018+  CD29             
0019+  CD29             		; Удалить файл
0020+  CD29 CD 31 CD    		call	deleteFileInt
0021+  CD2C             
0022+  CD2C             		; Сохранить изменения на диск
0023+  CD2C CD BE CB    		call	saveFatDir
0024+  CD2F             
0025+  CD2F             		; Результат
0026+  CD2F B7          		ora	a
0027+  CD30 C9          		ret
0028+  CD31             		
0029+  CD31             ; ---------------------------------------------------------------------------
0030+  CD31             
0031+  CD31             deleteFileInt:	; Сохраняем регистры
0032+  CD31 E5          		push	h
0033+  CD32 C5          		push	b
0034+  CD33 D5          		push	d
0035+  CD34             
0036+  CD34             		; Помечаем файл, как удаленный заменяя его первую букву на FF
0037+  CD34 2A 86 CE    		lhld	v_foundedFile
0038+  CD37 36 FF       		mvi	m, 0FFh		
0039+  CD39             
0040+  CD39             		; Получаем первый кластер файла в A
0041+  CD39 11 0F 00    		lxi	d, 15
0042+  CD3C 19          		dad	d
0043+  CD3D 7E          		mov	a, m
0044+  CD3E             
0045+  CD3E             		; Адрес таблицы FAT
0046+  CD3E 26 FB       		mvi	h, fat>>8
0047+  CD40             
0048+  CD40             deleteFileIn_0:	; Получаем следующий кластер в А
0049+  CD40 6F          		mov	l, a
0050+  CD41 7E          		mov	a, m
0051+  CD42             
0052+  CD42             		; А этот помечаем не занятым
0053+  CD42 36 00       		mvi	m, 0
0054+  CD44             
0055+  CD44             		; Если это был не последний кластер, продолжаем.
0056+  CD44 BD          		cmp	l
0057+  CD45 C2 40 CD    		jnz	deleteFileIn_0
0058+  CD48             
0059+  CD48             		; Восстаналиваем регистры и выходим
0060+  CD48 C3 18 CC    		jmp	pop_dbh_ret		0206   CD4B             .include "fileRename.inc"
0001+  CD4B             ;+---------------------------------------------------------------------------
0002+  CD4B             ; MXOS
0003+  CD4B             ; Переименовать файл
0004+  CD4B             ;
0005+  CD4B             ; На входе 
0006+  CD4B             ;  hl - исходное имя
0007+  CD4B             ;  de - новое имя
0008+  CD4B             ;
0009+  CD4B             ; На выходе
0010+  CD4B             ;  cf - ошибка
0011+  CD4B             ;  bc,de,hl - сохраняются
0012+  CD4B             ;
0013+  CD4B             ; 2013-12-12 Дизассемблировано vinxru
0014+  CD4B             ;----------------------------------------------------------------------------
0015+  CD4B             
0016+  CD4B             fileRename:	; Найти файл с именем из HL
0017+  CD4B CD 90 CC    		call	fileFind
0018+  CD4E D8          		rc
0019+  CD4F             
0020+  CD4F             		; Сохранить регистры
0021+  CD4F E5          		push	h
0022+  CD50 C5          		push	b
0023+  CD51 D5          		push	d
0024+  CD52             		
0025+  CD52             		;
0026+  CD52 2A 86 CE    		lhld	v_foundedFile
0027+  CD55             
0028+  CD55             		; Попытаться найти файл с новым именем
0029+  CD55 EB          		xchg
0030+  CD56 CD 93 CC    		call	fileFind2		
0031+  CD59             
0032+  CD59             		; Если такой файл есть, то удалить
0033+  CD59 D4 31 CD    		cnc	deleteFileInt
0034+  CD5C             		
0035+  CD5C             		; Заменяем имя
0036+  CD5C 0E 09       		mvi	c, 9		
0037+  CD5E 7E          loc_CD2C:	mov	a, m
0038+  CD5F 12          		stax	d
0039+  CD60 23          		inx	h
0040+  CD61 13          		inx	d
0041+  CD62 0D          		dcr	c
0042+  CD63 C2 5E CD    		jnz	loc_CD2C
0043+  CD66             
0044+  CD66             		; Сохраняем изменения
0045+  CD66 CD BE CB    		call	saveFatDir
0046+  CD69             
0047+  CD69             		; Выход
0048+  CD69 B7          		ora	a
0049+  CD6A C3 18 CC    		jmp	pop_dbh_ret0207   CD6D             .include "fileGetSetAttr.inc"
0001+  CD6D             ;+---------------------------------------------------------------------------
0002+  CD6D             ; MXOS
0003+  CD6D             ; Получение/изменение атрибутов файла
0004+  CD6D             ;
0005+  CD6D             ; На входе 
0006+  CD6D             ;   hl - имя файла
0007+  CD6D             ;   с  - 0=чтение, 1=изменение
0008+  CD6D             ;   b  - новые атрибуты (если C==1)
0009+  CD6D             ;
0010+  CD6D             ; На выходе 
0011+  CD6D             ;   cf - ошибка
0012+  CD6D             ;   a  - атрибуты
0013+  CD6D             ;   bc,de,hl - сохраняются
0014+  CD6D             ;
0015+  CD6D             ; 2013-12-12 Дизассемблировано vinxru
0016+  CD6D             ;----------------------------------------------------------------------------
0017+  CD6D             
0018+  CD6D C5          fileGetSetAttr:	push	b
0019+  CD6E 47          		mov	b, a		
0020+  CD6F             
0021+  CD6F             		; Ищем файл с именем в HL. Если найден, то переходим
0022+  CD6F CD 90 CC    		call	fileFind
0023+  CD72 D2 77 CD    		jnc	fileGetSetAt_0
0024+  CD75             
0025+  CD75             		; Ошибка, выходим
0026+  CD75 C1          		pop	b
0027+  CD76 C9          		ret
0028+  CD77             
0029+  CD77             ; ---------------------------------------------------------------------------
0030+  CD77             
0031+  CD77 E5          fileGetSetAt_0:	push	h
0032+  CD78 CD A2 CD    		call	fileGetInfoAddr
0033+  CD7B             
0034+  CD7B             		; Переходим, если на входе в функцию C=0
0035+  CD7B C2 7F CD    		jnz	fileGetSetAt_1
0036+  CD7E             
0037+  CD7E             		; Устанавливаем флаги
0038+  CD7E 70          		mov	m, b
0039+  CD7F             
0040+  CD7F             fileGetSetAt_1:	; Читаем флаги
0041+  CD7F 7E          		mov	a, m
0042+  CD80             
0043+  CD80             		; Сохраняем изменения (хотя для чтения это не нужно делать)
0044+  CD80 CD BE CB    		call	saveFatDir
0045+  CD83             
0046+  CD83             		; Восстанавливаем регистры и выходим ;! А тут точно CF==0 будет?
0047+  CD83 B7          		ora	a
0048+  CD84 E1          		pop	h
0049+  CD85 C1          		pop	b
0050+  CD86 C9          		ret0208   CD87             .include "fileGetSetAddr.inc"
0001+  CD87             ;+---------------------------------------------------------------------------
0002+  CD87             ; MXOS
0003+  CD87             ; Получение/изменение адреса загрузки файла
0004+  CD87             ;
0005+  CD87             ; На входе 
0006+  CD87             ;   hl - имя файла
0007+  CD87             ;   с  - 0=чтение, 1=изменение
0008+  CD87             ;   de - адрес
0009+  CD87             ;
0010+  CD87             ; На выходе 
0011+  CD87             ;   de - адрес
0012+  CD87             ;   bc,hl - сохраняются
0013+  CD87             ;
0014+  CD87             ; 2013-12-12 Дизассемблировано vinxru
0015+  CD87             ;----------------------------------------------------------------------------
0016+  CD87             
0017+  CD87             fileGetSetAddr:	; Ищем файл с именем в HL
0018+  CD87 CD 90 CC    		call	fileFind
0019+  CD8A D8          		rc
0020+  CD8B             
0021+  CD8B E5          		push	h
0022+  CD8C             
0023+  CD8C             		; Получаем адрес где находится длина файла
0024+  CD8C CD A2 CD    		call	fileGetInfoAddr
0025+  CD8F 23          		inx	h
0026+  CD90             
0027+  CD90             		; Переходим, если на входе в функцию C=0
0028+  CD90 C2 9C CD    		jnz	fileGetSetAd_0
0029+  CD93             
0030+  CD93             		; Заменяем адрес загрузки
0031+  CD93 73          		mov	m, e
0032+  CD94 23          		inx	h
0033+  CD95 72          		mov	m, d
0034+  CD96             
0035+  CD96             		; Сохраняем изменения
0036+  CD96 CD BE CB    		call	saveFatDir
0037+  CD99             
0038+  CD99             		; Выходим
0039+  CD99 E1          		pop	h
0040+  CD9A B7          		ora	a
0041+  CD9B C9          		ret
0042+  CD9C             
0043+  CD9C             ; ---------------------------------------------------------------------------
0044+  CD9C             
0045+  CD9C             fileGetSetAd_0:	; Читаем адрес загрузки
0046+  CD9C 5E          		mov	e, m
0047+  CD9D 23          		inx	h
0048+  CD9E 56          		mov	d, m
0049+  CD9F             
0050+  CD9F             		; Выходим
0051+  CD9F E1          		pop	h
0052+  CDA0 B7          		ora	a
0053+  CDA1 C9          		ret
0209   CDA2             .include "fileGetInfoAddr.inc"
0001+  CDA2             ;+---------------------------------------------------------------------------
0002+  CDA2             ; MXOS
0003+  CDA2             ; Адрес информации о найденном файлое
0004+  CDA2             ;
0005+  CDA2             ; На входе 
0006+  CDA2             ;   c - любое число
0007+  CDA2             ;
0008+  CDA2             ; На выходе 
0009+  CDA2             ;   b, de - сохраняются
0010+  CDA2             ;   hl - адрес информации о найденном файлое
0011+  CDA2             ;   zf - если a==1
0012+  CDA2             ;   a = c
0013+  CDA2             ;   c = c-1
0014+  CDA2             ;
0015+  CDA2             ; 2013-12-12 Дизассемблировано vinxru
0016+  CDA2             ;----------------------------------------------------------------------------
0017+  CDA2             
0018+  CDA2 D5          fileGetInfoAddr:push	d
0019+  CDA3             
0020+  CDA3             		; Помещаем в hl адрес информации о файле
0021+  CDA3 2A 86 CE    		lhld	v_foundedFile
0022+  CDA6 11 09 00    		lxi	d, 9
0023+  CDA9 19          		dad	d
0024+  CDAA             
0025+  CDAA             		; Помещаем в A режим
0026+  CDAA 79          		mov	a, c
0027+  CDAB             
0028+  CDAB             		; ZF=1 если режим 1
0029+  CDAB 0D          		dcr	c
0030+  CDAC             
0031+  CDAC D1          		pop	d
0032+  CDAD C9          		ret0210   CDAE             .include "fileList.inc"
0001+  CDAE             ;+---------------------------------------------------------------------------
0002+  CDAE             ; MXOS
0003+  CDAE             ; Получить список файлов
0004+  CDAE             ;
0005+  CDAE             ; На входе 
0006+  CDAE             ;  hl - адрес буфера (769 байт)
0007+  CDAE             ;
0008+  CDAE             ; На выходе
0009+  CDAE             ;  bc,de,hl - сохраняются
0010+  CDAE             ;
0011+  CDAE             ; 2013-12-12 Дизассемблировано vinxru
0012+  CDAE             ;----------------------------------------------------------------------------
0013+  CDAE             
0014+  CDAE             fileList:	; Загрузка FAT и каталога
0015+  CDAE CD C4 CB    		call	loadFatDir
0016+  CDB1             
0017+  CDB1             		; Сохранение регистров
0018+  CDB1 E5          		push	h
0019+  CDB2 C5          		push	b
0020+  CDB3 D5          		push	d
0021+  CDB4             
0022+  CDB4             		; Максимум файлов
0023+  CDB4 06 30       		mvi	b, 48
0024+  CDB6             
0025+  CDB6             		; Адрес первого файла
0026+  CDB6 11 00 FC    		lxi	d, diskDirectory
0027+  CDB9             		
0028+  CDB9             fileList_loop:	; Если первый символ не FFh, копируем описатель
0029+  CDB9 1A          		ldax	d
0030+  CDBA 3C          		inr	a
0031+  CDBB C2 CE CD    		jnz	fileList_copy
0032+  CDBE             
0033+  CDBE             		; Вычисляем адрес следующего файла
0034+  CDBE E5          		push	h
0035+  CDBF 21 10 00    		lxi	h, 10h
0036+  CDC2 19          		dad	d
0037+  CDC3 EB          		xchg
0038+  CDC4 E1          		pop	h
0039+  CDC5             
0040+  CDC5             fileList_next:	; Цикл
0041+  CDC5 05          		dcr	b
0042+  CDC6 C2 B9 CD    		jnz	fileList_loop
0043+  CDC9             
0044+  CDC9             		; В конце символ 0FFh
0045+  CDC9 36 FF       		mvi	m, 0FFh
0046+  CDCB C3 18 CC    		jmp	pop_dbh_ret
0047+  CDCE             
0048+  CDCE             ; ---------------------------------------------------------------------------
0049+  CDCE             
0050+  CDCE             fileList_copy:	; Копируем 16 байт из DE в HL
0051+  CDCE 0E 10       		mvi	c, 16
0052+  CDD0 1A          fileList_copyl:	ldax	d
0053+  CDD1 77          		mov	m, a
0054+  CDD2 23          		inx	h
0055+  CDD3 13          		inx	d
0056+  CDD4 0D          		dcr	c
0057+  CDD5 C2 D0 CD    		jnz	fileList_copyl
0058+  CDD8 C3 C5 CD    		jmp	fileList_next0211   CDDB             .include "fileNamePrepare.inc"
0001+  CDDB             ;+---------------------------------------------------------------------------
0002+  CDDB             ; MXOS
0003+  CDDB             ; Подготовить имя файла для функций ОС
0004+  CDDB             ;
0005+  CDDB             ; На входе 
0006+  CDDB             ;  hl - исходное имя
0007+  CDDB             ;  de - буфер для результата (9 байт)
0008+  CDDB             ;
0009+  CDDB             ; 2013-12-12 Дизассемблировано vinxru
0010+  CDDB             ;----------------------------------------------------------------------------
0011+  CDDB             
0012+  CDDB             fileNamePrepare:; Сохраняем регистры
0013+  CDDB C5          		push	b
0014+  CDDC D5          		push	d
0015+  CDDD             
0016+  CDDD             		; Если второй символ исходной строки ':', то меняем диск
0017+  CDDD 23          		inx	h		
0018+  CDDE 7E          		mov	a, m
0019+  CDDF FE 3A       		cpi	':'
0020+  CDE1 2B          		dcx	h
0021+  CDE2 C2 ED CD    		jnz	fileNamePr_1
0022+  CDE5             
0023+  CDE5             		; Меняем диск
0024+  CDE5 7E          		mov	a, m		
0025+  CDE6 D6 41       		sui	'A'
0026+  CDE8 CD 8F CB    		call	fileSelectDrive
0027+  CDEB             
0028+  CDEB             		; Диск не входит в имя файла
0029+  CDEB 23          		inx	h		
0030+  CDEC 23          		inx	h		
0031+  CDED             		
0032+  CDED             fileNamePr_1:	; 6 символов имени, 3 расширения
0033+  CDED 01 03 06    		lxi	b, 603h
0034+  CDF0             
0035+  CDF0             		; Копируем текст до точки, пробела или конца строки, не более 6 символов. 
0036+  CDF0 7E          fileNamePr_2:	mov	a, m
0037+  CDF1 A7          		ana	a
0038+  CDF2 F2 F7 CD    		jp	fileNamePr_3
0039+  CDF5 D6 40       		sui	40h
0040+  CDF7 FE 21       fileNamePr_3:	cpi	' '+1
0041+  CDF9 DA 17 CE    		jc	fileNamePr_5
0042+  CDFC 23          		inx	h
0043+  CDFD FE 2E       		cpi	'.'
0044+  CDFF CA 17 CE    		jz	fileNamePr_5		
0045+  CE02 12          		stax	d
0046+  CE03 13          		inx	d
0047+  CE04 05          		dcr	b
0048+  CE05 C2 F0 CD    		jnz	fileNamePr_2
0049+  CE08             
0050+  CE08             		; Пропускаем текст до точки, пробела или конца строки
0051+  CE08 7E          fileNamePr_4:	mov	a, m
0052+  CE09 FE 21       		cpi	' '+1
0053+  CE0B DA 1A CE    		jc	fileNamePr_6
0054+  CE0E 23          		inx	h
0055+  CE0F FE 2E       		cpi	'.'
0056+  CE11 C2 08 CE    		jnz	fileNamePr_4
0057+  CE14 C3 1A CE    		jmp	fileNamePr_6
0058+  CE17             
0059+  CE17             ; ---------------------------------------------------------------------------
0060+  CE17             
0061+  CE17             fileNamePr_5:	; Имя короче 6 символов
0062+  CE17             		; Заполняем недостающие символы имени пробелами
0063+  CE17 CD 4C CE    		call	memset_de_20_b
0064+  CE1A             
0065+  CE1A             		; Копируем текст до пробела или конца строки, не более 3 символов. 
0066+  CE1A 7E          fileNamePr_6:	mov	a, m                         
0067+  CE1B A7          		ana	a
0068+  CE1C F2 21 CE    		jp	fileNamePr_7
0069+  CE1F D6 40       		sui	40h		
0070+  CE21 FE 21       fileNamePr_7:	cpi	' '+1
0071+  CE23 DA 45 CE    		jc	fileNamePr_11
0072+  CE26 12          		stax	d
0073+  CE27 23          		inx	h
0074+  CE28 13          		inx	d
0075+  CE29 0D          		dcr	c
0076+  CE2A C2 1A CE    		jnz	fileNamePr_6
0077+  CE2D             
0078+  CE2D             fileNamePr_8:	; Пропускаем текст до пробела или конца строки
0079+  CE2D 7E          		mov	a, m
0080+  CE2E FE 20       		cpi	' '
0081+  CE30 DA 42 CE    		jc	fileNamePr_10
0082+  CE33 23          		inx	h
0083+  CE34 C2 2D CE    		jnz	fileNamePr_8
0084+  CE37             		
0085+  CE37             fileNamePr_9:	; Пропускаем текст до пробела или конца строки
0086+  CE37             		; Почему то дублируется код
0087+  CE37 7E          		mov	a, m
0088+  CE38 FE 20       		cpi	' '
0089+  CE3A DA 42 CE    		jc	fileNamePr_10
0090+  CE3D 23          		inx	h
0091+  CE3E CA 37 CE    		jz	fileNamePr_9
0092+  CE41 2B          		dcx	h
0093+  CE42             
0094+  CE42             fileNamePr_10:	; Восстанавливаем регистры и выходим
0095+  CE42 D1          		pop	d
0096+  CE43 C1          		pop	b
0097+  CE44 C9          		ret
0098+  CE45             
0099+  CE45             ; ---------------------------------------------------------------------------
0100+  CE45             
0101+  CE45             fileNamePr_11:	; Заполняем недостающие символы расширения пробелами
0102+  CE45 41          		mov	b, c
0103+  CE46 CD 4C CE    		call	memset_de_20_b
0104+  CE49             
0105+  CE49             		; Восстанавливаем регистры и выходим
0106+  CE49 D1          		pop	d
0107+  CE4A C1          		pop	b
0108+  CE4B C9          		ret		0212   CE4C             .include "memset_de_20_b.inc"
0001+  CE4C             ;+---------------------------------------------------------------------------
0002+  CE4C             ; MXOS
0003+  CE4C             ; Заполнить память пробелами
0004+  CE4C             ;
0005+  CE4C             ; На входе
0006+  CE4C             ;  de - адрес
0007+  CE4C             ;  b  - длина (0 считается за 256)
0008+  CE4C             ;
0009+  CE4C             ; 2013-12-12 Дизассемблировано vinxru
0010+  CE4C             ;----------------------------------------------------------------------------
0011+  CE4C             
0012+  CE4C 3E 20       memset_de_20_b:	mvi	a, ' '
0013+  CE4E 12          memset_de_a_b:	stax	d
0014+  CE4F 13          		inx	d
0015+  CE50 05          		dcr	b
0016+  CE51 C2 4E CE    		jnz	memset_de_a_b
0017+  CE54 C9          		ret0213   CE55             
0214   CE55             ; ---------------------------------------------------------------------------
0215   CE55             
0216   CE55 0A          aBadCommandOrFi:.db 0Ah
0217   CE56 42 41 44 20 		.text "BAD COMMAND OR FILE NAME"
0217   CE5A 43 4F 4D 4D 
0217   CE5E 41 4E 44 20 
0217   CE62 4F 52 20 46 
0217   CE66 49 4C 45 20 
0217   CE6A 4E 41 4D 45 
0218   CE6E 00          		.db 0
0219   CE6F 1D CB 1D CB v_drives:	.dw diskDriver, diskDriver, diskDriver, diskDriver
0219   CE73 1D CB 1D CB 
0220   CE77 1D CB 1D CB 		.dw diskDriver, diskDriver, diskDriver, diskDriver
0220   CE7B 1D CB 1D CB 
0221   CE7F 00 00       v_findCluster:	.dw 0
0222   CE81 01          v_drive:	.db 1
0223   CE82 00 00       v_input_start:	.dw 0
0224   CE84 00 00       v_createdFile:	.dw 0
0225   CE86 00 00       v_foundedFile:	.dw 0
0226   CE88 00 00       v_input_end:	.dw 0
0227   CE8A 00 00       v_batPtr:	.dw 0
0228   CE8C FF FA       v_memTop:	.dw 0FAFFh
0229   CE8E 41 3A 4E 43 aANc_com:	.text "A:NC.COM"
0229   CE92 2E 43 4F 4D 
0230   CE96 0D          		.db 0Dh
0231   CE97             #if START_FROM_RAM
0232   CE97 41 3A 41 55 aBAutoex_bat:	.db "A:AUTOEX.BAT"
0232   CE9B 54 4F 45 58 
0232   CE9F 2E 42 41 54 
0233   CEA3~            #else
0234   CEA3~            aBAutoex_bat:	.db "B:AUTOEX.BAT"
0235   CEA3             #endif
0236   CEA3 0D          		.db 0Dh
0237   CEA4 42 41 54    aBat:		.text "BAT"
0238   CEA7 43 4F 4D    aCom:		.text "COM"
0239   CEAA 45 58 45    aExe:		.text "EXE"
0240   CEAD FF FF FF FF v_fileName:	.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0240   CEB1 FF FF 
0241   CEB3             
0242   CEB3 FF FF FF    v_fileName_ext:	.db 0FFh, 0FFh, 0FFh
0243   CEB6 FF FF FF FF 		.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0243   CEBA FF FF 
0244   CEBC FF          v_fileName_end:	.db 0FFh ; Љ®ЇЁа®ў ­ЁҐ Їа®Ёбе®¤Ёв ўЄ«оз п нв®в ­ҐЁбЇ®«м§гҐ¬л© Ў ©в
0245   CEBD             
0246   CEBD FF FF FF    v_batFileName:	.db 0FFh, 0FFh,	0FFh
0247   CEC0 FF FF FF FF 		.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0247   CEC4 FF FF 
0248   CEC6 FF          v_batFileN_end:	.db 0FFh ; Љ®ЇЁа®ў ­ЁҐ Їа®Ёбе®¤Ёв ўЄ«оз п нв®в ­ҐЁбЇ®«м§гҐ¬л© Ў ©в
0249   CEC7             
0250   CEC7             #if START_FROM_RAM
0251   CEC7 41 3A 43 4F aDriver:	.db "A:CONFIG.BAT"
0251   CECB 4E 46 49 47 
0251   CECF 2E 42 41 54 
0252   CED3 0D          		.db 0Dh
0253   CED4             #endif
0254   CED4             
0255   CED4             #if LOAD_FONT
0256   CED4             .include "font.inc"
0001+  CED4 21 38 C5    initFont:	lxi	h, reboot2
0002+  CED7 22 75 C4    		shld	onceInitFont+1
0003+  CEDA E5          		push	h
0004+  CEDB             
0005+  CEDB 21 E7 CE    		lxi	h, font
0006+  CEDE 11 E7 D6    		lxi	d, fontEnd
0007+  CEE1 01 00 E9    		lxi	b, FONT_ADDR
0008+  CEE4 C3 2D C4    		jmp	memcpy_bc_hl
0009+  CEE7             
0010+  CEE7             font:
0011+  CEE7 00 00 00 00 	.db 000h,000h,000h,000h,000h,000h,000h,000h ; 0
0011+  CEEB 00 00 00 00 
0012+  CEEF 04 0E 15 04 	.db 004h,00Eh,015h,004h,015h,00Eh,004h,000h ; 1
0012+  CEF3 15 0E 04 00 
0013+  CEF7 00 00 04 0A 	.db 000h,000h,004h,00Ah,01Fh,000h,01Fh,000h ; 2
0013+  CEFB 1F 00 1F 00 
0014+  CEFF 00 00 1F 0A 	.db 000h,000h,01Fh,00Ah,004h,000h,01Fh,000h ; 3
0014+  CF03 04 00 1F 00 
0015+  CF07 09 1B 2D 1B 	.db 009h,01Bh,02Dh,01Bh,009h,000h,000h,000h ; 4
0015+  CF0B 09 00 00 00 
0016+  CF0F 24 36 2D 36 	.db 024h,036h,02Dh,036h,024h,000h,000h,000h ; 5
0016+  CF13 24 00 00 00 
0017+  CF17 1E 21 2D 29 	.db 01Eh,021h,02Dh,029h,02Dh,021h,01Eh,000h ; 6
0017+  CF1B 2D 21 1E 00 
0018+  CF1F 10 18 17 15 	.db 010h,018h,017h,015h,017h,018h,010h,000h ; 7
0018+  CF23 17 18 10 00 
0019+  CF27 00 00 04 08 	.db 000h,000h,004h,008h,01Fh,008h,004h,000h ; 8
0019+  CF2B 1F 08 04 00 
0020+  CF2F 00 00 14 12 	.db 000h,000h,014h,012h,01Fh,012h,014h,000h ; 9
0020+  CF33 1F 12 14 00 
0021+  CF37 13 12 13 1A 	.db 013h,012h,013h,01Ah,000h,01Fh,000h,000h ; 10
0021+  CF3B 00 1F 00 00 
0022+  CF3F 00 00 00 00 	.db 000h,000h,000h,000h,000h,000h,000h,000h ; 11
0022+  CF43 00 00 00 00 
0023+  CF47 1C 18 14 02 	.db 01Ch,018h,014h,002h,001h,001h,001h,000h ; 12
0023+  CF4B 01 01 01 00 
0024+  CF4F 1F 01 01 05 	.db 01Fh,001h,001h,005h,009h,01Fh,008h,004h ; 13
0024+  CF53 09 1F 08 04 
0025+  CF57 03 04 04 1C 	.db 003h,004h,004h,01Ch,03Ch,018h,000h,000h ; 14
0025+  CF5B 3C 18 00 00 
0026+  CF5F 03 09 05 3F 	.db 003h,009h,005h,03Fh,005h,009h,003h,000h ; 15
0026+  CF63 05 09 03 00 
0027+  CF67 03 09 11 3F 	.db 003h,009h,011h,03Fh,011h,009h,003h,000h ; 16
0027+  CF6B 11 09 03 00 
0028+  CF6F 04 0A 11 0A 	.db 004h,00Ah,011h,00Ah,004h,000h,000h,000h ; 17
0028+  CF73 04 00 00 00 
0029+  CF77 11 11 11 11 	.db 011h,011h,011h,011h,011h,000h,011h,000h ; 18
0029+  CF7B 11 00 11 00 
0030+  CF7F 00 00 00 00 	.db 000h,000h,000h,000h,000h,011h,011h,000h ; 19
0030+  CF83 00 11 11 00 
0031+  CF87 00 08 00 08 	.db 000h,008h,000h,008h,000h,008h,000h,000h ; 20
0031+  CF8B 00 08 00 00 
0032+  CF8F 04 04 00 1F 	.db 004h,004h,000h,01Fh,000h,004h,004h,000h ; 21
0032+  CF93 00 04 04 00 
0033+  CF97 0F 08 08 08 	.db 00Fh,008h,008h,008h,008h,028h,010h,000h ; 22
0033+  CF9B 08 28 10 00 
0034+  CF9F 3F 00 00 00 	.db 03Fh,000h,000h,000h,000h,000h,000h,000h ; 23
0034+  CFA3 00 00 00 00 
0035+  CFA7 00 00 04 02 	.db 000h,000h,004h,002h,01Fh,002h,004h,000h ; 24
0035+  CFAB 1F 02 04 00 
0036+  CFAF 04 0E 15 04 	.db 004h,00Eh,015h,004h,004h,004h,004h,000h ; 25
0036+  CFB3 04 04 04 00 
0037+  CFB7 04 04 04 04 	.db 004h,004h,004h,004h,015h,00Eh,004h,000h ; 26
0037+  CFBB 15 0E 04 00 
0038+  CFBF 1B 12 1A 12 	.db 01Bh,012h,01Ah,012h,01Bh,000h,01Fh,000h ; 27
0038+  CFC3 1B 00 1F 00 
0039+  CFC7 3F 01 00 00 	.db 03Fh,001h,000h,000h,000h,000h,000h,000h ; 28
0039+  CFCB 00 00 00 00 
0040+  CFCF 00 00 00 00 	.db 000h,000h,000h,000h,000h,000h,000h,000h ; 29
0040+  CFD3 00 00 00 00 
0041+  CFD7 00 00 00 00 	.db 000h,000h,000h,000h,000h,000h,000h,000h ; 30
0041+  CFDB 00 00 00 00 
0042+  CFDF 1F 11 19 15 	.db 01Fh,011h,019h,015h,013h,011h,01Fh,000h ; 31
0042+  CFE3 13 11 1F 00 
0043+  CFE7 00 00 00 00 	.db 000h,000h,000h,000h,000h,000h,000h,000h ; 32
0043+  CFEB 00 00 00 00 
0044+  CFEF 04 04 04 04 	.db 004h,004h,004h,004h,004h,000h,004h,000h ; 33
0044+  CFF3 04 00 04 00 
0045+  CFF7 0A 0A 0A 00 	.db 00Ah,00Ah,00Ah,000h,000h,000h,000h,000h ; 34
0045+  CFFB 00 00 00 00 
0046+  CFFF 0A 0A 1F 0A 	.db 00Ah,00Ah,01Fh,00Ah,01Fh,00Ah,00Ah,000h ; 35
0046+  D003 1F 0A 0A 00 
0047+  D007 04 0F 14 0E 	.db 004h,00Fh,014h,00Eh,005h,01Eh,004h,000h ; 36
0047+  D00B 05 1E 04 00 
0048+  D00F 10 11 02 04 	.db 010h,011h,002h,004h,008h,011h,001h,000h ; 37
0048+  D013 08 11 01 00 
0049+  D017 04 0A 0A 0C 	.db 004h,00Ah,00Ah,00Ch,015h,012h,00Dh,000h ; 38
0049+  D01B 15 12 0D 00 
0050+  D01F 00 02 02 04 	.db 000h,002h,002h,004h,000h,000h,000h,000h ; 39
0050+  D023 00 00 00 00 
0051+  D027 02 04 08 08 	.db 002h,004h,008h,008h,008h,004h,002h,000h ; 40
0051+  D02B 08 04 02 00 
0052+  D02F 08 04 02 02 	.db 008h,004h,002h,002h,002h,004h,008h,000h ; 41
0052+  D033 02 04 08 00 
0053+  D037 00 04 15 0E 	.db 000h,004h,015h,00Eh,015h,004h,000h,000h ; 42
0053+  D03B 15 04 00 00 
0054+  D03F 00 04 04 1F 	.db 000h,004h,004h,01Fh,004h,004h,000h,000h ; 43
0054+  D043 04 04 00 00 
0055+  D047 00 00 00 00 	.db 000h,000h,000h,000h,000h,004h,004h,008h ; 44
0055+  D04B 00 04 04 08 
0056+  D04F 00 00 00 1F 	.db 000h,000h,000h,01Fh,000h,000h,000h,000h ; 45
0056+  D053 00 00 00 00 
0057+  D057 00 00 00 00 	.db 000h,000h,000h,000h,000h,004h,004h,000h ; 46
0057+  D05B 00 04 04 00 
0058+  D05F 00 01 02 04 	.db 000h,001h,002h,004h,008h,010h,000h,000h ; 47
0058+  D063 08 10 00 00 
0059+  D067 0E 11 13 15 	.db 00Eh,011h,013h,015h,019h,011h,00Eh,000h ; 48
0059+  D06B 19 11 0E 00 
0060+  D06F 04 0C 04 04 	.db 004h,00Ch,004h,004h,004h,004h,00Eh,000h ; 49
0060+  D073 04 04 0E 00 
0061+  D077 0E 11 01 06 	.db 00Eh,011h,001h,006h,008h,010h,01Fh,000h ; 50
0061+  D07B 08 10 1F 00 
0062+  D07F 1F 01 02 06 	.db 01Fh,001h,002h,006h,001h,011h,00Eh,000h ; 51
0062+  D083 01 11 0E 00 
0063+  D087 02 06 0A 12 	.db 002h,006h,00Ah,012h,01Fh,002h,002h,000h ; 52
0063+  D08B 1F 02 02 00 
0064+  D08F 1F 10 1E 01 	.db 01Fh,010h,01Eh,001h,001h,011h,00Eh,000h ; 53
0064+  D093 01 11 0E 00 
0065+  D097 07 08 10 1E 	.db 007h,008h,010h,01Eh,011h,011h,00Eh,000h ; 54
0065+  D09B 11 11 0E 00 
0066+  D09F 1F 01 02 04 	.db 01Fh,001h,002h,004h,008h,008h,008h,000h ; 55
0066+  D0A3 08 08 08 00 
0067+  D0A7 0E 11 11 0E 	.db 00Eh,011h,011h,00Eh,011h,011h,00Eh,000h ; 56
0067+  D0AB 11 11 0E 00 
0068+  D0AF 0E 11 11 0F 	.db 00Eh,011h,011h,00Fh,001h,002h,01Ch,000h ; 57
0068+  D0B3 01 02 1C 00 
0069+  D0B7 00 04 04 00 	.db 000h,004h,004h,000h,000h,004h,004h,000h ; 58
0069+  D0BB 00 04 04 00 
0070+  D0BF 00 04 04 00 	.db 000h,004h,004h,000h,000h,004h,004h,008h ; 59
0070+  D0C3 00 04 04 08 
0071+  D0C7 02 04 08 10 	.db 002h,004h,008h,010h,008h,004h,002h,000h ; 60
0071+  D0CB 08 04 02 00 
0072+  D0CF 00 00 1F 00 	.db 000h,000h,01Fh,000h,01Fh,000h,000h,000h ; 61
0072+  D0D3 1F 00 00 00 
0073+  D0D7 08 04 02 01 	.db 008h,004h,002h,001h,002h,004h,008h,000h ; 62
0073+  D0DB 02 04 08 00 
0074+  D0DF 0E 11 01 02 	.db 00Eh,011h,001h,002h,004h,000h,004h,000h ; 63
0074+  D0E3 04 00 04 00 
0075+  D0E7 0E 11 13 15 	.db 00Eh,011h,013h,015h,017h,010h,00Eh,000h ; 64
0075+  D0EB 17 10 0E 00 
0076+  D0EF 04 0A 11 11 	.db 004h,00Ah,011h,011h,01Fh,011h,011h,000h ; 65
0076+  D0F3 1F 11 11 00 
0077+  D0F7 1E 11 11 1E 	.db 01Eh,011h,011h,01Eh,011h,011h,01Eh,000h ; 66
0077+  D0FB 11 11 1E 00 
0078+  D0FF 0E 11 10 10 	.db 00Eh,011h,010h,010h,010h,011h,00Eh,000h ; 67
0078+  D103 10 11 0E 00 
0079+  D107 1E 09 09 09 	.db 01Eh,009h,009h,009h,009h,009h,01Eh,000h ; 68
0079+  D10B 09 09 1E 00 
0080+  D10F 1F 10 10 1E 	.db 01Fh,010h,010h,01Eh,010h,010h,01Fh,000h ; 69
0080+  D113 10 10 1F 00 
0081+  D117 1F 10 10 1E 	.db 01Fh,010h,010h,01Eh,010h,010h,010h,000h ; 70
0081+  D11B 10 10 10 00 
0082+  D11F 0E 11 10 10 	.db 00Eh,011h,010h,010h,013h,011h,00Fh,000h ; 71
0082+  D123 13 11 0F 00 
0083+  D127 11 11 11 1F 	.db 011h,011h,011h,01Fh,011h,011h,011h,000h ; 72
0083+  D12B 11 11 11 00 
0084+  D12F 0E 04 04 04 	.db 00Eh,004h,004h,004h,004h,004h,00Eh,000h ; 73
0084+  D133 04 04 0E 00 
0085+  D137 01 01 01 01 	.db 001h,001h,001h,001h,011h,011h,00Eh,000h ; 74
0085+  D13B 11 11 0E 00 
0086+  D13F 11 12 14 18 	.db 011h,012h,014h,018h,014h,012h,011h,000h ; 75
0086+  D143 14 12 11 00 
0087+  D147 10 10 10 10 	.db 010h,010h,010h,010h,010h,011h,01Fh,000h ; 76
0087+  D14B 10 11 1F 00 
0088+  D14F 11 1B 15 15 	.db 011h,01Bh,015h,015h,011h,011h,011h,000h ; 77
0088+  D153 11 11 11 00 
0089+  D157 11 11 19 15 	.db 011h,011h,019h,015h,013h,011h,011h,000h ; 78
0089+  D15B 13 11 11 00 
0090+  D15F 0E 11 11 11 	.db 00Eh,011h,011h,011h,011h,011h,00Eh,000h ; 79
0090+  D163 11 11 0E 00 
0091+  D167 1E 11 11 1E 	.db 01Eh,011h,011h,01Eh,010h,010h,010h,000h ; 80
0091+  D16B 10 10 10 00 
0092+  D16F 0E 11 11 11 	.db 00Eh,011h,011h,011h,015h,012h,00Dh,000h ; 81
0092+  D173 15 12 0D 00 
0093+  D177 1E 11 11 1E 	.db 01Eh,011h,011h,01Eh,014h,012h,011h,000h ; 82
0093+  D17B 14 12 11 00 
0094+  D17F 0E 11 10 0E 	.db 00Eh,011h,010h,00Eh,001h,011h,00Eh,000h ; 83
0094+  D183 01 11 0E 00 
0095+  D187 1F 04 04 04 	.db 01Fh,004h,004h,004h,004h,004h,004h,000h ; 84
0095+  D18B 04 04 04 00 
0096+  D18F 11 11 11 11 	.db 011h,011h,011h,011h,011h,011h,00Eh,000h ; 85
0096+  D193 11 11 0E 00 
0097+  D197 11 11 11 0A 	.db 011h,011h,011h,00Ah,00Ah,004h,004h,000h ; 86
0097+  D19B 0A 04 04 00 
0098+  D19F 11 11 11 15 	.db 011h,011h,011h,015h,015h,015h,00Ah,000h ; 87
0098+  D1A3 15 15 0A 00 
0099+  D1A7 11 11 0A 04 	.db 011h,011h,00Ah,004h,00Ah,011h,011h,000h ; 88
0099+  D1AB 0A 11 11 00 
0100+  D1AF 11 11 0A 04 	.db 011h,011h,00Ah,004h,004h,004h,004h,000h ; 89
0100+  D1B3 04 04 04 00 
0101+  D1B7 1F 01 02 0E 	.db 01Fh,001h,002h,00Eh,008h,010h,01Fh,000h ; 90
0101+  D1BB 08 10 1F 00 
0102+  D1BF 0E 08 08 08 	.db 00Eh,008h,008h,008h,008h,008h,00Eh,000h ; 91
0102+  D1C3 08 08 0E 00 
0103+  D1C7 00 10 08 04 	.db 000h,010h,008h,004h,002h,001h,000h,000h ; 92
0103+  D1CB 02 01 00 00 
0104+  D1CF 0E 02 02 02 	.db 00Eh,002h,002h,002h,002h,002h,00Eh,000h ; 93
0104+  D1D3 02 02 0E 00 
0105+  D1D7 04 0A 11 00 	.db 004h,00Ah,011h,000h,000h,000h,000h,000h ; 94
0105+  D1DB 00 00 00 00 
0106+  D1DF 00 00 00 00 	.db 000h,000h,000h,000h,000h,000h,000h,000h ; 95
0106+  D1E3 00 00 00 00 
0107+  D1E7 00 0F 00 06 	.db 000h,00Fh,000h,006h,009h,009h,006h,000h ; 96
0107+  D1EB 09 09 06 00 
0108+  D1EF 00 00 0C 02 	.db 000h,000h,00Ch,002h,00Eh,012h,00Dh,000h ; 97
0108+  D1F3 0E 12 0D 00 
0109+  D1F7 08 08 08 0E 	.db 008h,008h,008h,00Eh,009h,009h,016h,000h ; 98
0109+  D1FB 09 09 16 00 
0110+  D1FF 00 00 0E 11 	.db 000h,000h,00Eh,011h,010h,011h,00Eh,000h ; 99
0110+  D203 10 11 0E 00 
0111+  D207 02 02 02 0E 	.db 002h,002h,002h,00Eh,012h,012h,00Dh,000h ; 100
0111+  D20B 12 12 0D 00 
0112+  D20F 00 00 0E 11 	.db 000h,000h,00Eh,011h,01Fh,010h,00Eh,000h ; 101
0112+  D213 1F 10 0E 00 
0113+  D217 06 09 08 1C 	.db 006h,009h,008h,01Ch,008h,008h,008h,000h ; 102
0113+  D21B 08 08 08 00 
0114+  D21F 00 00 0D 12 	.db 000h,000h,00Dh,012h,012h,00Eh,002h,01Ch ; 103
0114+  D223 12 0E 02 1C 
0115+  D227 10 10 10 1E 	.db 010h,010h,010h,01Eh,011h,011h,011h,000h ; 104
0115+  D22B 11 11 11 00 
0116+  D22F 00 10 00 10 	.db 000h,010h,000h,010h,010h,011h,00Eh,000h ; 105
0116+  D233 10 11 0E 00 
0117+  D237 00 01 00 01 	.db 000h,001h,000h,001h,001h,001h,011h,00Eh ; 106
0117+  D23B 01 01 11 0E 
0118+  D23F 10 10 11 12 	.db 010h,010h,011h,012h,01Ch,012h,011h,000h ; 107
0118+  D243 1C 12 11 00 
0119+  D247 10 10 10 10 	.db 010h,010h,010h,010h,010h,011h,00Eh,000h ; 108
0119+  D24B 10 11 0E 00 
0120+  D24F 00 00 1A 15 	.db 000h,000h,01Ah,015h,015h,015h,015h,000h ; 109
0120+  D253 15 15 15 00 
0121+  D257 00 00 16 19 	.db 000h,000h,016h,019h,011h,011h,011h,000h ; 110
0121+  D25B 11 11 11 00 
0122+  D25F 00 00 0E 11 	.db 000h,000h,00Eh,011h,011h,011h,00Eh,000h ; 111
0122+  D263 11 11 0E 00 
0123+  D267 00 00 16 09 	.db 000h,000h,016h,009h,009h,00Eh,008h,008h ; 112
0123+  D26B 09 0E 08 08 
0124+  D26F 00 00 0D 12 	.db 000h,000h,00Dh,012h,012h,00Eh,002h,002h ; 113
0124+  D273 12 0E 02 02 
0125+  D277 00 00 16 09 	.db 000h,000h,016h,009h,008h,008h,008h,000h ; 114
0125+  D27B 08 08 08 00 
0126+  D27F 00 00 0E 10 	.db 000h,000h,00Eh,010h,00Eh,001h,00Eh,000h ; 115
0126+  D283 0E 01 0E 00 
0127+  D287 08 08 1C 08 	.db 008h,008h,01Ch,008h,008h,009h,006h,000h ; 116
0127+  D28B 08 09 06 00 
0128+  D28F 00 00 12 12 	.db 000h,000h,012h,012h,012h,012h,00Dh,000h ; 117
0128+  D293 12 12 0D 00 
0129+  D297 00 00 11 11 	.db 000h,000h,011h,011h,011h,00Ah,004h,000h ; 118
0129+  D29B 11 0A 04 00 
0130+  D29F 00 00 15 15 	.db 000h,000h,015h,015h,015h,015h,00Ah,000h ; 119
0130+  D2A3 15 15 0A 00 
0131+  D2A7 00 00 11 0A 	.db 000h,000h,011h,00Ah,004h,00Ah,011h,000h ; 120
0131+  D2AB 04 0A 11 00 
0132+  D2AF 00 00 11 11 	.db 000h,000h,011h,011h,011h,00Fh,001h,00Eh ; 121
0132+  D2B3 11 0F 01 0E 
0133+  D2B7 00 00 1F 01 	.db 000h,000h,01Fh,001h,00Eh,010h,01Fh,000h ; 122
0133+  D2BB 0E 10 1F 00 
0134+  D2BF 03 04 04 18 	.db 003h,004h,004h,018h,004h,004h,003h,000h ; 123
0134+  D2C3 04 04 03 00 
0135+  D2C7 1F 11 11 11 	.db 01Fh,011h,011h,011h,011h,011h,01Fh,000h ; 124
0135+  D2CB 11 11 1F 00 
0136+  D2CF 18 04 04 03 	.db 018h,004h,004h,003h,004h,004h,018h,000h ; 125
0136+  D2D3 04 04 18 00 
0137+  D2D7 00 00 08 15 	.db 000h,000h,008h,015h,002h,000h,000h,000h ; 126
0137+  D2DB 02 00 00 00 
0138+  D2DF 01 03 07 0F 	.db 001h,003h,007h,00Fh,007h,003h,001h,000h ; 127
0138+  D2E3 07 03 01 00 
0139+  D2E7 00 00 0A 1F 	.db 000h,000h,00Ah,01Fh,01Fh,00Eh,004h,000h ; 128
0139+  D2EB 1F 0E 04 00 
0140+  D2EF 00 04 04 1F 	.db 000h,004h,004h,01Fh,004h,004h,01Bh,000h ; 129
0140+  D2F3 04 04 1B 00 
0141+  D2F7 04 0E 1F 1F 	.db 004h,00Eh,01Fh,01Fh,00Ah,004h,01Bh,000h ; 130
0141+  D2FB 0A 04 1B 00 
0142+  D2FF 00 00 04 0E 	.db 000h,000h,004h,00Eh,01Fh,00Eh,004h,000h ; 131
0142+  D303 1F 0E 04 00 
0143+  D307 02 04 0A 15 	.db 002h,004h,00Ah,015h,011h,011h,00Eh,000h ; 132
0143+  D30B 11 11 0E 00 
0144+  D30F 0E 04 1F 15 	.db 00Eh,004h,01Fh,015h,004h,00Ah,011h,000h ; 133
0144+  D313 04 0A 11 00 
0145+  D317 03 04 06 09 	.db 003h,004h,006h,009h,006h,002h,00Ch,000h ; 134
0145+  D31B 06 02 0C 00 
0146+  D31F 07 03 05 0C 	.db 007h,003h,005h,00Ch,012h,012h,00Ch,000h ; 135
0146+  D323 12 12 0C 00 
0147+  D327 0E 11 11 0E 	.db 00Eh,011h,011h,00Eh,004h,00Eh,004h,000h ; 136
0147+  D32B 04 0E 04 00 
0148+  D32F 00 17 14 1F 	.db 000h,017h,014h,01Fh,005h,01Dh,000h,000h ; 137
0148+  D333 05 1D 00 00 
0149+  D337 04 04 1F 04 	.db 004h,004h,01Fh,004h,014h,00Ch,006h,005h ; 138
0149+  D33B 14 0C 06 05 
0150+  D33F 04 1F 04 0A 	.db 004h,01Fh,004h,00Ah,011h,01Fh,004h,000h ; 139
0150+  D343 11 1F 04 00 
0151+  D347 04 1F 05 0A 	.db 004h,01Fh,005h,00Ah,011h,01Fh,004h,000h ; 140
0151+  D34B 11 1F 04 00 
0152+  D34F 04 04 1F 00 	.db 004h,004h,01Fh,000h,01Fh,004h,004h,000h ; 141
0152+  D353 1F 04 04 00 
0153+  D357 04 0E 0A 0A 	.db 004h,00Eh,00Ah,00Ah,00Ah,00Eh,004h,000h ; 142
0153+  D35B 0A 0E 04 00 
0154+  D35F 04 06 01 06 	.db 004h,006h,001h,006h,001h,006h,004h,000h ; 143
0154+  D363 01 06 04 00 
0155+  D367 00 00 00 3F 	.db 000h,000h,000h,03Fh,03Fh,000h,000h,000h ; 144
0155+  D36B 3F 00 00 00 
0156+  D36F 30 30 30 30 	.db 030h,030h,030h,030h,030h,030h,030h,030h ; 145
0156+  D373 30 30 30 30 
0157+  D377 03 03 03 03 	.db 003h,003h,003h,003h,003h,003h,003h,003h ; 146
0157+  D37B 03 03 03 03 
0158+  D37F 30 30 30 3F 	.db 030h,030h,030h,03Fh,03Fh,030h,030h,030h ; 147
0158+  D383 3F 30 30 30 
0159+  D387 03 03 03 3F 	.db 003h,003h,003h,03Fh,03Fh,003h,003h,003h ; 148
0159+  D38B 3F 03 03 03 
0160+  D38F 00 00 00 3F 	.db 000h,000h,000h,03Fh,03Fh,030h,030h,030h ; 149
0160+  D393 3F 30 30 30 
0161+  D397 00 00 00 3F 	.db 000h,000h,000h,03Fh,03Fh,003h,003h,003h ; 150
0161+  D39B 3F 03 03 03 
0162+  D39F 03 03 03 3F 	.db 003h,003h,003h,03Fh,03Fh,000h,000h,000h ; 151
0162+  D3A3 3F 00 00 00 
0163+  D3A7 30 30 30 3F 	.db 030h,030h,030h,03Fh,03Fh,000h,000h,000h ; 152
0163+  D3AB 3F 00 00 00 
0164+  D3AF 00 00 00 3F 	.db 000h,000h,000h,03Fh,03Fh,018h,018h,018h ; 153
0164+  D3B3 3F 18 18 18 
0165+  D3B7 18 18 18 18 	.db 018h,018h,018h,018h,018h,018h,018h,018h ; 154
0165+  D3BB 18 18 18 18 
0166+  D3BF 18 18 18 3F 	.db 018h,018h,018h,03Fh,03Fh,000h,000h,000h ; 155
0166+  D3C3 3F 00 00 00 
0167+  D3C7 18 18 18 3F 	.db 018h,018h,018h,03Fh,03Fh,018h,018h,018h ; 156
0167+  D3CB 3F 18 18 18 
0168+  D3CF 00 00 01 02 	.db 000h,000h,001h,002h,014h,008h,000h,000h ; 157
0168+  D3D3 14 08 00 00 
0169+  D3D7 00 00 00 00 	.db 000h,000h,000h,000h,000h,000h,000h,000h ; 158
0169+  D3DB 00 00 00 00 
0170+  D3DF 00 00 00 00 	.db 000h,000h,000h,000h,000h,000h,000h,000h ; 159
0170+  D3E3 00 00 00 00 
0171+  D3E7 02 02 0A 16 	.db 002h,002h,00Ah,016h,012h,012h,00Dh,000h ; 160
0171+  D3EB 12 12 0D 00 
0172+  D3EF 06 09 0E 09 	.db 006h,009h,00Eh,009h,00Eh,008h,010h,000h ; 161
0172+  D3F3 0E 08 10 00 
0173+  D3F7 1F 11 11 10 	.db 01Fh,011h,011h,010h,010h,010h,010h,000h ; 162
0173+  D3FB 10 10 10 00 
0174+  D3FF 0F 10 12 0A 	.db 00Fh,010h,012h,00Ah,00Ah,00Ah,011h,000h ; 163
0174+  D403 0A 0A 11 00 
0175+  D407 1F 08 04 02 	.db 01Fh,008h,004h,002h,004h,008h,01Fh,000h ; 164
0175+  D40B 04 08 1F 00 
0176+  D40F 05 0A 10 1E 	.db 005h,00Ah,010h,01Eh,011h,011h,00Eh,000h ; 165
0176+  D413 11 11 0E 00 
0177+  D417 09 09 09 09 	.db 009h,009h,009h,009h,00Fh,009h,010h,000h ; 166
0177+  D41B 0F 09 10 00 
0178+  D41F 08 14 04 02 	.db 008h,014h,004h,002h,006h,009h,011h,000h ; 167
0178+  D423 06 09 11 00 
0179+  D427 15 15 15 0E 	.db 015h,015h,015h,00Eh,004h,004h,004h,000h ; 168
0179+  D42B 04 04 04 00 
0180+  D42F 0E 11 1B 1F 	.db 00Eh,011h,01Bh,01Fh,01Bh,011h,00Eh,000h ; 169
0180+  D433 1B 11 0E 00 
0181+  D437 0E 11 11 0E 	.db 00Eh,011h,011h,00Eh,004h,015h,01Bh,000h ; 170
0181+  D43B 04 15 1B 00 
0182+  D43F 06 09 09 06 	.db 006h,009h,009h,006h,000h,000h,000h,000h ; 171
0182+  D443 00 00 00 00 
0183+  D447 0E 13 15 19 	.db 00Eh,013h,015h,019h,00Eh,000h,000h,000h ; 172
0183+  D44B 0E 00 00 00 
0184+  D44F 02 06 02 02 	.db 002h,006h,002h,002h,007h,000h,000h,000h ; 173
0184+  D453 07 00 00 00 
0185+  D457 06 09 02 04 	.db 006h,009h,002h,004h,00Fh,000h,000h,000h ; 174
0185+  D45B 0F 00 00 00 
0186+  D45F 0F 01 02 09 	.db 00Fh,001h,002h,009h,006h,000h,000h,000h ; 175
0186+  D463 06 00 00 00 
0187+  D467 0A 0A 0F 02 	.db 00Ah,00Ah,00Fh,002h,002h,000h,000h,000h ; 176
0187+  D46B 02 00 00 00 
0188+  D46F 0E 08 0E 01 	.db 00Eh,008h,00Eh,001h,00Eh,000h,000h,000h ; 177
0188+  D473 0E 00 00 00 
0189+  D477 06 08 0E 09 	.db 006h,008h,00Eh,009h,006h,000h,000h,000h ; 178
0189+  D47B 06 00 00 00 
0190+  D47F 0F 01 02 04 	.db 00Fh,001h,002h,004h,004h,000h,000h,000h ; 179
0190+  D483 04 00 00 00 
0191+  D487 06 09 06 09 	.db 006h,009h,006h,009h,006h,000h,000h,000h ; 180
0191+  D48B 06 00 00 00 
0192+  D48F 06 09 07 01 	.db 006h,009h,007h,001h,006h,000h,000h,000h ; 181
0192+  D493 06 00 00 00 
0193+  D497 00 00 0E 13 	.db 000h,000h,00Eh,013h,015h,019h,00Eh,000h ; 182
0193+  D49B 15 19 0E 00 
0194+  D49F 00 00 02 06 	.db 000h,000h,002h,006h,002h,002h,007h,000h ; 183
0194+  D4A3 02 02 07 00 
0195+  D4A7 00 00 06 09 	.db 000h,000h,006h,009h,002h,004h,00Fh,000h ; 184
0195+  D4AB 02 04 0F 00 
0196+  D4AF 00 00 0F 01 	.db 000h,000h,00Fh,001h,002h,009h,006h,000h ; 185
0196+  D4B3 02 09 06 00 
0197+  D4B7 00 00 0A 0A 	.db 000h,000h,00Ah,00Ah,00Fh,002h,002h,000h ; 186
0197+  D4BB 0F 02 02 00 
0198+  D4BF 00 00 0E 08 	.db 000h,000h,00Eh,008h,00Eh,001h,00Eh,000h ; 187
0198+  D4C3 0E 01 0E 00 
0199+  D4C7 00 00 06 08 	.db 000h,000h,006h,008h,00Eh,009h,006h,000h ; 188
0199+  D4CB 0E 09 06 00 
0200+  D4CF 00 00 0F 01 	.db 000h,000h,00Fh,001h,002h,004h,004h,000h ; 189
0200+  D4D3 02 04 04 00 
0201+  D4D7 00 00 06 09 	.db 000h,000h,006h,009h,006h,009h,006h,000h ; 190
0201+  D4DB 06 09 06 00 
0202+  D4DF 00 00 06 09 	.db 000h,000h,006h,009h,007h,001h,006h,000h ; 191
0202+  D4E3 07 01 06 00 
0203+  D4E7 00 00 12 15 	.db 000h,000h,012h,015h,01Dh,015h,012h,000h ; 192
0203+  D4EB 1D 15 12 00 
0204+  D4EF 00 00 0C 02 	.db 000h,000h,00Ch,002h,00Eh,012h,00Dh,000h ; 193
0204+  D4F3 0E 12 0D 00 
0205+  D4F7 01 0E 10 1E 	.db 001h,00Eh,010h,01Eh,011h,011h,00Eh,000h ; 194
0205+  D4FB 11 11 0E 00 
0206+  D4FF 00 00 12 12 	.db 000h,000h,012h,012h,012h,012h,00Fh,001h ; 195
0206+  D503 12 12 0F 01 
0207+  D507 0E 01 01 0F 	.db 00Eh,001h,001h,00Fh,011h,011h,00Eh,000h ; 196
0207+  D50B 11 11 0E 00 
0208+  D50F 00 00 0E 11 	.db 000h,000h,00Eh,011h,01Fh,010h,00Eh,000h ; 197
0208+  D513 1F 10 0E 00 
0209+  D517 00 00 0E 15 	.db 000h,000h,00Eh,015h,015h,00Eh,004h,004h ; 198
0209+  D51B 15 0E 04 04 
0210+  D51F 00 00 0C 12 	.db 000h,000h,00Ch,012h,004h,009h,006h,000h ; 199
0210+  D523 04 09 06 00 
0211+  D527 00 00 11 0A 	.db 000h,000h,011h,00Ah,004h,00Ah,011h,000h ; 200
0211+  D52B 04 0A 11 00 
0212+  D52F 00 00 12 12 	.db 000h,000h,012h,012h,012h,012h,00Dh,000h ; 201
0212+  D533 12 12 0D 00 
0213+  D537 0C 00 12 12 	.db 00Ch,000h,012h,012h,012h,012h,00Dh,000h ; 202
0213+  D53B 12 12 0D 00 
0214+  D53F 00 00 11 12 	.db 000h,000h,011h,012h,01Ch,012h,011h,000h ; 203
0214+  D543 1C 12 11 00 
0215+  D547 00 00 07 09 	.db 000h,000h,007h,009h,009h,009h,011h,000h ; 204
0215+  D54B 09 09 11 00 
0216+  D54F 00 00 11 1B 	.db 000h,000h,011h,01Bh,015h,011h,011h,000h ; 205
0216+  D553 15 11 11 00 
0217+  D557 00 00 11 11 	.db 000h,000h,011h,011h,01Fh,011h,011h,000h ; 206
0217+  D55B 1F 11 11 00 
0218+  D55F 00 00 0E 11 	.db 000h,000h,00Eh,011h,011h,011h,00Eh,000h ; 207
0218+  D563 11 11 0E 00 
0219+  D567 00 00 1F 11 	.db 000h,000h,01Fh,011h,011h,011h,011h,000h ; 208
0219+  D56B 11 11 11 00 
0220+  D56F 00 00 0F 11 	.db 000h,000h,00Fh,011h,00Fh,009h,011h,000h ; 209
0220+  D573 0F 09 11 00 
0221+  D577 00 00 1E 11 	.db 000h,000h,01Eh,011h,011h,01Eh,010h,000h ; 210
0221+  D57B 11 1E 10 00 
0222+  D57F 00 00 0E 11 	.db 000h,000h,00Eh,011h,010h,011h,00Eh,000h ; 211
0222+  D583 10 11 0E 00 
0223+  D587 00 00 1F 04 	.db 000h,000h,01Fh,004h,004h,004h,004h,000h ; 212
0223+  D58B 04 04 04 00 
0224+  D58F 00 00 11 11 	.db 000h,000h,011h,011h,00Fh,001h,001h,00Eh ; 213
0224+  D593 0F 01 01 0E 
0225+  D597 00 00 15 15 	.db 000h,000h,015h,015h,00Eh,015h,015h,000h ; 214
0225+  D59B 0E 15 15 00 
0226+  D59F 0C 14 18 1E 	.db 00Ch,014h,018h,01Eh,011h,011h,00Eh,000h ; 215
0226+  D5A3 11 11 0E 00 
0227+  D5A7 00 00 10 10 	.db 000h,000h,010h,010h,01Eh,011h,01Eh,000h ; 216
0227+  D5AB 1E 11 1E 00 
0228+  D5AF 00 00 11 11 	.db 000h,000h,011h,011h,01Dh,013h,01Dh,000h ; 217
0228+  D5B3 1D 13 1D 00 
0229+  D5B7 00 00 0E 11 	.db 000h,000h,00Eh,011h,006h,011h,00Eh,000h ; 218
0229+  D5BB 06 11 0E 00 
0230+  D5BF 00 00 11 15 	.db 000h,000h,011h,015h,015h,015h,01Fh,000h ; 219
0230+  D5C3 15 15 1F 00 
0231+  D5C7 00 00 1E 01 	.db 000h,000h,01Eh,001h,007h,001h,01Eh,000h ; 220
0231+  D5CB 07 01 1E 00 
0232+  D5CF 00 00 15 15 	.db 000h,000h,015h,015h,015h,015h,01Fh,001h ; 221
0232+  D5D3 15 15 1F 01 
0233+  D5D7 00 00 11 11 	.db 000h,000h,011h,011h,00Fh,001h,001h,000h ; 222
0233+  D5DB 0F 01 01 00 
0234+  D5DF 00 00 18 08 	.db 000h,000h,018h,008h,00Eh,009h,00Eh,000h ; 223
0234+  D5E3 0E 09 0E 00 
0235+  D5E7 12 15 15 1D 	.db 012h,015h,015h,01Dh,015h,015h,012h,000h ; 224
0235+  D5EB 15 15 12 00 
0236+  D5EF 0E 11 11 11 	.db 00Eh,011h,011h,011h,01Fh,011h,011h,000h ; 225
0236+  D5F3 1F 11 11 00 
0237+  D5F7 1F 10 10 1E 	.db 01Fh,010h,010h,01Eh,011h,011h,01Eh,000h ; 226
0237+  D5FB 11 11 1E 00 
0238+  D5FF 12 12 12 12 	.db 012h,012h,012h,012h,012h,012h,01Fh,001h ; 227
0238+  D603 12 12 1F 01 
0239+  D607 06 0A 0A 0A 	.db 006h,00Ah,00Ah,00Ah,00Ah,01Fh,011h,000h ; 228
0239+  D60B 0A 1F 11 00 
0240+  D60F 1F 10 10 1E 	.db 01Fh,010h,010h,01Eh,010h,010h,01Fh,000h ; 229
0240+  D613 10 10 1F 00 
0241+  D617 04 1F 15 15 	.db 004h,01Fh,015h,015h,01Fh,004h,004h,000h ; 230
0241+  D61B 1F 04 04 00 
0242+  D61F 1F 11 10 10 	.db 01Fh,011h,010h,010h,010h,010h,010h,000h ; 231
0242+  D623 10 10 10 00 
0243+  D627 11 11 0A 04 	.db 011h,011h,00Ah,004h,00Ah,011h,011h,000h ; 232
0243+  D62B 0A 11 11 00 
0244+  D62F 11 11 13 15 	.db 011h,011h,013h,015h,019h,011h,011h,000h ; 233
0244+  D633 19 11 11 00 
0245+  D637 15 11 13 15 	.db 015h,011h,013h,015h,019h,011h,011h,000h ; 234
0245+  D63B 19 11 11 00 
0246+  D63F 11 12 14 18 	.db 011h,012h,014h,018h,014h,012h,011h,000h ; 235
0246+  D643 14 12 11 00 
0247+  D647 07 09 09 09 	.db 007h,009h,009h,009h,009h,009h,019h,000h ; 236
0247+  D64B 09 09 19 00 
0248+  D64F 11 1B 15 15 	.db 011h,01Bh,015h,015h,011h,011h,011h,000h ; 237
0248+  D653 11 11 11 00 
0249+  D657 11 11 11 1F 	.db 011h,011h,011h,01Fh,011h,011h,011h,000h ; 238
0249+  D65B 11 11 11 00 
0250+  D65F 0E 11 11 11 	.db 00Eh,011h,011h,011h,011h,011h,00Eh,000h ; 239
0250+  D663 11 11 0E 00 
0251+  D667 1F 11 11 11 	.db 01Fh,011h,011h,011h,011h,011h,011h,000h ; 240
0251+  D66B 11 11 11 00 
0252+  D66F 0F 11 11 0F 	.db 00Fh,011h,011h,00Fh,005h,009h,011h,000h ; 241
0252+  D673 05 09 11 00 
0253+  D677 1E 11 11 1E 	.db 01Eh,011h,011h,01Eh,010h,010h,010h,000h ; 242
0253+  D67B 10 10 10 00 
0254+  D67F 0E 11 10 10 	.db 00Eh,011h,010h,010h,010h,011h,00Eh,000h ; 243
0254+  D683 10 11 0E 00 
0255+  D687 1F 04 04 04 	.db 01Fh,004h,004h,004h,004h,004h,004h,000h ; 244
0255+  D68B 04 04 04 00 
0256+  D68F 11 11 11 0A 	.db 011h,011h,011h,00Ah,004h,008h,010h,000h ; 245
0256+  D693 04 08 10 00 
0257+  D697 11 15 15 0E 	.db 011h,015h,015h,00Eh,015h,015h,011h,000h ; 246
0257+  D69B 15 15 11 00 
0258+  D69F 1E 11 11 1E 	.db 01Eh,011h,011h,01Eh,011h,011h,01Eh,000h ; 247
0258+  D6A3 11 11 1E 00 
0259+  D6A7 10 10 10 1E 	.db 010h,010h,010h,01Eh,011h,011h,01Eh,000h ; 248
0259+  D6AB 11 11 1E 00 
0260+  D6AF 11 11 11 19 	.db 011h,011h,011h,019h,015h,015h,019h,000h ; 249
0260+  D6B3 15 15 19 00 
0261+  D6B7 0E 11 01 06 	.db 00Eh,011h,001h,006h,001h,011h,00Eh,000h ; 250
0261+  D6BB 01 11 0E 00 
0262+  D6BF 11 15 15 15 	.db 011h,015h,015h,015h,015h,015h,01Fh,000h ; 251
0262+  D6C3 15 15 1F 00 
0263+  D6C7 0E 11 01 07 	.db 00Eh,011h,001h,007h,001h,011h,00Eh,000h ; 252
0263+  D6CB 01 11 0E 00 
0264+  D6CF 15 15 15 15 	.db 015h,015h,015h,015h,015h,015h,01Fh,001h ; 253
0264+  D6D3 15 15 1F 01 
0265+  D6D7 11 11 11 0F 	.db 011h,011h,011h,00Fh,001h,001h,001h,000h ; 254
0265+  D6DB 01 01 01 00 
0266+  D6DF 00 00 00 00 	.db 000h,000h,000h,000h,000h,000h,000h,01Fh ; 255
0266+  D6E3 00 00 00 1F 
0267+  D6E7             fontEnd:0257   D6E7~            #else
0258   D6E7~            notused:	.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0259   D6E7~            		.db 0FFh, 0FFh,	0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0260   D6E7~            		.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0261   D6E7~            		.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0262   D6E7~            		.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0263   D6E7~            		.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0264   D6E7~            		.db 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh, 0FFh
0265   D6E7             #endif
0266   D6E7             .endtasm: Number of errors = 0
